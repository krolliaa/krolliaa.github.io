<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>RabbitMQ Study [未完结] | Krolliaa</title><meta name="keywords" content="微服务,消息队列"><meta name="author" content="Krolliaa"><meta name="copyright" content="Krolliaa"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="消息中间件是什么？消息队列就是消息中间件，消息很好理解你可以理解为信息，那中间件呢？中间件是提供软件和软件之间连接的软件，以便于软件各个部件之间的沟通。在咖啡店买咖啡这个例子中，微信就是消息中间件。发送方和接收方就是被消息中间件连接的 为什么要使用消息中间件呢？同步直接调用 —&gt; 异步直接调用 —&gt; 消息中间件 先来理解下什么是同步直接调用？请看下图：   可以看到同步直接调用的整个业">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ Study [未完结]">
<meta property="og:url" content="http://example.com/2022/08/12/RabbitMQStudy/index.html">
<meta property="og:site_name" content="Krolliaa">
<meta property="og:description" content="消息中间件是什么？消息队列就是消息中间件，消息很好理解你可以理解为信息，那中间件呢？中间件是提供软件和软件之间连接的软件，以便于软件各个部件之间的沟通。在咖啡店买咖啡这个例子中，微信就是消息中间件。发送方和接收方就是被消息中间件连接的 为什么要使用消息中间件呢？同步直接调用 —&gt; 异步直接调用 —&gt; 消息中间件 先来理解下什么是同步直接调用？请看下图：   可以看到同步直接调用的整个业">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/index_img/20.jpg">
<meta property="article:published_time" content="2022-08-12T08:45:54.288Z">
<meta property="article:modified_time" content="2022-10-27T14:02:41.384Z">
<meta property="article:author" content="Krolliaa">
<meta property="article:tag" content="微服务">
<meta property="article:tag" content="消息队列">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/index_img/20.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/08/12/RabbitMQStudy/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RabbitMQ Study [未完结]',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-27 22:02:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/header.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 记录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/plan"><i class="fa-fw fas fa-link"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/index_img/20.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Krolliaa</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 记录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/plan"><i class="fa-fw fas fa-link"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">RabbitMQ Study [未完结]</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-12T08:45:54.288Z" title="发表于 2022-08-12 16:45:54">2022-08-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-27T14:02:41.384Z" title="更新于 2022-10-27 22:02:41">2022-10-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/MessageQueue/">MessageQueue</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>39分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="消息中间件是什么？"><a href="#消息中间件是什么？" class="headerlink" title="消息中间件是什么？"></a>消息中间件是什么？</h1><p>消息队列就是消息中间件，消息很好理解你可以理解为信息，那中间件呢？中间件是提供软件和软件之间连接的软件，以便于软件各个部件之间的沟通。<strong>在咖啡店买咖啡这个例子中，微信就是消息中间件。发送方和接收方就是被消息中间件连接的</strong></p>
<h1 id="为什么要使用消息中间件呢？"><a href="#为什么要使用消息中间件呢？" class="headerlink" title="为什么要使用消息中间件呢？"></a>为什么要使用消息中间件呢？</h1><p><strong>同步直接调用 —&gt; 异步直接调用 —&gt; 消息中间件</strong></p>
<p>先来理解下什么是同步直接调用？请看下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/8c2fd1aed0bc4e4ab161b2b73f6f4ac0.png"></p>
<ul>
<li>可以看到同步直接调用的整个业务调用链非常长，这就会让用户等待的<strong>时间</strong>也变得很<strong>长</strong>。</li>
<li>而且<strong>中途</strong>只要有一个环节出现了<strong>故障</strong>就会导致<strong>整个业务瘫痪</strong>掉。这跟初中学习的串联没什么太大区别。</li>
<li>并且如果<strong>业务处于高峰期</strong>，此时某一个业务的处理能力比较<strong>拉跨</strong>的话就会导致<strong>整个系统都很拉跨</strong>。</li>
</ul>
<p>为了解决同步直接调用的这些处理时间长、局部故障导致全局故障，业务高峰期业务能力弱导致整个系统都弱的问题，就得到了<strong>异步直接调用</strong>的解决方案。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/a45dfa601fb34ceeb9a0fd6f795dbf16.png"></p>
<p>可以看到异步直接调用只要用户做了操作，就立马响应转换为“处理中”这么一种效果，新建一个异步线程，然后再去处理调用各个组件。异步直接调用解决了：</p>
<ol>
<li>业务调用链虽然还是挺长，但是解决了用户等待时间长的问题</li>
<li>部分组件故障会导致整个业务瘫痪，可能业务调用链里面的组件还是会发生故障，但我用户的操作返回的结果是没问题的</li>
<li>业务高峰期没有缓冲，这个也解决了，因为用户每次操作都会从线程池中拿一个新的异步线程</li>
</ol>
<p><strong><font color="red">但是异步直接调用这样又带来了新的问题：即如果业务高峰期非常非常爆满的话，那么线程池中的异步线程终究是不够用的，就会导致内存爆满。</font></strong></p>
<p>所以就需要一个能够处理高并发的，速度非常快的这么一种东西，它每次有任务一来我就自动快速的去完成这个任务，实现高效率操作。找来找去发现消息中间件是最最合适的。所以我们再将异步直接调用调用改造成了围绕消息中间件打造的这么一种模式：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/a21f573f87ff4c30b28ad8fd74b81cbe.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/32279f40627945efb760a3b81dc4380b.png"></p>
<p>通过这幅图我们就可以感受到消息中间件的妙处了：</p>
<ul>
<li>整个业务调用链很短，都是交给消息中间件去做，用户等待的时间也很短。</li>
<li>某个组件故障不会导致整个业务瘫痪</li>
<li>业务高峰期还有缓冲</li>
<li>业务高峰期时不会产生大量的异步线程【之前在异步直接调用可以发现异步线程非常的长，这种非常长时间的异步线程是很容被<code>KILL</code>掉的所以一定要防止这种长时的异步线程出现，比如非常长的<code>sleep</code>】</li>
</ul>
<h1 id="消息中间件的作用"><a href="#消息中间件的作用" class="headerlink" title="消息中间件的作用"></a>消息中间件的作用</h1><ul>
<li>异步处理</li>
<li>系统解耦</li>
<li>流量削峰和流控</li>
<li>消息广播：一个服务可以发送给多个服务，类似于微信的一人群发</li>
<li>消息收集：日志收集系统</li>
<li>最终一致性：对方什么时候处理是对方的事情但是存在于消息中间的消息一定会被对方处理掉【即时间问题但是一定可以处理】</li>
</ul>
<p>总结：<strong>消息中间件就是软件和软件之间发送消息的软件</strong>，消息中间件最大的作用就是<strong>异步消息</strong>、<strong>系统解耦</strong>，此外还有<strong>流量削峰</strong>、<strong>流量控制</strong>、<strong>消息收集</strong>、<strong>消息广播</strong>等特点。</p>
<h1 id="RabbitMQ高性能的原因"><a href="#RabbitMQ高性能的原因" class="headerlink" title="RabbitMQ高性能的原因"></a><code>RabbitMQ</code>高性能的原因</h1><ul>
<li>感受下安卓和苹果的速度，<code>RabbitMQ</code>是<code>erlang</code>语言开发的，一门专门为<strong>交换机软件开发诞生的编程语言</strong>。</li>
<li>适用于分布式系统，面向并发的。</li>
<li>而且<code>erlang</code>是虚拟机解释运行的可以跨平台部署</li>
<li><code>erlang</code>的进程间上下文切换效率远高于<code>C</code>语言</li>
<li>并且有着和<code>Socket</code>原生一样的延迟。</li>
</ul>
<p><code>RabbitMQ</code>饿了么美团中国银行工商银行这些互联网、金融行业有着广泛的应用。</p>
<h1 id="RabbitMQ的底层原理-—-AMQP协议"><a href="#RabbitMQ的底层原理-—-AMQP协议" class="headerlink" title="RabbitMQ的底层原理 — AMQP协议"></a><code>RabbitMQ</code>的底层原理 — <code>AMQP</code>协议</h1><ul>
<li>协议就是规范，而<code>AMQP</code>协议就是<code>RabbitMQ</code>的规范，规定了<code>RabbitMQ</code>的对外接口。</li>
<li>学习<code>RabbitMQ</code>本质就是学习<code>AMQP</code>协议。</li>
</ul>
<p>生产者生产消息然后贴上<code>Routing Key</code>路由键，这个路由键就相当于快递的收件地址<code>Queue</code>。这个快递到快递分拨中心的路程我们称其为<code>Connection</code>连接。因为去往快递分拨中心肯定不止一个快递，也许有好多好多个快递正在赶往快递分拨中心，这一条条到快递分拨中心的我们称其为<code>Channel</code>叫做一条条信道。然后快递就到快递分拨中心这里，快递分拨中心在消息中间件里头叫做<code>exchange</code>就是交换机的意思，到了快递分拨中心以后，快递分拨中心要将快递分拨中心跟收件地址进行绑定不然快递员不知道从哪里拿快递，然后快递员就可以快递到收件地址<code>Queue</code>可以是蜂巢，也可以是菜鸟驿站，然后消费者就可以从菜鸟驿站中取出快递拿来消费了。消费者拿快递的通道跟生产者的一样，去往队列的路有好多条，而且此时肯定同时也有好多消费者正在前往拿快递的路上，所以就会有多个信道，这些信道放到一块就组成了连接。【连接其实就是<code>TCP</code>连接】</p>
<p>整个快递系统起主导作用的就是消息中间件，这里称呼为<code>Message Broker</code>用于接收和分发快递。因为一个<code>Broker</code>快递系统忙不过来，所以这个大大的<code>Message Broker</code>就创建了好多<code>Virtual Host</code>，就是虚拟<code>Broker</code>，将多个单元隔开。</p>
<ul>
<li>整个快递系统最核心的组件就是：快递分拨中心 —&gt; <code>Exchange</code>交换机 —&gt; 它承担了非常重要的功能即<code>RabbitMQ</code>的核心功能 —&gt; <strong>路由转发</strong></li>
</ul>
<h2 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h2><p>使用<code>draw.io</code>绘制<code>AMQP</code>协议结构图。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/9f0e5d464ed5452a89cf95226dd8ad50.png"></p>
<h1 id="RabbitMQ的心脏"><a href="#RabbitMQ的心脏" class="headerlink" title="RabbitMQ的心脏"></a><code>RabbitMQ</code>的心脏</h1><p><code>RabbitMQ</code>的整个核心就是<code>Exchange</code>交换机。</p>
<ul>
<li><p><code>Exchange</code>是<code>AMQP</code>协议和<code>RabbitMQ</code>的<strong>核心组件</strong>。</p>
</li>
<li><p><code>Exchange</code>的功能是根据<strong>路由键</strong>和<strong>绑定关系</strong>为消息提供路由，将消息转发至相应的队列。</p>
</li>
<li><p><code>Exchange</code>一共有四种类型：<code>Direct Topic Fanout Headers</code>，以前三种为主第四种使用地非常少。</p>
</li>
</ul>
<h2 id="Direct-Exchange【直连模式】"><a href="#Direct-Exchange【直连模式】" class="headerlink" title="Direct Exchange【直连模式】"></a><code>Direct Exchange</code>【直连模式】</h2><ul>
<li><p><code>Message</code>中的路由键<code>Routing Key</code>【快件地址】如果和绑定的菜鸟驿站<code>Binding Key</code>是一致的，那么【快递分拨中心】<code>Exchange</code>直接将<code>Message</code>发送到对应的队列【菜鸟驿站】<code>Queue</code>中。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/13c100680a1f479b85df8138fc797b52.png"></p>
</li>
</ul>
<h2 id="Fanout-Exchange【扇形模式】"><a href="#Fanout-Exchange【扇形模式】" class="headerlink" title="Fanout Exchange【扇形模式】"></a><code>Fanout Exchange</code>【扇形模式】</h2><ul>
<li><p>每个分发到<code>Fanout Exchange</code>的消息<code>Message</code>会将消息分发到所有绑定队列<code>Queue</code>上。也就是说会发送到所有这个交换机快递分拨中心绑定的消息队列上。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/3c5aae51c7b64cb7b6f51ee1ea5a2bbf.png"></p>
</li>
</ul>
<h2 id="Topic-Exchange【主题模式】"><a href="#Topic-Exchange【主题模式】" class="headerlink" title="Topic Exchange【主题模式】"></a><code>Topic Exchange</code>【主题模式】</h2><ul>
<li>根据<code>Routing Key</code>以及通配规则【可以跟<code>Binding Key + #</code>匹配任意单词】，如果没有通配规则则跟直连模式一样，同时还可以跟<code>*</code>匹配一个单词。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong><font color="red">推荐：模拟的<code>RabbitMQ</code>网站 —&gt; <code>http://tryrabbitmq.com/</code></font></strong></p>
<ul>
<li><code>AMQP</code>协议直接决定了<code>RabbitMQ</code>的内部结构和外部行为</li>
<li>对于发送者来说，它只关系自己的消息有没有发送到特定的【快递分拨中心】交换机<code>Exchange</code>中</li>
<li>消息通过<code>Exchange</code>路由后，到达具体的消息队列</li>
<li>消费者将消息从监听的队列中取走</li>
</ul>
<p>站在<code>Exchange</code>交换机这个快递分拨中心的角度上来，我只关心要发送的快递要发到哪里去，来寄快递的人告诉我这个快递要寄到哪里去，然后我就让指定的快递员按指定快递路线去发就可以了。所以<strong>路由键</strong><code>Routing Key</code>就是告诉快递分拨中心我要发到哪里去，而<strong>绑定关系</strong><code>Binding Key</code>就是快递分拨中心指定的快递线路。【<strong>简而言之交换机<code>Exchange</code>：不关心怎么来，只关心到哪去</strong>】</p>
<p><strong>所以说交换机<code>Exchange</code>的作用就是：<font color="red">根据路由键和绑定关系为消息提供路由，将消息转发到相应的队列中。</font></strong></p>
<h2 id="作业-1"><a href="#作业-1" class="headerlink" title="作业"></a>作业</h2><p>作业：在<code>tryrabbitmq.com</code>网站中，搭建<code>Direct Fanout Topic</code>三种模式的发布订阅模型。</p>
<p>第一种：<code>Direct</code>直连模式 —&gt; 张三和李四购买了咖啡，直连模式会发送到<code>1号丰巢快递柜</code>，张三李四轮询消费。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/bbbbb550e8c84ceb9bb2ee3bdfc014d2.png"></p>
<p>第二种：<code>Fanout</code>广播模式 —&gt; 奶茶店老板豪气十足，每个人都送<code>1</code>杯饮料，美团乐坏了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/27e9a634acda43fa93d69c003fe015b6.png"></p>
<p>第三种：<code>Topic</code>主题模式 —&gt;</p>
<ul>
<li>张三无论热的冰的咖啡都可以，糖分无所谓，老板做啥他喝啥，所以张三的绑定关系绑定了个<code>*.coffee</code></li>
<li>李四只喝热咖啡，糖分无所谓，所以李四的绑定关系绑定了个<code>hot.coffee</code></li>
<li>王五只喝冰咖啡，糖分无所谓，所以李四的绑定关系绑定了个<code>cold.coffee</code></li>
</ul>
<p>奶茶店老板不定时送咖啡，可以看到当老板送热咖啡的时候，张三和李四可以收到，当送冰咖啡的时候张三和王五可以收到，看来不挑食可以得到的更多哈哈</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/b62fac4d47f14594831f9f3c55d14090.png"></p>
<p>某天李四想减肥了，所以不想喝甜的咖啡了，于是李四喝咖啡的标准就是：<code>hot.unsweet.coffee</code>。</p>
<p>王五这个人呢就很喜欢吃甜食她也不介意，但是她还是想喝冰的，于是她喝咖啡的标准就成了：<code>cold.sweet.coffee</code></p>
<p>张三这个人还是一贯的不挑食不介意，冰的热的还是甜的她都可以，她就喜欢喝咖啡，没别的要求哈哈</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/b3ef7e8a0e894b9ea81d4e66f1e8615e.png"></p>
<p>这里张三<code>#.coffee</code>，这里的<code>#</code>只有在主题模式才有，表示匹配任意多个单词。</p>
<ul>
<li>当有冷的甜的咖啡的时候张三跟王五可以收到。</li>
<li>当有热的苦的咖啡的时候张三跟李四可以收到。</li>
</ul>
<h1 id="RabbitMQ快速安装"><a href="#RabbitMQ快速安装" class="headerlink" title="RabbitMQ快速安装"></a><code>RabbitMQ</code>快速安装</h1><p><code>Windows</code>：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/which-erlang.html">RabbitMQ Erlang Version Requirements — RabbitMQ</a>查找版本映射关系</li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/">Index - Erlang&#x2F;OTP</a>下载安装<code>Erlang</code></li>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/install-windows.html">Installing on Windows — RabbitMQ</a>下载安装<code>RabbitMQ</code></li>
</ul>
<p>配置环境变量，然后直接在<code>cmd</code>中输入<code>rabbitmq-server</code>即可 —&gt; 这里的版本是<code>3.10.7</code>如果是老一点的版本，可能需要启动插件才可以在网页版中查看<code>RabbitMQ</code>消息队列。 —&gt; <code>http://localhost:15672</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins --help</span><br><span class="line">rabbitmq-plugins list </span><br><span class="line">rabbitmq-plugins rabbitmq_management</span><br></pre></td></tr></table></figure>

<p>该网页有六大模块：<strong>概览、连接、信道、交换机、队列、管理</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/7f69607850f14ac08da133260c3cbb28.png"></p>
<p>在<code>RabbitMQ</code>里头给予了一个默认的交换机即：<code>AMQP default</code>，它本质也是直连模式但是简化了直连模式的<code>Binding Key</code>，它默认<code>Binding Key</code>就是队列名。所以在这个直连模式下，你要实现发布订阅，你的路由键直接跟队列名同名即可。</p>
<h2 id="作业-2"><a href="#作业-2" class="headerlink" title="作业"></a>作业</h2><p>使用<code>RabbitMQ</code>管控台配置：直连模式、广播模式、主题模式</p>
<ul>
<li><p>我们创建三种类型的交换机，交换机是负责给通过路由键和绑定关系给消息提供路由的，分别为：美团直连模式、美团广播模式、美团话题模式。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/380795f57fc84014ab8fd77642641330.png"></p>
</li>
<li><p>然后创建三个队列，队列存储的是消息内容，等待消费者的消费，分别为：1号丰巢快递柜、2号丰巢快递柜、3号丰巢快递柜。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/3792179435f94af2bd6a52af5a81e2da.png"></p>
</li>
</ul>
<ol>
<li><p>测试直连模式：</p>
<p>针对三个队列绑定关系为：<code>hot.coffee *.coffee cold.coffee</code></p>
<p>发送消息的路由键为：<code>hot.coffee cold.coffee</code>，发送，观察队列情况：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/3792179435f94af2bd6a52af5a81e2da.png"></p>
<p>可以看到在直连模式下，消息发送到哪个队列，路由键跟绑定关系是绝对紧密相连的。</p>
</li>
<li><p>测试广播模式：</p>
<p>针对三个队列绑定关系为：<code>hot.coffee *.coffee cold.coffee</code></p>
<p>只发送1个消息，路由键为：<code>hot.coffee</code>，发送，观察队列情况：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/84e58285faff41ab803dc36ad1bf9302.png"></p>
<p>可以看到虽然只发送了一个消息而且路由键为<code>hot.coffee</code>而只有1号丰巢快递柜的绑定关系跟这个路由键相匹配，但是所有队列都收到了这个消息，这就是广播模式的发布订阅模型。</p>
</li>
<li><p>测试话题模式：</p>
<p>针对三个队列绑定关系为：<code>hot.coffee *.coffee cold.coffee</code></p>
<p>只发送1个消息，路由键为：<code>hot.coffee</code>，发送，观察队列情况：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/2418516c68c04f088c1efe7e91c069d7.png"></p>
<p>可以看到1号跟2号收到了，但是3号没有收到，奇怪，2号的绑定关系不是<code>*.coffee</code>吗？这就是话题模式的精髓所在，它可以通过通配符的方式匹配上路由从而使队列接收到消息。</p>
</li>
</ol>
<h1 id="RabbitMQ命令行工具"><a href="#RabbitMQ命令行工具" class="headerlink" title="RabbitMQ命令行工具"></a><code>RabbitMQ</code>命令行工具</h1><ul>
<li>想看什么就<code>List</code>什么</li>
<li>想清空什么就<code>Purge</code>什么</li>
<li>想删除什么就<code>Delete</code>什么</li>
<li>一切问题记得使用<code>--help</code></li>
</ul>
<p>查看相关：	</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">查看状态：rabbitmqctl status</span><br><span class="line">查看连接：rabbitmqctl list_connections</span><br><span class="line">查看信道：rabbitmqctl list_channels</span><br><span class="line">查看交换机：rabbitmqctl list_exchanges</span><br><span class="line">查看绑定：rabbitmqctl list_bindings</span><br><span class="line">查看队列：rabbitmqctl list_queues</span><br><span class="line">查看消费者：rabbitmqctl list_consumers</span><br></pre></td></tr></table></figure>

<p>队列相关：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查看队列：rabbitmqctl list_queues</span><br><span class="line">删除队列：rabbitmqctl delete_queue</span><br><span class="line">清空队列：rabbitmqctl purge_queue</span><br></pre></td></tr></table></figure>

<p>用户相关：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">新建用户：rabbitmqctl add_user</span><br><span class="line">修改用户密码：rabbitmqctl change_password</span><br><span class="line">删除用户：rabbitmqctl delete_user</span><br><span class="line">查看用户：rabbitmqctl list_users</span><br><span class="line">设置用户角色：rabbitmqctl set_user_tags</span><br></pre></td></tr></table></figure>

<p>应用相关：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">启动应用：rabbitmqctl start_app</span><br><span class="line">关闭应用保留（暂停）Erlang虚拟机：rabbitmqctl stop_app</span><br><span class="line">关闭应用并关闭Erlang虚拟机：rabbitmqctl stop</span><br></pre></td></tr></table></figure>

<p>集群相关：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">加入集群：rabbitmqctl join_cluster</span><br><span class="line">离开集群：rabbitmqctl reset</span><br></pre></td></tr></table></figure>

<p>镜像队列相关：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">设置镜像队列：rabbitmqctl sync_queue</span><br><span class="line">取消镜像队列：rabbitmqctl cancel_sync_queue</span><br></pre></td></tr></table></figure>

<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><ul>
<li><p><code>RabbitMQ</code>高性能的原因：</p>
<ol>
<li><p>从内看：<code>Erlang</code>进程间上下文切换的效率远高于<code>C Java</code>，使得<code>RabbitMQ</code>的并发能力非常强悍</p>
</li>
<li><p>从外看：网络性能有着跟原生<code>Socket</code>一样的延迟，使得<code>RabbitMQ</code>网络<code>IO</code>性能极高</p>
</li>
</ol>
</li>
<li><p><code>RabbitMQ</code>的底层协议<code>AMQP</code>协议</p>
</li>
<li><p><code>RabbitMQ</code>的核心<code>Exchange</code></p>
</li>
</ul>
<h1 id="RabbitMQ消息交换的关键是什么？"><a href="#RabbitMQ消息交换的关键是什么？" class="headerlink" title="RabbitMQ消息交换的关键是什么？"></a><code>RabbitMQ</code>消息交换的关键是什么？</h1><p><strong>使用<code>RabbitMQ</code>本质上就是在使用<code>AMQP</code>协议</strong>，<code>AMQP</code>协议定义了<code>RabbitMQ</code>的内部结构和外部行为。</p>
<p><strong>在<code>RabbitMQ</code>中其消息转换流程如下：</strong></p>
<ul>
<li>发送者不能将消息直接发送到队列中，而需要发送给交换机</li>
<li>交换机通过路由键和绑定关系给消息提供路由，将消息转发到指定队列</li>
<li>消费者从队列中取走消息</li>
</ul>
<p><strong>合理的交换机和队列设置：</strong></p>
<ul>
<li>交换机的数量不能过多，一般来说同一个业务，或者同一类业务使用同一个交换机。</li>
<li>合理设置队列数量，一般来说一个微服务监听一个队列或者一个微服务的一个业务监听一个队列。</li>
<li>合理配置交换机类型，是同<code>Topic</code>模式的时候仔细设置绑定关系<code>Binding Key</code>以及路由键<code>Routing Key</code></li>
</ul>
<p><strong>尽量使用自动化配置：</strong></p>
<ul>
<li>将创建交换机、队列的操作固化在应用代码中，这样就可以更高效且不易出错免去了复杂的运维操作</li>
<li>一般来说，交换机由双方同时声明，队列由接收方声明并配置绑定关系</li>
<li>交换机&#x2F;队列的参数一定要由双方开发团队确认，否则重复声明时若参数不一致会导致生命失败</li>
</ul>
<p>所以关键就是：<strong>根据<code>AMQP</code>协议合理配置交换机和队列并且尽可能的时自动化部署交换机和队列。</strong></p>
<p>包括：交换机类型、交换机数量、队列数量、双方同时声明交换机跟队列</p>
<h2 id="作业-3"><a href="#作业-3" class="headerlink" title="作业"></a>作业</h2><p><strong>为什么<code>AMQP</code>要设计出<code>Exchange</code>消息流转机制呢？</strong></p>
<p>我是这样想的：</p>
<ol>
<li>设计出交换机消息流转机制，生产者跟消费者就不用关心转发的事情了，生产者只负责消费，消费者只负责消费，而有关消息转发的事情就交给<code>Exchange</code>来做，这样做可以很大程度上使<strong>系统解耦</strong>。</li>
<li>同时生产者生产完毕之后就可以不管消费者有没有去消费了，那么生产者的任务就完成了，它就可以继续干他的事情了，这就产生了<strong>异步消息处理</strong>的好处。大大省去了等待时间。</li>
<li>然后就是关于生产者生产的消息要到哪个地方【这里叫做队列】去被哪个消费者所消费，如果没有<code>Exchange</code>交换机去流转消息，那这些工作总得有人去做的，此时当然就是生产者来做了，这样肯定就会降低生产者的效率，而有了交换机可以去做流转，还可以做到<strong>消息广播</strong>跟<strong>消息收集</strong>，将消息分配到符合规则条件的队列中，并且还能做一些记录日志的工作。</li>
<li>最后就是关于流量的问题了，生产者一直负责生产，消费者一直负责消费，假设一下现在突然有了非常非常哒的流量，那么势必生产者会在一瞬间生产大量的消息，此时消费者的消费能力可能是挡不住的，作为生产者和消费者的中间着<code>Exchange</code>此时就可以发挥巨大的作用了。它可以针对这巨大的流量做<strong>流量削峰</strong>跟<strong>流量控制</strong>。</li>
</ol>
<p>所以我猜<code>AMQP</code>正是综合以上种种优点才设计出了<code>Exchange</code>消息流转机制，它有用：**<font color="red">系统解耦、异步处理、流量削峰、流量控制、消息广播、消息收集</font>**等等好处。</p>
<h2 id="14-MessageQueue"><a href="#14-MessageQueue" class="headerlink" title="14. MessageQueue"></a>14. <code>MessageQueue</code></h2><h3 id="14-1-同步通讯和异步通讯"><a href="#14-1-同步通讯和异步通讯" class="headerlink" title="14.1 同步通讯和异步通讯"></a>14.1 同步通讯和异步通讯</h3><ul>
<li><p>同步通讯：就像打电话，需要实时响应。</p>
</li>
<li><p>异步通讯：就像发邮件，不需要马上回复。</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904133345.png" alt="img"></p>
<p>两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。</p>
<p>之前学习的<code>Feign</code>调用就属于同步方式，虽然调用可以实时得到结果，但是存在以下问题：<strong>耦合度高、性能下降、资源浪费、级联失败</strong>。<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904133517.png" alt="img"></p>
<p><strong>同步调用的优点</strong>：时效性较强，可以实时得到结果。</p>
<p><strong>同步调用的缺点</strong>：业务代码<strong>耦合度高</strong>、一旦某个业务出现错误则整个系统都出现错误【<strong>级联失败</strong>】，需要等待调用业务完成才可以完成业务等待时间长【<strong>性能下降</strong>】，等待的时间业务仍然占用着<code>CPU</code>资源这就肯定会造成【<strong>资源浪费</strong>】。同步调用的缺点即有：<strong>耦合度高、性能下降、资源浪费、级联失败</strong>。</p>
<p><strong><font color="deepskyblue">所以为了解决同步调用：耦合度高、级联失败、性能下降、资源浪费的问题，异步调用方案就出现了。</font></strong></p>
<p>以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。在事件模式中，支付服务是事件发布者<code>publisher</code>，在支付完成之后只需要发布一个支付成功的事件<code>event</code>，事件中带上订单<code>id</code>。订单服务和物流服务是事件订阅者<code>Consumer</code>，订阅支付成功的事件，监听到事件后完成自己的业务即可。最开始是当发布者发布消息的时候，直接从线程池中拿线程来用，但是如果流量爆满，线程池中的线程总有不够用的一天，这会导致内存爆满。</p>
<p>这就是异步调用，于是为了解决异步调用线程池数量问题，就引出了**<font color="red">消息队列</font>**。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904145001.png" alt="img"></p>
<p>就是说为了解决发布者和订阅者之间的耦合度以及异步处理。中间搞了一个<code>Broker</code>，这就大大降低了系统耦合度。除了拥有<strong>系统解耦</strong>、<strong>异步处理</strong>，除此之外，<code>Broker</code>即<code>MQ</code>它还可以对过往流量进行监控，并且适当的削峰，即<strong>流量削峰</strong>、<strong>流量监控</strong>，并且对来去的消息进行<strong>消息收集</strong>和<strong>消息广播</strong>，而且还满足<strong>最终一致性</strong>即不管发布者发来什么，要消费的订阅者都会从消息队列中取数据，生产者无需管也无需担心自己发的消息没有被消费的问题。</p>
<p>总结下就是：<strong>异步处理、系统解耦、流量削峰、流量监控、消息广播、消息收集、最终一致性</strong>。</p>
<p><strong>但很明显，这样的架构变复杂了，而且你的消息队列必须做得非常安全可靠，并且支持高并发高可用。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904144714.png" alt="img"></p>
<p><strong>大多数时候，我们并不需要多线程异步处理的需求，而是追求时效性，所以大多数还是使用的是同步通讯。</strong></p>
<h3 id="14-2-消息队列"><a href="#14-2-消息队列" class="headerlink" title="14.2 消息队列"></a>14.2 消息队列</h3><p>比较常见的<code>MQ</code>实现：<code>ActiveMQ</code>、<code>RabbitMQ</code>、<code>RocketMQ</code>、<code>Kafka</code>。若是有海量数据不太关心数据安全性的果断选择<code>Kafka</code>。若需要自己做定制可以使用<code>RokcetMQ</code>大多数时候选择<code>RabbitMQ</code>即可。</p>
<table>
<thead>
<tr>
<th align="left"><strong><code>RabbitMQ</code></strong></th>
<th align="left"><strong><code>ActiveMQ</code></strong></th>
<th align="left"><strong><code>RocketMQ</code></strong></th>
<th align="left"><strong><code>Kafka</code></strong></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="left">公司&#x2F;社区</td>
<td align="left"><code>Rabbit</code></td>
<td align="left"><code>Apache</code></td>
<td align="left">阿里</td>
<td><code>Apache</code></td>
</tr>
<tr>
<td align="left">开发语言</td>
<td align="left"><code>Erlang</code></td>
<td align="left"><code>Java</code></td>
<td align="left"><code>Java</code></td>
<td><code>Scala&amp;Java</code></td>
</tr>
<tr>
<td align="left">协议支持</td>
<td align="left"><code>AMQP、XMPP、SMTP、STOMP</code></td>
<td align="left"><code>OpenWire、STOMP、REST、XMPP、AMQP</code></td>
<td align="left">自定义协议</td>
<td>自定义协议</td>
</tr>
<tr>
<td align="left">可用性</td>
<td align="left">高</td>
<td align="left">一般</td>
<td align="left">高</td>
<td>高</td>
</tr>
<tr>
<td align="left">单机吞吐量</td>
<td align="left">一般</td>
<td align="left">差</td>
<td align="left">高</td>
<td>非常高</td>
</tr>
<tr>
<td align="left">消息延迟</td>
<td align="left">微秒级</td>
<td align="left">毫秒级</td>
<td align="left">毫秒级</td>
<td>毫秒以内</td>
</tr>
<tr>
<td align="left">消息可靠性</td>
<td align="left">高</td>
<td align="left">一般</td>
<td align="left">高</td>
<td>一般</td>
</tr>
</tbody></table>
<p>有没想过为什么<code>RabbitMQ</code>的消息延迟可以做到微秒级？这正是因为<code>RabbitMQ</code>是基于<code>Erlang</code>语言开发的。</p>
<ul>
<li>它是 一款专门为交换机软件开发的语言，而且是分布式的面向并发的。</li>
<li><code>Erlang</code>可以做到进程间上下文切换效率远高于<code>C</code>语言。</li>
<li><code>Erlang</code>还有者跟原生<code>Socket</code>一样的延迟。</li>
<li><code>Erlang</code>是虚拟机解释运行的语言所以可以跨平台部署<code>RabbitMQ</code>。</li>
</ul>
<h3 id="14-3-使用Docker安装RabbitMQ"><a href="#14-3-使用Docker安装RabbitMQ" class="headerlink" title="14.3 使用Docker安装RabbitMQ"></a>14.3 使用<code>Docker</code>安装<code>RabbitMQ</code></h3><ol>
<li><p>拉取<code>RabbitMQ</code>镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rabbitmq:3-management</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行<code>RabbitMQ</code>容器，用户名：<code>admin</code>，密码：<code>123456</code>，容器名：<code>RabbitmqContainer</code>，服务端口<code>5672</code>，<code>web</code>管理端口<code>15672</code>，主机名：<code>mq1</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=123456 --name RabbitMQContainer --hostname rabbitmq -p 15672:15672 -p 5672:5672 -d rabbitmq:3-management</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>VirtualBox</code>配置端口映射<code>15672</code>然后访问地址：<code>http://192.168.56.1:15672</code>即可</p>
</li>
</ol>
<h3 id="14-4-RabbitMQ中的角色及其基本结构"><a href="#14-4-RabbitMQ中的角色及其基本结构" class="headerlink" title="14.4 RabbitMQ中的角色及其基本结构"></a>14.4 <code>RabbitMQ</code>中的角色及其基本结构</h3><ul>
<li><code>publisher</code>：生产者【寄件人】</li>
<li><code>consumer</code>：消费者【收件人】</li>
<li><code>exchange</code>：交换机，负责消息路由【快件分拨中心】</li>
<li><code>queue</code>：队列，存储消息【丰巢快递柜】</li>
<li><code>virtualHost</code>：虚拟主机，<strong>隔离不同租户</strong>的<code>exchange</code>、<code>queue</code>、消息隔离</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904172912.png" alt="img"></p>
<h3 id="14-5-RabbitMQ的底层实现原理：AMQP协议"><a href="#14-5-RabbitMQ的底层实现原理：AMQP协议" class="headerlink" title="14.5 RabbitMQ的底层实现原理：AMQP协议"></a>14.5 <code>RabbitMQ</code>的底层实现原理：<code>AMQP</code>协议</h3><ul>
<li>协议就是规范，而<code>AMQP</code>协议就是<code>RabbitMQ</code>的规范，规定了<code>RabbitMQ</code>的对外接口。</li>
<li>学习<code>RabbitMQ</code>本质就是学习<code>AMQP</code>协议。</li>
</ul>
<blockquote>
<ol>
<li>生产者生产消息然后贴上<code>Routing Key</code>路由键，这个路由键就相当于快递的收件地址<code>Queue</code>。</li>
<li>这个快递到快递分拨中心的路程我们称其为<code>Connection</code>连接。因为去往快递分拨中心肯定不止一个快递，也许有好多好多个快递正在赶往快递分拨中心，这一条条到快递分拨中心的我们称其为<code>Channel</code>叫做一条条信道。</li>
<li>然后快递就到快递分拨中心这里，快递分拨中心在消息中间件里头叫做<code>exchange</code>就是交换机的意思。</li>
<li>到了快递分拨中心以后，快递分拨中心要将快递分拨中心跟收件地址进行绑定不然快递员不知道从哪里拿快递，然后快递员就可以快递到收件地址<code>Queue</code>可以是蜂巢，也可以是菜鸟驿站。</li>
<li>随后消费者就可以从菜鸟驿站中取出快递拿来消费使用了。</li>
<li>消费者拿快递的通道跟生产者的一样，去往队列的路有好多条，而且此时肯定同时也有好多消费者正在前往拿快递的路上，所以就会有多个信道，这些信道放到一块就组成了连接。【连接其实使用的就是<code>TCP</code>连接】</li>
<li>整个快递系统起主导作用的就是消息中间件，这里称呼为<code>Message Broker</code>用于接收和分发快递。</li>
<li>因为一个<code>Broker</code>快递系统忙不过来，所以这个大大的<code>Message Broker</code>就创建了好多<code>Virtual Host</code>，就是虚拟<code>Broker</code>，将多个单元隔开。</li>
</ol>
</blockquote>
<p>整个快递系统最核心的组件就是：快递分拨中心 —&gt; <code>Exchange</code>交换机 —&gt; 它承担了非常重要的功能即<code>RabbitMQ</code>的核心功能 —&gt; <strong>路由转发</strong>：<code>Exchange</code>根据路由键<code>Routing Key</code>和绑定关系<code>Binding Key</code>为消息提供路由，将消息转发至相应队列。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/9f0e5d464ed5452a89cf95226dd8ad50.png"></p>
<h3 id="14-6-RabbitMQ官方模型介绍"><a href="#14-6-RabbitMQ官方模型介绍" class="headerlink" title="14.6 RabbitMQ官方模型介绍"></a>14.6 <code>RabbitMQ</code>官方模型介绍</h3><p><code>RabbitMQ</code>官方提供了<code>5</code>个不同的<code>Demo</code>示例，对应了不同的消息模型。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904173739.png" alt="img"></p>
<h3 id="14-7-RabbitMQ官方API实现HelloWorld模型"><a href="#14-7-RabbitMQ官方API实现HelloWorld模型" class="headerlink" title="14.7 RabbitMQ官方API实现HelloWorld模型"></a>14.7 <code>RabbitMQ</code>官方<code>API</code>实现<code>HelloWorld</code>模型</h3><p>非常非常简单的发布订阅模型，就是发布者将消息发布到队列中然后消费者从队列中取出消息进行消费。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904200637.png" alt="img"></p>
<p>官方的<code>HelloWorld</code>是基于最基础的消息队列模型来实现的，只包括三个角色：</p>
<ul>
<li><code>publisher</code>：消息发布者，将消息发送到队列<code>queue</code></li>
<li><code>queue</code>：消息队列，负责接受并缓存消息</li>
<li><code>consumer</code>：订阅队列，处理队列中的消息</li>
</ul>
<p>使用<code>RabbitMQ</code>官方提供的<code>API</code>即可实现这一模型：</p>
<ol>
<li><p>引入依赖主要就是<code>spring-boot-starter-amqp</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>message-queue-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>02-message-queue-demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>02-message-queue-demo<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建发布者测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.publisher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PCTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">HelloWorldTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;192.168.56.1&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.创建连接通道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">//4.创建队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;hello.world.queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//5.发布消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Hello World Type RabbitMQ&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">        <span class="comment">//6.关闭通道，关闭连接</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试类，然后观察<code>http://192.168.56.1:15672/#/queues</code>中的队列情况。</p>
</li>
<li><p>创建消费者测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.publisher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PCTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">HelloWorldTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;192.168.56.1&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.创建连接通道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">//4.创建队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;hello.world.queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//5.发布消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Hello World Type RabbitMQ&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">        <span class="comment">//6.关闭通道，关闭连接</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试类，然后观察<code>http://192.168.56.1:15672/#/queues</code>中的队列情况以及控制台消息，可以看到控制台中打印了消息并且消息队列中的消息被消费了。</p>
</li>
</ol>
<h3 id="14-8-SpringAMQP实现发布订阅模型"><a href="#14-8-SpringAMQP实现发布订阅模型" class="headerlink" title="14.8 SpringAMQP实现发布订阅模型"></a>14.8 <code>SpringAMQP</code>实现发布订阅模型</h3><p><code>SpringAMQP</code>是基于<code>RabbitMQ</code>封装的一套模板，并且还利用 <code>SpringBoot</code>对其实现了自动装配，使用起来非常方便。<code>SpringAMQP</code>的官方地址：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-amqp%E3%80%82">https://spring.io/projects/spring-amqp。</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904202046.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904202056.png" alt="img"></p>
<p><code>SpringAMQP</code>提供了三个功能：</p>
<ul>
<li>自动声明队列、交换机及其绑定关系</li>
<li>基于注解的监听器模式，异步接收消息</li>
<li>封装了<code>RabbitTemplate</code>工具，用于发送消息</li>
</ul>
<h4 id="14-8-1-Hello-World"><a href="#14-8-1-Hello-World" class="headerlink" title="14.8.1 Hello-World"></a>14.8.1 <code>Hello-World</code></h4><p>使用<code>Spring AMQP</code>实现<code>Hello-World</code>发布订阅模型：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904211238.png" alt="img"></p>
<ol>
<li><p>消费者和生产者都需要引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>消费者和生产者都需要修改配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生产者使用<code>RabbitTemplate</code>发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.publisher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringAMQPTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimple</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;hello.world.queue&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;人类毁于傲慢。&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(queueName, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者监听消费：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;hello.world.queue&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimple</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="14-8-2-Work-Queue"><a href="#14-8-2-Work-Queue" class="headerlink" title="14.8.2 Work-Queue"></a>14.8.2 <code>Work-Queue</code></h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904211238.png" alt="img"></p>
<p>使用<code>Spring AMQP</code>实现<code>Work-Queue</code>发布订阅模型：</p>
<p><code>Work queues</code>，也被称为<code>（Task queues）</code>，任务模型。简单来说就是<strong>让多个消费者绑定到一个队列，共同消费队列中的消息【轮询消费】</strong>。</p>
<p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。此时就可以使用<code>work</code>模型，多个消费者共同处理消息处理，速度就能大大提高了。</p>
<ol>
<li><p>声明一个队列：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">workQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;work.queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建生产者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWork</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;work.queue&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;世界人民 --- &quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(queueName, (message + i));</span><br><span class="line">        Thread.sleep(<span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建消费者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;hello.world.queue&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimple</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;work.queue&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWork1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...1...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;work.queue&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWork2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...2...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>启动测试、消费者项目，可以看到不同的消费者轮询消费队列中的消息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">消费者...2...消费消息：世界人民 --- 0</span><br><span class="line">消费者...1...消费消息：世界人民 --- 1</span><br><span class="line">消费者...2...消费消息：世界人民 --- 2</span><br><span class="line">消费者...1...消费消息：世界人民 --- 3</span><br><span class="line">消费者...2...消费消息：世界人民 --- 4</span><br><span class="line">消费者...1...消费消息：世界人民 --- 5</span><br><span class="line">消费者...2...消费消息：世界人民 --- 6</span><br><span class="line">消费者...1...消费消息：世界人民 --- 7</span><br><span class="line">消费者...2...消费消息：世界人民 --- 8</span><br><span class="line">消费者...1...消费消息：世界人民 --- 9</span><br><span class="line">消费者...2...消费消息：世界人民 --- 10</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>这样的消费者轮询消费并没有考虑到不同消费者可能存在不同的处理能力。<code>RabbitMQ</code>默认有一个消息预取机制，还没消费就会预取下一个消息到下一个消费者手中，通过<code>prefetch</code>可以实现限制每次只能取1条消息，消费完毕后才能取下一个消息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><code>Work</code>模型的使用：</p>
<ul>
<li>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理</li>
<li>通过设置<code>prefetch</code>来控制消费者预取的消息数量</li>
</ul>
<h4 id="14-8-3-Fanout"><a href="#14-8-3-Fanout" class="headerlink" title="14.8.3 Fanout"></a>14.8.3 <code>Fanout</code></h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904213455.png" alt="img"></p>
<p>图中可以看到，在订阅模型中，多了一个<code>exchange</code>角色，而且过程略有变化</p>
<ul>
<li><code>Publisher</code>：生产者，也就是要发送消息的程序，但是不再发送到队列中，<strong>而是发给<code>exchange</code>（交换机）</strong></li>
<li><code>Consumer</code>：消费者，与以前一样，订阅队列，没有变化</li>
<li><code>Queue</code>：消息队列也与以前一样，接收消息、缓存消息</li>
<li><code>Exchange</code>：交换机，一方面，接收生产者发送的消息；另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于<code>Exchange</code>的类型。<code>Exchange</code>有以下<code>3</code>种类型：<ul>
<li><code>Fanout</code>：广播，将消息交给所有绑定到交换机的队列</li>
<li><code>Direct</code>：定向，把消息交给符合指定<code>routing key</code>的队列</li>
<li><code>Topic</code>：通配符，把消息交给符合<code>routing pattern</code>（路由模式） 的队列</li>
</ul>
</li>
</ul>
<p><strong><code>Exchange</code>（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与<code>Exchange</code>绑定，或者没有符合路由规则的队列，那么消息会丢失！</p>
<p><code>Fanout</code>，英文翻译是扇出，在<code>MQ</code>中我们也可以称为广播。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912160350.png" alt="img"></p>
<p>在广播模式下，消息发送流程是这样的：</p>
<ul>
<li>可以有多个队列</li>
<li>每个队列都要绑定到<code>Exchange</code>（交换机）</li>
<li>生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定</li>
<li>交换机把消息发送给绑定过的所有队列</li>
<li>订阅队列的消费者都能拿到消息</li>
</ul>
<ol>
<li><p>声明一个广播类型的交换机以及三个队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">&quot;fanout.exchange&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout2.queue2&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue3&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>绑定交换机跟队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">bindingFanoutQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue1()).to(fanoutExchange());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">bindingFanoutQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue2()).to(fanoutExchange());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">bindingFanoutQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue3()).to(fanoutExchange());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行项目，可以查看到交换机绑定了三个队列：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/938201a6be6b450dad10196d7c2b779b.png" alt="img"></p>
</li>
<li><p>消费者监听三个队列，实时消费：[创建三个消费者]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFanoutConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;fanout.queue1&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;广播模式...消费者...1...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;fanout.queue2&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;广播模式...消费者...2...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;fanout.queue3&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout3</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;广播模式...消费者...3...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>生产者发布消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Fanout Message&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;fanout.exchange&quot;</span>, <span class="string">&quot;&quot;</span>, message.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行项目，查看结果：可以看到虽然只生产了<code>1</code>条消息，但是在广播模式下，发送给了3个队列，丝毫不用理会<code>Routing Key</code>，这就是广播模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">广播模式...消费者..<span class="number">.1</span>...消费消息：Fanout Message</span><br><span class="line">广播模式...消费者..<span class="number">.3</span>...消费消息：Fanout Message</span><br><span class="line">广播模式...消费者..<span class="number">.2</span>...消费消息：Fanout Message</span><br></pre></td></tr></table></figure>
</li>
<li><p>除了使用配置类的方式配置绑定关系，还可以使用注解的方式配置绑定关系，声明新的队列</p>
<p>这里的<code>type = &quot;fanout&quot;</code>是一定要写的，因为默认是<code>direct</code>直连模式类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;fanout.queue4&quot;), exchange = @Exchange(value = &quot;fanout.exchange&quot;, type = &quot;fanout&quot;))&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout4</span><span class="params">(String message)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;广播模式...消费者...4...消费消息：&quot;</span> + message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="14-8-4-Direct"><a href="#14-8-4-Direct" class="headerlink" title="14.8.4 Direct"></a>14.8.4 <code>Direct</code></h4><p>在<code>Fanout</code>模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到<code>DirectExchange</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912182822.png" alt="img"></p>
<p>在<code>Direct</code>模型下：</p>
<ul>
<li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个<code>RoutingKey</code>（路由<code>key</code>）</li>
<li>消息的发送方向<code>Exchange</code>发送消息时，也必须指定消息的 <code>RoutingKey</code>。</li>
<li><code>Exchange</code>不再把消息交给每一个绑定的队列，而是根据消息的<code>Routing Key</code>进行判断，只有队列的<code>Routingkey</code>与消息的 <code>Routing key</code>完全一致，才会接收到消息</li>
</ul>
<ol>
<li><p>声明直连交换机、3个队列、绑定交换机跟队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfiguration2</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">directExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;direct.exchange&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDirectQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue1()).to(directExchange()).with(<span class="string">&quot;cold.coffee&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDirectQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue2()).to(directExchange()).with(<span class="string">&quot;hot.coffee&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDirectQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue3()).to(directExchange()).with(<span class="string">&quot;spicy.coffee&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建生产者发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Direct Cold Coffee Message&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;direct.exchange&quot;</span>, <span class="string">&quot;cold.coffee&quot;</span>, message.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建消费者消费消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDirectConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;direct.queue1&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者 ① 消费消息 冷咖啡：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;direct.queue2&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者 ② 消费消息 热咖啡：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;direct.queue3&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect3</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者 ③ 消费消息 辣咖啡：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行项目，可以发现只有消费者<code>1</code>消费了消息，因为生产者发送的<code>Routing Key ---&gt; cold.coffee</code>，而绑定关系也是<code>cold.coffee</code>，所以就只有消费者<code>1</code>消费了消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">直连模式 Direct 消费消息 冷咖啡：Direct Cold Coffee Message</span><br></pre></td></tr></table></figure>

<p>可以尝试改成<code>hot.coffee</code>，那就只有消费者<code>2</code>消费了消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">直连模式 Direct 消费消息 冷咖啡：Direct Cold Coffee Message</span><br><span class="line">直连模式 Direct 消费消息 热咖啡：Direct Hot Coffee Message</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用注解创建第四个队列并与<code>direct.exchange</code>交换机绑定，绑定关系有两个<code>sweet.coffee</code>和<code>hot.coffee</code>，所以当发送的路由键为<code>hot.coffee</code>，理应第二个队列跟第四个队列都收得到其余队列收不到，而为<code>sweet.coffee</code>时只有第四个队列消费得了消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;direct.queue4&quot;), exchange = @Exchange(value = &quot;direct.exchange&quot;, type = &quot;direct&quot;), key = &#123;&quot;sweet.coffee&quot;, &quot;hot.coffee&quot;&#125;)&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect4</span><span class="params">(String message)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者 ④ 消费消息 热咖啡和甜咖啡：&quot;</span> + message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行项目，结果与预期一致：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">消费者 ④ 消费消息 热咖啡和甜咖啡：Direct Hot Coffee Message</span><br><span class="line">消费者 ② 消费消息 热咖啡：Direct Hot Coffee Message</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="14-8-5-Topic"><a href="#14-8-5-Topic" class="headerlink" title="14.8.5 Topic"></a>14.8.5 <code>Topic</code></h4><p><code>Topic </code> 与 <code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic </code>类型可以让队列在绑定<code>Routing key</code> 的时候使用通配符！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912194016.png" alt="img"></p>
<p>通配符规则：</p>
<p><code>#</code>：匹配一个或多个词</p>
<p><code>*</code>：只能匹配一个词</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">item.#`：能够匹配 item.spu.insert 或者 item.spu</span><br><span class="line">item.*`：只能匹配 item.spu</span><br></pre></td></tr></table></figure>

<p>将上述图例转化为代码，全部使用注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTopicConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;topic.queue1&quot;), exchange = @Exchange(value = &quot;topic.exchange&quot;, type = &quot;topic&quot;), key = &#123;&quot;china.#&quot;&#125;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...1...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;topic.queue2&quot;), exchange = @Exchange(value = &quot;topic.exchange&quot;, type = &quot;topic&quot;), key = &#123;&quot;japan.#&quot;&#125;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...2...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;topic.queue3&quot;), exchange = @Exchange(value = &quot;topic.exchange&quot;, type = &quot;topic&quot;), key = &#123;&quot;#.weather&quot;&#125;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic3</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...3...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;topic.queue4&quot;), exchange = @Exchange(value = &quot;topic.exchange&quot;, type = &quot;topic&quot;), key = &#123;&quot;#.news&quot;&#125;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic4</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...4...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Direct china.weather.news Message&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;topic.exchange&quot;</span>, <span class="string">&quot;china.weather.news&quot;</span>, message.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">消费者..<span class="number">.1</span>...消费消息：Direct china.weather.news Message</span><br><span class="line">消费者..<span class="number">.4</span>...消费消息：Direct china.weather.news Message</span><br></pre></td></tr></table></figure>

<h3 id="14-9-消息转换器"><a href="#14-9-消息转换器" class="headerlink" title="14.9 消息转换器"></a>14.9 消息转换器</h3><p><code>Spring</code>会把你发送的消息序列化为字节发送给<code>MQ</code>，接收消息的时候，还会把字节反序列化为<code>Java</code>对象。</p>
<p><strong>默认情况下<code>Spring</code>采用的序列化方式是<code>JDK</code>序列化。</strong></p>
<p>我们可以去试一下效果：直接发送一个<code>Map</code>类型的数据给<code>object.queue</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObjectConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queuesToDeclare = &#123;@Queue(value = &quot;object.queue&quot;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic1</span><span class="params">(Map&lt;String, String&gt; map)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;接收 Map 消息：&quot;</span> + map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先停止消费者【先启动消费者是为了创建队列】，然后生产者发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testObject</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;张麻子&quot;</span>);</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;object.queue&quot;</span>, map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/535f76d79afb4f5d8b80785fcaf09f64.png" alt="img"></p>
<p>可以看到发送的消息体积非常大，可读性很差，所以推荐使用<code>JSON</code>格式进行序列化和反序列化。</p>
<ol>
<li><p>生产者和消费者均引入：<code>jackson</code>依赖</p>
</li>
<li><p>生产者和消费者均添加配置类，修改消息转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.MessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">jsonMessageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时再发送和接收消息就靠的是<code>jackson</code>来进行消息转换了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/86f249d02d9a44d19731c695645c1354.png" alt="img"></p>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Krolliaa</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/08/12/RabbitMQStudy/">http://example.com/2022/08/12/RabbitMQStudy/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Krolliaa</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a><a class="post-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></div><div class="post_share"><div class="social-share" data-image="/img/index_img/20.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/12/SpringStudyStudy/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring Study</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/12/NginxStudy/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Nginx Study</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/header.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Krolliaa</div><div class="author-info__description">俱往矣，数风流人物，还看今朝！</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/krolliaa"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">消息中间件是什么？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%91%A2%EF%BC%9F"><span class="toc-text">为什么要使用消息中间件呢？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">消息中间件的作用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E9%AB%98%E6%80%A7%E8%83%BD%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-text">RabbitMQ高性能的原因</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-%E2%80%94-AMQP%E5%8D%8F%E8%AE%AE"><span class="toc-text">RabbitMQ的底层原理 — AMQP协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A"><span class="toc-text">作业</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E7%9A%84%E5%BF%83%E8%84%8F"><span class="toc-text">RabbitMQ的心脏</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Direct-Exchange%E3%80%90%E7%9B%B4%E8%BF%9E%E6%A8%A1%E5%BC%8F%E3%80%91"><span class="toc-text">Direct Exchange【直连模式】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fanout-Exchange%E3%80%90%E6%89%87%E5%BD%A2%E6%A8%A1%E5%BC%8F%E3%80%91"><span class="toc-text">Fanout Exchange【扇形模式】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Topic-Exchange%E3%80%90%E4%B8%BB%E9%A2%98%E6%A8%A1%E5%BC%8F%E3%80%91"><span class="toc-text">Topic Exchange【主题模式】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A-1"><span class="toc-text">作业</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85"><span class="toc-text">RabbitMQ快速安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A-2"><span class="toc-text">作业</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-text">RabbitMQ命令行工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E6%B6%88%E6%81%AF%E4%BA%A4%E6%8D%A2%E7%9A%84%E5%85%B3%E9%94%AE%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">RabbitMQ消息交换的关键是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A-3"><span class="toc-text">作业</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-MessageQueue"><span class="toc-text">14. MessageQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-1-%E5%90%8C%E6%AD%A5%E9%80%9A%E8%AE%AF%E5%92%8C%E5%BC%82%E6%AD%A5%E9%80%9A%E8%AE%AF"><span class="toc-text">14.1 同步通讯和异步通讯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">14.2 消息队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-3-%E4%BD%BF%E7%94%A8Docker%E5%AE%89%E8%A3%85RabbitMQ"><span class="toc-text">14.3 使用Docker安装RabbitMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-4-RabbitMQ%E4%B8%AD%E7%9A%84%E8%A7%92%E8%89%B2%E5%8F%8A%E5%85%B6%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-text">14.4 RabbitMQ中的角色及其基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-5-RabbitMQ%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AAMQP%E5%8D%8F%E8%AE%AE"><span class="toc-text">14.5 RabbitMQ的底层实现原理：AMQP协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-6-RabbitMQ%E5%AE%98%E6%96%B9%E6%A8%A1%E5%9E%8B%E4%BB%8B%E7%BB%8D"><span class="toc-text">14.6 RabbitMQ官方模型介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-7-RabbitMQ%E5%AE%98%E6%96%B9API%E5%AE%9E%E7%8E%B0HelloWorld%E6%A8%A1%E5%9E%8B"><span class="toc-text">14.7 RabbitMQ官方API实现HelloWorld模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-8-SpringAMQP%E5%AE%9E%E7%8E%B0%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B"><span class="toc-text">14.8 SpringAMQP实现发布订阅模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-1-Hello-World"><span class="toc-text">14.8.1 Hello-World</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-2-Work-Queue"><span class="toc-text">14.8.2 Work-Queue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-3-Fanout"><span class="toc-text">14.8.3 Fanout</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-4-Direct"><span class="toc-text">14.8.4 Direct</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-5-Topic"><span class="toc-text">14.8.5 Topic</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-9-%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-text">14.9 消息转换器</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/10/CollectionAndMap/" title="Java Collection And Map"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java Collection And Map"/></a><div class="content"><a class="title" href="/2022/10/10/CollectionAndMap/" title="Java Collection And Map">Java Collection And Map</a><time datetime="2022-10-10T09:21:32.789Z" title="发表于 2022-10-10 17:21:32">2022-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/03/%E7%89%9B%E5%AE%A2Java%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" title="牛客Java刷题记录"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/18.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="牛客Java刷题记录"/></a><div class="content"><a class="title" href="/2022/10/03/%E7%89%9B%E5%AE%A2Java%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" title="牛客Java刷题记录">牛客Java刷题记录</a><time datetime="2022-10-03T02:03:41.265Z" title="发表于 2022-10-03 10:03:41">2022-10-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/17/EasyExcel/" title="EasyExcel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/17.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EasyExcel"/></a><div class="content"><a class="title" href="/2022/09/17/EasyExcel/" title="EasyExcel">EasyExcel</a><time datetime="2022-09-17T07:22:22.992Z" title="发表于 2022-09-17 15:22:22">2022-09-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/index_img/20.jpg')"><div id="footer-wrap"><div class="copyright">&copy;1984 - 2022 By Krolliaa</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div></div></body></html>