<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>SpringCloud Study | Krolliaa</title><meta name="keywords" content="框架,SpringCloud"><meta name="author" content="Krolliaa"><meta name="copyright" content="Krolliaa"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SpringCloud1. 微服务微服务技术不等于SpringCloud它们两个属于包含关系。下列包括记录员【注册中心】 + 管理员【配置中心】 + 安全员【服务网关】 + 守护员【分布式缓存】 + 侦察员【分布式搜索】 + 存储员【消息队列】 + 监察员A【分布式日志服务】 + 监察员B【分系统监控链路追踪 】 + 一群服务员【Jenkins + Docker + K8S + RANCHER】">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud Study">
<meta property="og:url" content="http://example.com/2022/08/15/SpringCloud/index.html">
<meta property="og:site_name" content="Krolliaa">
<meta property="og:description" content="SpringCloud1. 微服务微服务技术不等于SpringCloud它们两个属于包含关系。下列包括记录员【注册中心】 + 管理员【配置中心】 + 安全员【服务网关】 + 守护员【分布式缓存】 + 侦察员【分布式搜索】 + 存储员【消息队列】 + 监察员A【分布式日志服务】 + 监察员B【分系统监控链路追踪 】 + 一群服务员【Jenkins + Docker + K8S + RANCHER】">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/index_img/5.jpg">
<meta property="article:published_time" content="2022-08-15T03:31:17.665Z">
<meta property="article:modified_time" content="2022-08-22T13:42:11.103Z">
<meta property="article:author" content="Krolliaa">
<meta property="article:tag" content="框架">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/index_img/5.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/08/15/SpringCloud/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringCloud Study',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-22 21:42:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/header.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 记录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/plan"><i class="fa-fw fas fa-link"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/index_img/5.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Krolliaa</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 记录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/plan"><i class="fa-fw fas fa-link"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud Study</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-15T03:31:17.665Z" title="发表于 2022-08-15 11:31:17">2022-08-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-22T13:42:11.103Z" title="更新于 2022-08-22 21:42:11">2022-08-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Framework/">Framework</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">52.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>215分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a><code>SpringCloud</code></h1><h2 id="1-微服务"><a href="#1-微服务" class="headerlink" title="1. 微服务"></a>1. 微服务</h2><p>微服务技术不等于<code>SpringCloud</code>它们两个属于包含关系。下列包括记录员【注册中心】 + 管理员【配置中心】 + 安全员【服务网关】 + 守护员【分布式缓存】 + 侦察员【分布式搜索】 + 存储员【消息队列】 + 监察员<code>A</code>【分布式日志服务】 + 监察员<code>B</code>【分系统监控链路追踪 】 + 一群服务员【<code>Jenkins</code> + <code>Docker</code> + <code>K8S</code> + <code>RANCHER</code>】</p>
<ul>
<li><p>微服务首先要做的第一件事情就是拆分，根据功能从单体中拆分一个一个模块，从而形成一个<font color="pink">【服务集群】</font></p>
</li>
<li><p>拆分出来的模块可能有好几千个，想光靠人去处理效率非常低，所以就有了<font color="pink">【注册中心】</font>，它相当于一个记录员，记录了每一个模块的<code>IP</code>还有端口以及各个模块都有什么功能，当有一个模块想调用另外一个模块的功能的时候，它不需要自己去记录对方模块的<code>IP</code>、端口等信息只需要去找注册中心这个记录员就好了【拉取或注册服务信息】。</p>
</li>
<li><p>每一个服务或者你叫它模块也可以都有一个相对应的配置文件，这么多的模块成千上万个，难道要修改配置的时候还要从<code>IDEA</code>一个个去翻一个个去找吗？当然不是，这时候就需要有一个<font color="pink">【配置中心】</font>，它相当于一个管理员，管理配置的，如果某天你想更改某个服务的配置只需要到配置中心去改就好了，不用一个个去找这么麻烦，这个管理员它会去通知相关的服务更新配置且热更新【修改即改不用重启服务】</p>
</li>
<li><p>有了各个服务再加上有了记录员注册中心以及管理员配置中心，此时用户其实就可以访问服务集群里的服务了，但是用户可不可以访问以及怎么知道该访问的服务在哪里呢？总不能随便让人进来访问我的服务，万一这人是来捣乱或者图谋不轨的怎么办？所以此时就需要一个安全员，也就是<font color="pink">【服务网关】</font>，一方面对用户身份做校验，并且可以把用户的请求路由到各个服务模块，并且可以在此过程中做一些负载均衡，服务模块处理然后把数据返回给用户</p>
</li>
<li><p>到现在看似好像都没什么问题了？但是有一个问题，就是万一用户的数量太多太多了都去访问数据库，万一数据库崩了怎么办？所以呢为了保险起见，我们需要一个保护数据库任务的守护员，这个守护员就是<font color="pink">【分布式缓存】</font>，用户来了先去访问这个分布式缓存，未命中再去访问数据库，分担了数据库不小的压力</p>
</li>
<li><p>现在好了吧，我有了服务集群、记录员注册中心、管理员配置中心、还有安全员服务网关以及守护员分布式缓存保护数据库，你没话讲了吧，不，我还有话讲，万一你这个要搜索要获取非常非常海量数据的满足特定条件的一两条数据，你该怎么办？啊这…所以就要还要有侦察员<font color="pink">【分布式搜索】</font>，记录员 + 管理员 + 安全员 + 守护员 + 侦察员，各司其职形成了微服务架构</p>
</li>
<li><p>到这就真的完毕了吗？假设现在某个用户访问了<code>A</code>模块，然后又访问了<code>B</code>模块，一直一直这样访问到<code>Z</code>模块，那么这条访问链路不用想那是相当相当的长，这边用户等的就可捉急了，咋办？此时就要引入转储员<font color="pink">【消息队列】</font>，模块<code>A</code>只需要去通知各个模块完成他们的功能即可，然后<code>A</code>模块直接就完成了它的任务返回给了用户，这就大大缩短了响应时间，可以处理秒杀高并发</p>
</li>
<li><p>再来思考一个问题？如此庞大的一个服务架构，万一某一处出了点问题，好排查吗？当然不好排查。所以就需要有一个实时监视这整个服务的监察员<code>A</code><font color="pink">【分布式日志服务】</font>，它可以去统一存储统计分析整个服务的日志还有我们的监察员<code>B</code><font color="pink">【系统监控链路追踪】</font>，它可以去实时监视每一个服务节点的运行状态，<code>CPU</code>占用信息等</p>
</li>
<li><p>最后这么庞大的一个微服务集群，人工部署是不是非常的麻烦比较效率低下呢？这时候就要请一群服务员了，让他们去帮我们自动化部署整个项目，持续集成<font color="pink">【<code>Jenkins</code>、<code>Docker</code>、<code>K8S</code>、<code>RANCHAER</code>】</font></p>
<p>​	<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/67a95be4c2724b8bae997f029147f87f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
</li>
</ul>
<h2 id="2-如何学习"><a href="#2-如何学习" class="headerlink" title="2. 如何学习"></a>2. 如何学习</h2><p>微服务篇可以看到整个微服务也忒复杂了，把这个学好出去岂不是横着走？那么这么复杂的微服务该如何学习呢？</p>
<p>重要的就是练习练习再练习，达到熟练的程度</p>
<p>分九步走【实用篇<code>1-4</code> + 高级篇<code>5-9</code>】：</p>
<ol>
<li>微服务治理：<code>Eureka</code>、<code>Nacos</code>、<code>OpenFeign</code>、网关<code>GateWay</code><font color="red"><strong>【具体看：<code>6 7 8 9 10 11 12</code>】</strong></font></li>
<li><code>Docker</code>：<code>Docker原理</code>、<code>Docker使用</code>、<code>Dockerfile</code>、<code>DockerCompose</code><font color="red"><strong>【具体看：<code>13</code>】</strong></font></li>
<li>异步通信：同步和异步、<code>MQ</code>技术选型、<code>SpringAMQP</code>、消费者限流<font color="red"><strong>【具体看：<code>14</code>】</strong></font></li>
<li>分布式搜索：<code>DSL</code>语法、<code>HighLevelClient</code>、拼音搜索、自动补全、竞价排名、地理搜索、聚合统计、分片集群<font color="red"><strong>【具体看：<code>15</code>】</strong></font></li>
<li>微服务保护：流量控制、系统保护、熔断降级、服务授权</li>
<li>分布式事务：<code>XA</code>模式、<code>TCC</code>模式、<code>AT</code>模式、<code>Saga</code>模式</li>
<li>分布式缓存：数据持久化、<code>Redis</code>主从集群、哨兵机制、<code>Redis</code>分片集群</li>
<li>多级缓存：多级缓存分层、<code>Nginx</code>缓存、<code>Redis</code>缓存、<code>Canal</code>数据同步</li>
<li>可靠消息服务：消息三方确认、惰性队列、延迟队列、镜像集群、仲裁队列</li>
</ol>
<h2 id="3-微服务架构的演变"><a href="#3-微服务架构的演变" class="headerlink" title="3. 微服务架构的演变"></a>3. 微服务架构的演变</h2><blockquote>
<ul>
<li>单体架构：将业务所有的功能集中在一个项目中开发，打包部署即可<ul>
<li>优点：架构简单 + 部署成本低</li>
<li>缺点：耦合度高 + 一旦项目很大打包时间也将非常长</li>
</ul>
</li>
</ul>
<hr>


<ul>
<li>分布式架构：根据业务功能对系统进行拆分，每个业务模块作为独立项目开发，称为一个服务<ul>
<li>优点：降低服务耦合 + 有利于服务升级扩展</li>
<li>问题：分布式需要考虑许多问题，比如访问量大的时候并且放置服务器故障你得做个集群然后你得做远程过程调用<code>RPC</code>，服务拆分粒度如何？服务集群地址如何维护？服务之间如何实现远程调用<code>RPC</code>？服务健康状态如何感知？</li>
</ul>
</li>
</ul>
<hr>


<ul>
<li>如何解决分布式上面所阐述的问题，当前最好的解决方案就是 —&gt; 微服务【还是分布式架构】<ul>
<li>微服务是一种经过良好架构设计的分布式架构方案，微服务机构特征：<ul>
<li>单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责避免重复业务开发</li>
<li>面向服务：微服务对外暴露业务接口</li>
<li>自治：符合敏捷开发的思路，团队独立、技术独立、数据独立【有自己独立的数据库】、部署独立【用户可以根据自己的需求去访问】</li>
<li>隔离性强：服务调用做好隔离、容错、降级、避免出现级联问题</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>总结：</p>
<ol>
<li>单体架构特点：简单方便、高度耦合、扩展性差，适合小型项目，比如：学生管理系统</li>
<li>分布式架构特点：松耦合、扩展性好但是架构复杂、难度大，适合大型项目，比如：京东、淘宝</li>
<li>微服务：一种良好的分布式架构方案<ul>
<li>优点：拆分粒度更小、服务更独立、耦合度更低</li>
<li>缺点：架构非常复杂、运维、监控、部署难度提高</li>
</ul>
</li>
</ol>
<p>在国内常用微服务方案落地实现的具体技术框架有：<code>SpringCloud</code> + <code>Dubbo</code> + <code>SpringCloud Alibaba</code></p>
<h2 id="4-微服务技术对比和企业常用"><a href="#4-微服务技术对比和企业常用" class="headerlink" title="4. 微服务技术对比和企业常用"></a>4. 微服务技术对比和企业常用</h2><table>
<thead>
<tr>
<th></th>
<th align="center"><code>Dubbo</code></th>
<th align="center"><code>SpringCloud</code>【整合，只支持<code>Feign</code>方式】</th>
<th align="center"><code>SpringCloud Alibaba</code>【越来越火，重点，支持<code>Feign</code>又支持<code>Dubbo</code>】</th>
</tr>
</thead>
<tbody><tr>
<td>注册中心</td>
<td align="center"><code>Zookeeper</code>、<code>Redis</code>【别人的】</td>
<td align="center">Eureka、Consul</td>
<td align="center"><code>Nacos</code>】、<code>Eureka</code></td>
</tr>
<tr>
<td>远程过程调用</td>
<td align="center"><code>Dubbo</code>协议【核心】</td>
<td align="center">Feign（<code>http</code>协议）</td>
<td align="center"><code>Dubbo</code>、<code>Feign</code></td>
</tr>
<tr>
<td>配置中心</td>
<td align="center">无</td>
<td align="center"><code>SpringCloudConfig</code></td>
<td align="center"><code>SpringCloudConfig</code>、<code>Nacos</code></td>
</tr>
<tr>
<td>服务网关</td>
<td align="center">无</td>
<td align="center"><code>SpringCloudGateway</code>、<code>Zuul</code></td>
<td align="center"><code>SpringCloudGateway</code>、<code>Zuul</code></td>
</tr>
<tr>
<td>服务监控和保护</td>
<td align="center"><code>dubbo-admin</code>、功能弱</td>
<td align="center"><code>Hystrix</code></td>
<td align="center"><code>Sentinel</code></td>
</tr>
</tbody></table>
<ul>
<li><p>企业常用选型第一种：<code>SpringCloud + Feign</code>，使用<code>SpringCloud</code>技术栈，服务接口采用<code>Restful</code>风格，服务远程过程调用采用<code>Feign</code>方式</p>
</li>
<li><p>企业常用选型第二种：<code>SpringCloudAlibaba + Feign</code>，使用<code>SpringCloudAlibaba</code>技术栈，服务接口采用<code>Restful</code>风格，服务调用采用<code>Feign</code>方式</p>
</li>
<li><p>企业常用选型第三种：<code>SpringCloudAlibaba + Dubbo</code>，使用<code>SpringCloudAlibaba</code>技术栈，服务接口采用<code>Dubbo</code>协议标准，服务远程过程调用采用<code>Dubbo</code>方式</p>
</li>
<li><p>企业常用选型第四种：<code>Dubbo</code>原始模式，基于<code>Dubbo</code>老旧技术体系，服务接口采用<code>Dubbo</code>协议标准，服务远程过程调用采用<code>Dubbo</code>方式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/7bb5d2a2acee45daae5fdc7165cacafc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
</li>
</ul>
<h2 id="5-初步认识SpringCloud"><a href="#5-初步认识SpringCloud" class="headerlink" title="5. 初步认识SpringCloud"></a>5. 初步认识<code>SpringCloud</code></h2><p><code>SpringCloud</code>是目前国内甚至可以说是全球使用最广泛的微服务架构，集成了各种微服务软件功能组件，并基于<code>SpringBoot</code>实现了这些组件的自动装配，开箱即用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/fade331c62d2415391bf3d8347260c12.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p><code>SpringCloud</code>为什么能够推广开来就是因为基于<code>SpringBoot</code>实现了许多组件的自动装配，这样拿过来就可以直接使用了，而不用去学习原生的方法，这就是为什么<code>SpringCloud</code>可以推广开来，本质上靠的是<code>SpringBoot</code>【人家是由很扎实的基础的】</p>
<p><code>SpringCloud</code>和<code>SpringBoot</code>存在兼容性 问题，最佳适应版本需要前往<code>SpringCloud</code>的官网查看</p>
<p>本次学习使用的<code>SpringCloud</code>版本为：<code>Hoxton.SR10</code>，对应<code>SpringBoot 2.3.x</code></p>
<h2 id="6-服务拆分和远程调用"><a href="#6-服务拆分和远程调用" class="headerlink" title="6. 服务拆分和远程调用"></a>6. 服务拆分和远程调用</h2><p>注意事项：</p>
<ol>
<li>不同的微服务，不要重复开发相同业务，如果出现了那说明做的有问题</li>
<li>微服务数据独立，不要访问其它服务的数据库，这就从根源上杜绝了耦合性的业务【分库分表】</li>
<li>微服务可以将自己的业务暴露为接口，供其它服务使用</li>
</ol>
<p><code>Demo</code>：</p>
<p>项目结构：<code>cloud-demo</code> —&gt; <code>order-service</code>订单服务 + <code>user-service</code>用户服务</p>
<p>数据独立：<code>cloud-user.sql</code>[用户] + <code>cloud-order.sql</code>[订单]</p>
<ol>
<li>创建订单服务数据库：<code>cloud_order.database</code>[直接导入]</li>
<li>创建用户服务数据库：<code>cloud_user.database</code>[直接导入]</li>
<li>直接导入资源文件<code>cloud-demo</code></li>
</ol>
<p>如何实现远程服务调用？之前在前端我们可以通过<code>Ajax</code>查询出数据，那么在<code>order</code>这一段能不能通过<code>http</code>请求查询出<code>user</code>呢？显然该方案是可行的。</p>
<p>问题就成为了如何在<code>order</code>这一段发送<code>http</code>请求呢？<code>Spring</code>提供了一个工具可以用来发送<code>http</code>请求 —&gt; <code>RestTemplate</code> —&gt; 通过<code>RestTemplate</code>远程调用<code>http://localhost:8081/user/&#123;userId&#125;</code>获取到<code>User</code>将其赋予给<code>order-service</code>模块的<code>pojo.User</code>。【该项任务是业务处理的一部分所以放到<code>service</code>层中去写代码】</p>
<p>上述代码已放置<code>github</code>仓库：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/ee944eb5299c44b58cb304e97d74053d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h2 id="7-服务提供者和服务消费者"><a href="#7-服务提供者和服务消费者" class="headerlink" title="7. 服务提供者和服务消费者"></a>7. 服务提供者和服务消费者</h2><ul>
<li>服务提供者：一次业务中，被其它微服务调用的服务（暴露接口给其它微服务调用）</li>
<li>服务消费者：一次业务中，调用其它微服务的服务（调用其它微服务提供的接口）</li>
<li>一个服务既可以是提供者也可以是消费者</li>
</ul>
<h2 id="8-Eureka注册中心"><a href="#8-Eureka注册中心" class="headerlink" title="8. Eureka注册中心"></a>8. <code>Eureka</code>注册中心</h2><p>之前我们的<code>order</code>服务去调用<code>user</code>服务的时候采用的是硬编码的方式即直接写代码的方式：试想这种会造成什么问题？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/a5909ac5b9f3400a9af7e04f64eabb9d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<ol>
<li><p>项目创建过程中有许多环境，生产环境测试环境开发环境，这些个<code>URL</code>地址肯定不一样，难道每换一个环境就要更改一次代码吗？这显然非常的麻烦</p>
</li>
<li><p>现在这里只有一个<code>user-service</code>，端口是<code>8081</code>，试想如果<code>user-service</code>做了集群，除了<code>8081</code>还有<code>8082 8083</code>等等端口，那难道每次调用的时候都去更改代码吗？如果更改了代码，做集群还有意义吗？显然是没有的。而且万一挑选的那一台服务是不健康的挂了的呢？你如何确保可以准确的调用该接口呢？</p>
</li>
</ol>
<p>那要怎么解决呢？<code>Eureka</code>注册中心解决这种硬编码带来的大问题：</p>
<ol>
<li><code>Eureka</code>注册中心将自身称为**<font color="red"><code>eureka-server</code>注册中心服务端</font><strong>，将其余的像<code>order-service</code>和<code>user-service</code>这些统称为是</strong><font color="red"><code>eureka-client</code>注册中心客户端</font>**。</li>
<li>秉承一个服务既可能是服务调用者也可能是服务提供者的理念，所有的服务只要存在都会将自己的注册服务信息注册到<code>eureka-server</code>注册中心服务端中，该动作叫做**<font color="red">注册服务信息</font>**</li>
<li>那如果一个服务挂了怎么办？不用担心，因为<code>eureka-server</code>有**<font color="red">心跳检测</font><strong>，</strong>每隔<code>30s</code>，<code>eureka-client</code>注册中心客户端需要发送1次心跳**，注册中心服务端会更新注册服务列表，对不正常的服务信息进行删除，服务调用者可以拉取到最新的服务信息</li>
<li>当某个服务调用者需要某个服务的时候就会从<code>eureka-server</code>注册中心服务端中调用服务，比如这里做了集群有三个<code>user-service</code>，都会拉取过来，该动作叫做**<font color="red">拉取服务提供者的信息</font>**</li>
<li>拉取过来具体选哪个服务调用需要使用到**<font color="red">负载均衡技术</font>**</li>
<li>确定了哪个服务之后<code>order-service</code>就会通过**<font color="red">远程调用</font>**调用某个端口的服务提供者<code>user-service</code></li>
</ol>
<p>​	<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/90213662777c4cc2b6b6fa27816f4f72.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>问题描述及解答：</p>
<ol>
<li><strong><font color="deepskyblue">消费者该如何获取服务提供者的具体信息？</font></strong><ul>
<li>服务【无论是服务提供者还是服务调用者<code>eureka-client</code>】启动时都会向注册中心服务端<code>eureka-server</code>注册服务信息，注册中心服务端会保存这些信息</li>
<li>服务调用者即消费者会从注册中心服务端<code>eureka-server</code>拉取服务信息</li>
</ul>
</li>
<li><strong><font color="deepskyblue">如果有多个服务提供者，消费者该如何选择？</font></strong><ul>
<li>消费者即服务调用者会通过负载均衡技术，从从注册中心服务端拉取过来的服务选择一个</li>
</ul>
</li>
<li><strong><font color="deepskyblue">消费者如何感知提供者健康状态？</font></strong><ul>
<li>每隔<code>30s</code>服务提供者就会向<code>eureka-server</code>注册中心服务端发送心跳请求，报告当前健康状态</li>
<li>对于不正常的服务信息，注册中心服务端<code>eureka-server</code>会将其从服务信息列表中删除</li>
<li>服务调用者即消费者可以从注册中心服务端中拉取到最新的服务信息</li>
</ul>
</li>
</ol>
<p>【注：<code>eureka</code>也是一个微服务，需要注册<code>eureka</code>自己本身】</p>
<h3 id="8-1-搭建eureka-server"><a href="#8-1-搭建eureka-server" class="headerlink" title="8.1 搭建eureka-server"></a>8.1 搭建<code>eureka-server</code></h3><ol>
<li><p>创建项目，配置<code>spring-cloud-starter-netflix-eureka-server</code>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--版本可以不写，因为在父pom已经编写好--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写启动类，添加<code>@EnableEurekaServer</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zwm.eureka;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServiceApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加<code>application.properties</code>文件，编写该配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端口[任意]</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">10086</span></span><br><span class="line"><span class="comment"># 服务名称 - 微服务名称[为了做服务注册]</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">eureka-server</span></span><br><span class="line"><span class="comment"># 配置eureka地址信息[eureka 也是一个微服务，把自己也注册在eureka身上][为了做服务注册]</span></span><br><span class="line"><span class="attr">eureka.client.service-url.defaultZone</span>=<span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>点击<code>IDEA</code>端口可以直接跳转到<code>eureka</code>管理页面，访问：<code>http://localhost:10086</code>[没有后缀]</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/fb33d846a96e4292a1855a60b8785267.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
</li>
</ol>
<h3 id="8-2-搭建eureka-client"><a href="#8-2-搭建eureka-client" class="headerlink" title="8.2 搭建eureka-client"></a>8.2 搭建<code>eureka-client</code></h3><p>将<code>user-service</code>和<code>order-service</code>服务注册到<code>EurakaServer</code>：</p>
<ol>
<li><p>在<code>user-service</code>的<code>pom.xml</code>中引入依赖：<code>spring-cloud-starter-netflix-eureka-client</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>application.properties</code>配置注册服务：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.application.name</span>=<span class="string">user-service</span></span><br><span class="line"><span class="attr">eureka.client.service-url.defaultZone</span>=<span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>按照上述步骤可以注册<code>order-service</code>，这里不再赘述</li>
</ul>
<p><code>IDEA</code>可以模拟启动多个服务：<code>ctrl+D</code>或者右键服务选择<code>	Copy Configuration</code>然后配置一下<code>VM options: -Dserver.port=8082</code> —&gt; <code>apply</code> —&gt; <code>ok</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/57c02b3dbf9d43fba47d870f62418b4f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>完成后<code>eureka-service</code>显示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/87a5506f10994a8f8274f1740c500cc0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>到这里就完成了将服务注册到<code>eureka</code></p>
<h3 id="8-3-Eureka-服务发现"><a href="#8-3-Eureka-服务发现" class="headerlink" title="8.3. Eureka 服务发现"></a>8.3. <code>Eureka</code> 服务发现</h3><ol>
<li><p>修改源代码，将其改为<code>spring.application.name</code>的名称，这个服务已经在注册中心<code>eureka</code>中注册好了，所以直接调用消费即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/a5909ac5b9f3400a9af7e04f64eabb9d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Order&gt; <span class="title function_">findAllOrders</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Order&gt; orderList = orderMapper.selectAllOrders();</span><br><span class="line">    <span class="keyword">for</span> (Order order : orderList) &#123;</span><br><span class="line">        <span class="comment">//String url = &quot;http://localhost:8081/getUserById?id=&quot; + order.getUserId();</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://user-service/getUserById?id=&quot;</span> + order.getUserId();</span><br><span class="line">        order.setUser(restTemplate.getForObject(url, User.class));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> orderList;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给<code>RestTemplate</code>上加入<code>@LoadBanlanced</code>引入负载均衡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>重启服务，成功实现<code>order-service</code>通过注册中心拉取<code>user-service</code>注册到<code>eureka</code>的服务信息，并引入负载均衡，通过在<code>application.properties</code>中配置<code>mybatis.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl</code>可以发现<code>UserApplication:8081</code>和<code>UserApplication:8082</code>都被调用了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/538bea1b57aa4349b884e8ed4234278d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h3 id="8-4-LoadBalanced注解原理-—-gt-Ribbon负载均衡流程"><a href="#8-4-LoadBalanced注解原理-—-gt-Ribbon负载均衡流程" class="headerlink" title="8.4. @LoadBalanced注解原理 —&gt; Ribbon负载均衡流程"></a>8.4. <code>@LoadBalanced</code>注解原理 —&gt; <code>Ribbon</code>负载均衡流程</h3><p>为什么我们在<code>RestTemplate</code>加入了<code>@LoadBalanced</code>就可以完成负载均衡？中途到底发生了什么事情？这就引出了我们要学习<code>SpringCloud</code>的第二个组件 —&gt; <code>Ribbon</code>，它是用来完成负载均衡的！</p>
<p>之前我们是将<code>order-service</code>中的<code>OrderService</code>的<code>URL</code>地址改成了：<code>http://user-service/getUserById?id=1</code>，我们直接访问这个<code>URL</code>地址，发现根本无法访问，说明这个地址被拦截了：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/7348388b2832429cbd23038b2085bb9d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>那是谁帮我们拦截解析了呢？答案是<code>Ribbon</code>组件</p>
<ol>
<li><code>OrderService</code>发送请求：<code>http://user-service/getUserById?id=x</code>给<code>Ribbon</code>负载均衡</li>
<li><code>Ribbon</code>从<code>eureka-server</code>中拉取<code>user-service</code></li>
<li><code>eureka-server</code>返回<code>user-service</code>服务列表给<code>Ribbon</code>负载均衡</li>
<li>最后<code>Ribbon</code>轮询获取到<code>user-service</code>服务</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/d802ea08315f4a1c88f7a518e44e1fdb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p><code>@LoadBalanced</code>这个注解就表示<code>order-service</code>发送的请求会被<code>Ribbon</code>组件拦截解析，那么<code>Ribbon</code>是如何实现拉取服务，又是如何实现负载均衡的呢？其原理是什么呢？最好的方法就是深入源码一探究竟。</p>
<p>【注：该<code>eureka</code>版本为<code>2.2.7RELEASE</code>，新版本的源代码可能已经改动】</p>
<ol>
<li><p><code>order-service</code>发送<code>http://user-service/getUserById?id=x</code>请求，该请求是由<code>RestTemplate</code>发送的，因为在<code>RestTemplate</code>上加入了<code>@LoadBanlanced</code>，所以该请求会传入到<code>LoadBanlancerInterceptor.java</code>进行拦截</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/d90d44a68a9d4ba9ab175ef74c8483af.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>可以看到<code>LoadBalancerInterceptor</code>实现了<code>ClientHttpRequestInterceptor</code>接口，我们点进去看看</p>
</li>
<li><p>我们可以看见<code>ClientHttpRequestInterceptor</code>接口描述第一句话就是作用：<code>对客户端HTTP请求进行拦截</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/6204f36bc1454f40896524ea30f48c9a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>也就是说这也刚好反向验证了<code>LoadBalancerInterceptor</code>拦截器对服务调用者发起的请求进行了拦截，实现了<code>ClientHttpRequestInterceptor</code>中的<code>intercept</code>方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/ba9ed98b77e447cb929c91cead934f26.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
</li>
<li><p>根据最上面的流程图，下一步<code>Ribbon</code>就是要获取到服务名称，然后根据服务名称从<code>eureka-server</code>中拉取服务列表</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/0e5cd3e838634411b69b09989c4e704c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>获取到服务名称然后是如何进行拉取的呢？—&gt;<code>RibbonLoadBalancerClient.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/87f92e54360e4f83b093f3847c4bf5ec.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>继续进入：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/c50e08b08e174784b8b1688d76b8eecd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>可以发现通过<code>DynamicServerListLoadBalancer.java</code>以及刚刚获取到的服务名称进一步获取到了<code>LoadBalancer</code>对象，通过<code>LoadBalancer</code>可以获取到服务列表</p>
</li>
<li><p>按照流程，从拦截请求再到获取服务名称再到获取服务列表，下一步就是要做负载均衡，对服务列表进行轮询，使用的是<code>IRule</code>接口，负载均衡轮询选择实在上述<code>getServer()</code>完成的，进入到<code>getServer()</code>看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/88f8f66e80164e68ae1264e2d817af8f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>继续进入：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/b39488337e2349ff9ead72859cc1ae70.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>负载均衡肯定有一套规则在里面，是以什么规则进行负载均衡？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/8620a678238b430a8619dc25d3b42bdc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>通过查看得知这是一个<code>IRule</code>对象，但是<code>IRule</code>是一个接口，那么它就一定有实现类，通过<code>Ctrl+H</code>可以查看某个接口的实现类：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/60ae5043a6ea40f992d01b2d631c9008.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>这里边就有一个<code>RoundRobinRule</code>表示的是轮询的意思，也就是说<code>RoundRobinRule</code>实现了轮询规则，就是按照这个方式来轮询查找服务列表中的服务</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/8445db49eb2f4e32a0c799d0c377b9e9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
</li>
</ol>
<p>通过上述源代码的分析，我们也就知道了个大概，知道<code>Robbin</code>组件进行了如下操作：</p>
<ol>
<li>通过<code>LoadBalancerInterceptor</code>拦截请求后并且从<code>URL</code>地址中获取服务名称</li>
<li>再通过<code>RibbonLoadBalancerClient</code>以及服务名称调用第三步获取服务列表</li>
<li><code>DynamicServerListLoadBalancer</code>从<code>eureka-server</code>中拉取服务列表</li>
<li>再通过实现<code>IRule</code>接口的<code>RobbinRoundRule</code>轮询规则进行负载均衡从服务列表中选出一台服务</li>
<li>最后通过<code>RibbonLoadBalancerClient</code>替换<code>URL</code>地址，发送请求获取服务</li>
</ol>
<p>下面这张图应该在<code>order-service</code>和<code>RibbonLoadBalancerClient</code>之间再加上一个<code>LoadBalancerInterceptor</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/8973eaf72e254a68b03226ef976783fb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h3 id="8-5-Eureka注册中心拉取服务列表的Robbin-—-gt-负载均衡策略"><a href="#8-5-Eureka注册中心拉取服务列表的Robbin-—-gt-负载均衡策略" class="headerlink" title="8.5.Eureka注册中心拉取服务列表的Robbin —&gt;  负载均衡策略"></a>8.5.<code>Eureka</code>注册中心拉取服务列表的<code>Robbin</code> —&gt;  负载均衡策略</h3><p><code>Ribbon</code>完成负载均衡靠得是一套规则，规则由<code>Rule</code>接口来定义，<code>Rule</code>接口的每一个子接口都是一种规则：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/0804c04f7c944c2c8ef7e9f9790af037.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p><strong>实现负载均衡的策略多种多样，默认是使用<code>RoundRobbinRule</code>轮询的方式选择服务器</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/65ac29316cef46d992846a9c4f5dea16.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>先看看这种轮询的方式，可以看到<code>UserApplication1</code>中查找的是<code>1 3 5</code>，那么自然<code>UserApplication2</code>中查找的是<code>2 4 6</code>，这也证明了是通过轮询的方式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/f1b848a73e744a88b34cf8da33c4201d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>通过代码的方式更换负载均衡策略，注意重启服务器，这种方式是全局配置，<code>order-service</code>调用所有的服务使用的负载均衡策略就都变成了随机选择的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RandomRule <span class="title function_">randomRule</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">&#125;</span><br><span class="line">或者</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">randomRule</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新发起请求，可以看到选择服务器的变化，在<code>id</code>为<code>3 4 5 6</code>的时候选择了<code>UserApplication1</code>作为服务器，随机选择，说明负载均衡策略更改成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/ac8c64a6fe3343779281f09417fa2f71.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>有时候，我就想调用某个服务实行的是<code>A</code>负载均衡策略，调用<code>B</code>服务的时候施行的时候<code>B</code>负载均衡策略，可以做到吗？当然可以，这种实行负载均衡策略的方式需要在配置文件中配置<code>application.properties</code> —&gt; 针对某个微服务而言：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user-service.ribbon.NFLoadBalancerRuleClassName</span>=<span class="string">com.netflix.loadbalancer.RandomRule</span></span><br></pre></td></tr></table></figure>

<h3 id="8-6-Ribbon饥饿加载"><a href="#8-6-Ribbon饥饿加载" class="headerlink" title="8.6 Ribbon饥饿加载"></a>8.6 <code>Ribbon</code>饥饿加载</h3><p><code>Ribbon</code>默认使用的是懒加载，什么是懒加载呢？就是客户端第一次访问的时候才会去创建<code>RobbinLoadBalancerClient</code>对象，所以第一访问的时间都会非常的漫长，如下图，可以看到足足达到<code>715ms</code>之久：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/0b7ae9183e4d425d9dcc93ccf876659f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>为了加快访问速度，可以改变懒加载，配置成是饥饿加载，这样只要服务在启动的时候创建<code>LoadBalancerClient</code>对象，从而降低了第一次访问时间过长的现象，配置如下：<code>ribbon.eager-load.client</code> —&gt; 项目启动时直接去拉取<code>userservice</code>的集群，多个用”,”隔开</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon.eager-load.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">ribbon.eager-load.clients</span>=<span class="string">user-service</span></span><br></pre></td></tr></table></figure>

<p>重启服务，观察加载时间，如下图可以看到在<code>order-service</code>服务启动时就加载了<code>LoadBalancerClient</code>对象：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/e07b2e8ac65c436a98caa1e9253d8d9f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>客户端访问的时间，可以看到饥饿加载相比于懒加载的时间足足降低了一半还少：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/8b634ff21d894df6831e2c5141907563.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h2 id="9-Nacos注册中心"><a href="#9-Nacos注册中心" class="headerlink" title="9. Nacos注册中心"></a>9. <code>Nacos</code>注册中心</h2><h3 id="9-1-Nacos注册中心安装"><a href="#9-1-Nacos注册中心安装" class="headerlink" title="9.1 Nacos注册中心安装"></a>9.1 <code>Nacos</code>注册中心安装</h3><p><code>Nacos</code>是阿里巴巴开发的一个产品，现在是<code>SpringCloud</code>的一个组件。比<code>Eureka</code>的功能更多一点，在国内<code>Nacos</code>更受欢迎，所以学习<code>Nacos</code>还是有必要的。而且<code>Nacos</code>是<code>Java</code>语言实现的。</p>
<p>有人说<code>Eureka</code>停止更新了，其实这是个错误的说法，<code>Eureka</code>有两种版本，一种是一点几的版本，一种是二点几的版本，停止的是二点几的版本，而且这个版本的<code>Eureka</code>压根就还没有出来就停止了。【<code>2022</code>年<code>2.x</code>的版本被重新放出来了】</p>
<p>安装：<code>github</code> —&gt; 下载<code>release</code> —&gt; 解压 —&gt; 默认端口是<code>8848</code>  —&gt; 可以在配置文件中自定义端口 —&gt; 启动：<code>startup.cmd -m standalone[单机模式，-m 是 mode 的意思]</code> —&gt; 登录：<code>http://192.168.0.106:8848/nacos/index.html</code> –&gt; 账号密码均为：<code>nacos</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/d12925e16eb342d2b02b03ad4acc9355.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/d5d5f511c23142d2a3c890b8a1964384.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h3 id="9-2-Nacos实现注册与发现"><a href="#9-2-Nacos实现注册与发现" class="headerlink" title="9.2. Nacos实现注册与发现"></a>9.2. <code>Nacos</code>实现注册与发现</h3><p>【<code>Nacos</code>和<code>Eureka</code>的区别在于<code>Eureka</code>是需要你自己手动配置服务端，而<code>Nacos</code>直接就是安装包安装好了使用命令打开就是服务端，所以在<code>Nacos</code>只需要配置客户端即可】</p>
<ol>
<li><p>引入依赖 —&gt; <code>Nacos</code>是阿里巴巴提供的所以我们在父<code>pom.xml</code>引入<code>spring-cloud-alibaba</code>管理依赖，日后就不用再多加管理</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注释掉<code>eureka</code>在<code>pom</code>文件中的依赖还有配置文件中的信息</p>
</li>
<li><p>在<code>user-service</code>和<code>order-service</code>添加<code>Nacos</code>的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将<code>user-service</code>和<code>order-service</code>中的<code>application.properties</code>配置<code>eureka</code>的配置注释掉配置<code>nacos</code>的配置 —&gt; 声明<code>Nacos</code>服务端所在的位置，监听的端口是什么？ —&gt; 这里需要将<code>eureka</code>中的信息注释掉 </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cloud.nacos.server.addr</span>=<span class="string">localhost:8848</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>通过<code>Nacos</code>的后台可以看到成功地将服务注册到了<code>Nacos</code>上：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/1b00acd58cc84fbd945cac00c06fedc1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/2faaded4a346487c9657da82da90f82d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQ3JBY0tlUi0x,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>可以看到<code>Nacos</code>的后台比<code>Eureka</code>看起来更加清爽明了，看着就很舒服。输入：<code>http://localhost:8080/getAllOrders</code>验证服务发现，可以看到是可以正常访问的，表明服务发现没问题。启动各项服务，通过访问<code>URL</code>地址可以发现跟<code>Eureka</code>的功能是完全一样的，并且界面更加友好。</p>
<h3 id="9-3-Nacos分级存储模型"><a href="#9-3-Nacos分级存储模型" class="headerlink" title="9.3 Nacos分级存储模型"></a>9.3 <code>Nacos</code>分级存储模型</h3><p>此处<code>order-service:8080 user-service:8081 user-service:8082 user-service:8083</code>我们都可以称之为一个个实例，这样的实例可能在超大型项目中有成百上千个，可能在北京广州上海深圳杭州都存放着各个实例，当我们访问某项服务的时候肯定是访问距离最近的服务才是最快的，也正因此，<code>Nacos</code>可以引入集群，从而引出<code>Nacos</code>分级存储模型：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091928.png"></p>
<p>这样搞的目的就是为了：服务调用的时候尽可能选择本地集群中的服务，避免跨集群调用，因为这样延迟很高，只有在本地集群中需要的服务访问不了的时候再去访问其它集群。</p>
<h3 id="9-4-Nacos配置集群"><a href="#9-4-Nacos配置集群" class="headerlink" title="9.4 Nacos配置集群"></a>9.4 <code>Nacos</code>配置集群</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cloud.nacos.discovery.cluster-name</span>: <span class="string">Beijing</span></span><br></pre></td></tr></table></figure>

<p>直接复制多份<code>user-service</code>，将其加入到不同的集群 —&gt; <code>VM Options</code>：[三个集群 —&gt; 北京 深圳 杭州]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-Dserver.port=<span class="number">8082</span> -Dspring.cloud.nacos.discovery.cluster-name=Beijing</span><br><span class="line">-Dserver.port=<span class="number">8083</span> -Dspring.cloud.nacos.discovery.cluster-name=Shenzhen</span><br><span class="line">-Dserver.port=<span class="number">8084</span> -Dspring.cloud.nacos.discovery.cluster-name=Shenzhen</span><br><span class="line">-Dserver.port=<span class="number">8085</span> -Dspring.cloud.nacos.discovery.cluster-name=Hangzhou</span><br><span class="line">-Dserver.port=<span class="number">8086</span> -Dspring.cloud.nacos.discovery.cluster-name=Hangzhou    </span><br></pre></td></tr></table></figure>

<p>然后将<code>order-service</code>分别拉入到<code>Beijing Shenzhen Hangzhou</code>的集群中并分别访问<code>URL</code>，观察<code>IDEA</code>中显示的信息，可以发现都是访问集群里的服务，只有在集群中的服务挂掉的时候才去跨集群访问。【记得把上次设置的<code>RandomRule</code>给注释掉否则负载均衡策略会选择随机负载均衡。】</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/2ec0ce78a7d4438ea4d71f71cef81d95.png"></p>
<h3 id="9-5-Nacos配置负载均衡规则"><a href="#9-5-Nacos配置负载均衡规则" class="headerlink" title="9.5 Nacos配置负载均衡规则"></a>9.5 <code>Nacos</code>配置负载均衡规则</h3><p>第一种情况：<code>order-service</code>位于<code>Beijing</code>集群，访问<code>http://localhost:8080/order/103</code>，可以看到只会访问同时<code>Beijing</code>集群的两个<code>user-service</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/635ed404649c4d609f147ecf7027ed99.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/4740ff18f3874282b86f69194b36d8ff.png"></p>
<p>第二种情况：<code>order-service</code>位于<code>Shenzhen</code>集群，可以看到同样的效果，但是还访问了其它的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/e6073e8d15e14d1183a7d6c2496208b6.png"></p>
<p>第三种情况：<code>order-service</code>位于<code>Hangzhou</code>集群【跟上述一致】也是还访问了其它的</p>
<p>第四种情况：<code>order-service</code>位于<code>Hangzhou</code>集群，但是集群中的<code>user-service:8085 8086</code>挂掉了，也是访问了多个。</p>
<p>为什么会这样呢？原因是<code>Nacos</code>的默认负载均衡的策略就是轮询，如果我们要配置按地区查找，我们可以看到是一个个接着顺序访问的，如果要按地区轮询我们应该修改下配置类中的<code>Bean</code>。 —&gt; <code>order-service.configuration.MyConfiguration ---&gt; NacosRule</code>并且是在集群中随机选择服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">nacosRule</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NacosRule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时再去访问就是按照就近集群来访问，如果某个集群中所有服务都挂了，再去访问其它的集群服务，而且可以在日志中看到发生了跨集群访问。</p>
<p><strong>除了使用配置类还可以在配置文件中直接配置负载均衡规则：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user-service</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">ribbon</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName</span>: <span class="string">spring.cloud.nacos.ribbon.NacosRule</span></span><br></pre></td></tr></table></figure>

<h3 id="9-6-Nacos配置负载均衡权重配置【服务平滑升级】"><a href="#9-6-Nacos配置负载均衡权重配置【服务平滑升级】" class="headerlink" title="9.6 Nacos配置负载均衡权重配置【服务平滑升级】"></a>9.6 <code>Nacos</code>配置负载均衡权重配置【服务平滑升级】</h3><ol>
<li><code>Nacos</code>控制台可以设置实例的权重值，值在<code>0-1</code>之间</li>
<li>同个集群内的多个实例，权重越高被访问的频率越高</li>
<li>权重设置为<code>0</code>的时候则该服务将完全不被访问</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092020.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092026.png"></p>
<p><strong>合理配置权重可以做到平滑升级，比如：先把<code>user-service:8080</code>的权重调节为<code>0</code>让用户流向<code>user-service:8081</code>，等<code>user-service:8080</code>升级完成之后再将权重从<code>0</code>更改为<code>0.1</code>让一部分用户先体验升级版本，若稳定，再将权重上调。这就可以做到平滑升级。</strong></p>
<h3 id="9-7-Nacos环境隔离namespace"><a href="#9-7-Nacos环境隔离namespace" class="headerlink" title="9.7 Nacos环境隔离namespace"></a>9.7 <code>Nacos</code>环境隔离<code>namespace</code></h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092032.png"></p>
<p>首先想明白一个问题：为什么有了集群还要有<code>namespace</code>这样的东西呢？是不是觉得多此一举？其实不然。集群&#x2F;服务都是针对业务来进行划分的，而<code>namespace</code>命名空间是针对注入开发环境生产环境测试环境这样不同环境下诞生的产物。</p>
<p>这样我们就可以在不同环境下使用不同的集群、实例了。</p>
<p>而<code>Group</code>，就是不同环境下相关度比较高的业务，比如订单业务和支付业务是高度相关的，是概念上的划分，就可以把这两个业务都放到同一个<code>Group</code>中去，你可以使用也可以不使用。而<code>Service/Data</code>就是服务，再往下就是各个集群再往下就是实例了。</p>
<p>创建命名空间的步骤如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092038.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092050.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092059.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092114.png"></p>
<p>如何指定服务实例的命名空间？以<code>order-service</code>为例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.105</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">cluster-name:</span> <span class="string">Beijing</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">xxxxxx</span></span><br></pre></td></tr></table></figure>

<p><strong><font color="red">每个<code>namespace</code>都有不同的唯一<code>id</code>，并且·不同<code>namespace</code>之间相互隔离即不同<code>namespace</code>的服务互不可见。</font></strong></p>
<p>访问结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-08-14T12:34:04.243+00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">500</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Internal Server Error&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/order/103&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="9-8-Nacos注册中心的细节"><a href="#9-8-Nacos注册中心的细节" class="headerlink" title="9.8 Nacos注册中心的细节"></a>9.8 <code>Nacos</code>注册中心的细节</h3><p>相同点：</p>
<ul>
<li><strong><code>Nacos</code>和<code>Eureka</code>都支持服务注册和服务拉取</strong></li>
<li><strong>都支持服务提供者心跳方式做检测</strong></li>
</ul>
<p>不同点：</p>
<ul>
<li><p><strong><code>Nacos</code>存在临时和非临时实例</strong></p>
<ul>
<li><p><strong>临时实例：</strong></p>
<p>所有的实例在没有配置的时候都是临时实例，这个可以在控制台看到临时实例是<code>true</code>。每隔一段时间，临时实例需要主动去向注册中心报告我还活着，否则心跳检测不通过，<code>Nacos</code>会直接剔除掉该项服务。</p>
<p>对于临时实例，消费者是定时主动拉取服务。</p>
</li>
<li><p><strong>非临时实例：</strong></p>
<p><code>Nacos</code>主动去询问生产者【非临时实例】，并且主动推送变更消息到消费者。告诉消费者服务更新了，让其赶紧去更新。并且当非临时实例宕机的时候，也不会从服务列表中剔除。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">ephemeral:</span> <span class="literal">false</span> <span class="comment">#设置为非临时实例</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>学过<code>Zookeeper</code>的应该知道<code>CAP</code>不可能三角，<code>Nacos</code>集群<strong>默认采用AP方式(可用性)<strong>，当集群中存在非临时实例时，</strong>采用<code>CP</code>模式(一致性)<strong>；而</strong><code>Eureka</code>只采用<code>AP</code>方式</strong>，不可切换。</p>
</li>
</ul>
<hr/>

<h2 id="10-配置中心"><a href="#10-配置中心" class="headerlink" title="10. 配置中心"></a>10. 配置中心</h2><p>当微服务部署的实例越来越多的时候，达到上百上千个的时候，你自己去一个个的修改并且还需要重启服务器或是啥的，就非常令人感到恶心了。所以需要一种可以统一管理配置的地方，它不仅可以统一配置集中管理还可以实现更改配置后热更新。而这，正是配置中心所能完成的</p>
<h3 id="10-1-Nacos配置中心"><a href="#10-1-Nacos配置中心" class="headerlink" title="10.1 Nacos配置中心"></a>10.1 <code>Nacos</code>配置中心</h3><p><code>Nacos</code>非常强大，此前我们看到它可以作为注册中心使用，现在，你将再一次看到它的强大 —— 它可以作为配置中心使用。一方面：**<code>Nacos</code>可以配置集中管<strong>理，另一方面：</strong>可以在配置变更的时候及时通知微服务并实现配置的热更新**。</p>
<h3 id="10-2-Nacos创建配置"><a href="#10-2-Nacos创建配置" class="headerlink" title="10.2 Nacos创建配置"></a>10.2 <code>Nacos</code>创建配置</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092159.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092206.png"></p>
<p>默认直接就是热更新的，要实现热更新的配置才放到<code>Nacos</code>，否则还是放到本地中会比较好【比如数据库连接信息】。</p>
<h3 id="10-3-微服务读取Nacos配置中心配置"><a href="#10-3-微服务读取Nacos配置中心配置" class="headerlink" title="10.3 微服务读取Nacos配置中心配置"></a>10.3 微服务读取<code>Nacos</code>配置中心配置</h3><p>在没有配置中心的情况下，微服务读取配置的流程如下：读取本地的配置文件然后根据配置信息创建<code>Spring</code>容器，最后加载<code>Bean</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092215.png"></p>
<p>而当加入了诸如<code>Nacos</code>的配置中心之后，微服务会先去读取配置中心的配置，然后再读取本地的配置文件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092223.png"></p>
<p>正因为读取<code>Nacos</code>配置中心的配置文件在本地配置文件之前，如果你在本地配置文件中配置要读取配置中心的配置文件，那这样的配置根本不起效果。所以我们需要在别的地方做功夫。那就是比<code>Nacos</code>配置中心读取配置文件的优先级还要高的地方 —— <code>bootstrap.yml</code>文件【存放于本地】。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092228.png"></p>
<p>知道了微服务读取配置中心的配置流程，就可以做具体工作了：</p>
<ol>
<li><p>在需要读取配置中心的微服务中，引入<code>Nacos</code>配置中心依赖：【注意该版本有漏洞】</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>bootstrap.yml</code>文件：【**<font color="red">注意，这里的<code>spring.profiles.active</code>不是必须的，你只要<code>spring.application.name</code>对得上也是完全可以的</font>**】</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">order-service</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.105</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yml</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>本地微服务会先读取：<code>$&#123;spring.cloud.nacos.server-addr&#125;</code>中<code>Nacos</code>配置中心的地址，然后再通过读取<code>$&#123;spring.application.name&#125;</code>+<code>$&#123;spring.profiles.active&#125;</code>+<code>$&#123;spring.cloud.nacos.config.file-extension&#125;</code>形成文件名：<code>$&#123;spring.application.name&#125;-$&#123;spring.profiles.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</code>。将其作为<code>id</code>读取配置中心的配置。</p>
<p>在这里就会去读取在配置中心的：<code>order-service-dev.yml</code>。验证是否读取成功，验证如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.order.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(value = &quot;$&#123;pattern.dateformat&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String patternFormat;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/now&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(patternFormat));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/3938485837dc42aebebe38a013725d5c.png"></p>
<h3 id="10-4-Nacos配置中心实现热更新"><a href="#10-4-Nacos配置中心实现热更新" class="headerlink" title="10.4 Nacos配置中心实现热更新"></a>10.4 <code>Nacos</code>配置中心实现热更新</h3><p>实现热更新有两种方式，其原理我猜正是隔段时间自动去访问配置中心的配置：</p>
<ol>
<li><p>使用<code>@Value</code>读取配置时，搭配<code>@RefreshScope</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.order.configuration.MyConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyConfigurationProperties myConfigurationProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">queryOrderByUserId</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orderService.queryOrderById(orderId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = &quot;$&#123;pattern.dateformat&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String patternFormat;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/now&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(patternFormat));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>@ConfigurationProperties</code>读取配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.order.configuration.MyConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(value = &#123;MyConfigurationProperties.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyConfigurationProperties myConfigurationProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/now2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNow2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(myConfigurationProperties.getDateformat()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;pattern&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfigurationProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String dateformat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="10-5-Nacos配置中心环境共享"><a href="#10-5-Nacos配置中心环境共享" class="headerlink" title="10.5 Nacos配置中心环境共享"></a>10.5 <code>Nacos</code>配置中心环境共享</h3><p>前面有提到过说是<code>dev</code>环境即<code>spring.profile.active</code>不是必须的，那有跟没有的区别在于什么呢？就在于没有<code>dev</code>的不仅可以在<code>dev</code>环境中使用还可以在<code>product</code>生产环境中以及<code>test</code>测试环境中使用，<strong>这就形成了环境共享</strong>。</p>
<ol>
<li><p>修改表现层代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.order.configuration.MyConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(value = &#123;MyConfigurationProperties.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyConfigurationProperties myConfigurationProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/testShare&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getShare</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> myConfigurationProperties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更改配置类代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;pattern&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfigurationProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String dateformat;</span><br><span class="line">    <span class="keyword">private</span> String sharedvalue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制台添加：<code>order-service.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pattern:</span></span><br><span class="line"> <span class="attr">sharedvalue:</span> <span class="string">&quot;共享环境&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>copy configuration</code>复制一份服务器，修改<code>Profile Active</code>以及<code>VM Options: -Dserver.port=8081</code>然后启动服务器</p>
<p>分别查询：<code>http://localhost:8080/order/testShare</code>和<code>http://localhost:8081/order/testShare</code>获取到：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/5eeb3f828fb74e1092732ea160db0257.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/fad7eea538164619ad86af6fe714e9b8.png"></p>
<p>可以发现在<code>test</code>环境中无法获取到<code>order-service-dev.yml</code>配置文件中的<code>dateformat</code>，但是可以获取到<code>order-service.yml</code>配置文件中的配置信息。而<code>dev</code>环境二者都可以获取。这就说明了配置文件是可以指定环境，也可以不指定的，你说这是共享也行。</p>
</li>
</ol>
<ul>
<li><p>不用想也知道，<code>Nacos</code>配置中心配置的指定环境配置文件优先级是最高的，其次是无指定环境最后是本地。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092501.png"></p>
</li>
<li><p>那么问题来了？不同微服务之间是否也可以共享在<code>Nacos</code>配置中心的配置文件，当然可以，只需要更换名称，然后在不同的微服务之间的<code>bootstrap.yml</code>做个声明即可，该声明有两种方式：</p>
<ol>
<li>使用<code>extensionc-configs</code></li>
<li>使用<code>shared-configs</code></li>
</ol>
<p>比如：</p>
<p>在<code>order-service</code>中使用：<code>extension-configs</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">order-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">116.25</span><span class="number">.152</span><span class="number">.11</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yml</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">diffrentserviceshare.yml</span></span><br></pre></td></tr></table></figure>

<p>在<code>user-service</code>中使用：<code>shared-configs</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">116.25</span><span class="number">.152</span><span class="number">.11</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yml</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">diffrentserviceshare.yml</span></span><br></pre></td></tr></table></figure>

<p>在<code>Nacos</code>控制台中创建配置文件以及配置信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/27cb8d0aad5548ccbf143b6260af466b.png"></p>
<p>然后更改<code>order-service</code>跟<code>user-service</code>中的<code>MyConfigurationProperties.java</code>【没有就创建】：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.user.coniguration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;pattern&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfigurationProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String dateformat;</span><br><span class="line">    <span class="keyword">private</span> String sharedvalue;</span><br><span class="line">    <span class="keyword">private</span> String sharedservice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在表现层中读取即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testShare&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getShare</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> myConfigurationProperties;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后直接使用<code>Postman</code>进行验证：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/9b06d1636f784f21ad7ba6a22dbdb858.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/a8d9a9a91d454f21850b0759b52413ee.png"></p>
<p>可以看到两个不同服务之间通过<code>Nacos</code>以及在<code>bootstrap.yml</code>做的配置实现了数据共享。</p>
</li>
</ul>
<h3 id="10-6-搭建Nacos集群"><a href="#10-6-搭建Nacos集群" class="headerlink" title="10.6 搭建Nacos集群"></a>10.6 搭建<code>Nacos</code>集群</h3><ul>
<li><strong>想想为什么需要做<code>Nacos</code>集群？</strong></li>
<li><strong>我们知道<code>Nacos</code>是安装式的程序，有没有想过万一<code>Nacos</code>服务端挂了，那我们做的所有的微服务都将不可使用，所以为了实现<font color="red">高可用</font>防止危险情况，所以需要做<code>Nacos</code>集群 —&gt; 使用<code>Nginx</code>代理。</strong></li>
</ul>
<p>架构如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108181959897.png" alt="img"></p>
<p>其中包含<code>3</code>个<code>Nacos</code>节点，然后一个负载均衡器<code>Nginx</code>代理<code>3</code>个<code>Nacos</code>，我们计划的<code>Nacos</code>集群如下图，<code>MySQL</code>的主从复制后续再添加。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108182000220.png" alt="img"></p>
<p>三个<code>Nacos</code>节点的地址：</p>
<table>
<thead>
<tr>
<th align="left">节点&#96;</th>
<th align="left"><code>IP</code></th>
<th align="left">Port</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Nacos1</code></td>
<td align="left"><code>192.168.0.105</code></td>
<td align="left"><code>8845</code></td>
</tr>
<tr>
<td align="left"><code>Nacos2</code></td>
<td align="left"><code>192.168.0.105</code></td>
<td align="left"><code>8846</code></td>
</tr>
<tr>
<td align="left"><code>Nacos3</code></td>
<td align="left"><code>192.168.0.105</code></td>
<td align="left"><code>8847</code></td>
</tr>
</tbody></table>
<ol>
<li><p>初始化数据库：</p>
<p><code>Nacos</code>默认数据存储在内嵌数据库<code>Derby</code>中，不属于生产可用的数据库。官方推荐的最佳实践是使用带有主从的高可用数据库集群，主从模式的高可用数据库。这里我们以单点的数据库为例。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database nacos;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  `c_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_use` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `effect` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_schema` text,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_aggr   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_aggr` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `datum_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;datum_id&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;内容&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;增加租户字段&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_beta   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_beta` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `beta_ips` <span class="type">varchar</span>(<span class="number">1024</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;betaIps&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info_beta&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_tag   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_tag` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `tag_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_id&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info_tag&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_tags_relation   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_tags_relation` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `tag_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_name&#x27;</span>,</span><br><span class="line">  `tag_type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_type&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_tag_relation&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = group_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `group_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;Group ID，空字符表示整个集群&#x27;</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;配额，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;使用量&#x27;</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;聚合子配置最大个数，，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;最大变更历史数量&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_group_id` (`group_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;集群、各Group容量信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = his_config_info   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `his_config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">64</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `src_user` text,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `op_type` <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class="line">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">  KEY `idx_did` (`data_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;多租户改造&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = tenant_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;Tenant ID&#x27;</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;配额，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;使用量&#x27;</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;聚合子配置最大个数&#x27;</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;最大变更历史数量&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;租户容量信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `kp` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;kp&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `tenant_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_name&#x27;</span>,</span><br><span class="line">  `tenant_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tenant_desc&#x27;</span>,</span><br><span class="line">  `create_source` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create_source&#x27;</span>,</span><br><span class="line">  `gmt_create` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;tenant_info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `users` (</span><br><span class="line">	`username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">	`password` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`enabled` <span class="type">boolean</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `roles` (</span><br><span class="line">	`username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`role` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">UNIQUE</span> INDEX `idx_user_role` (`username` <span class="keyword">ASC</span>, `role` <span class="keyword">ASC</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `permissions` (</span><br><span class="line">    `role` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `action` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> INDEX `uk_role_permission` (`role`,`resource`,`action`) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (username, password, enabled) <span class="keyword">VALUES</span> (<span class="string">&#x27;nacos&#x27;</span>, <span class="string">&#x27;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;</span>, <span class="literal">TRUE</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> roles (username, role) <span class="keyword">VALUES</span> (<span class="string">&#x27;nacos&#x27;</span>, <span class="string">&#x27;ROLE_ADMIN&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>Nacos</code>，先配好一个然后复制多份即可：</p>
<p>进入<code>Nacos</code>的<code>conf</code>目录，修改配置文件<code>cluster.conf.example</code>，重命名为<code>cluster.conf</code>，注意在<code>Nacos 2.x</code>中会需要使用两个端口，所以如果你使用的是：<code>8845 8846 8847</code>连续的，则第二个会启动失败，所以这里最好是换成隔几个端口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">116.25.152.11:8850</span><br><span class="line">116.25.152.11:8860</span><br><span class="line">116.25.152.11:8870</span><br></pre></td></tr></table></figure>

<p>然后修改<code>application.properties</code>文件，添加数据库配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8850</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"><span class="attr">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">db.url.0</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="attr">db.user.0</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">db.password.0</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure>

<p>将该文件夹复制多问，并且更改每一个<code>Nacos</code>的<code>server .port</code></p>
</li>
<li><p>在各个<code>Nacos</code>启用<code>startup.cmd</code></p>
</li>
<li><p>安装<code>Nginx</code>然后在配置文件中进行如下配置<code>http</code>内部：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">nacos-cluster &#123;</span></span><br><span class="line">	<span class="attr">server</span> <span class="string">116.25.152.11:8850;</span></span><br><span class="line">	<span class="attr">server</span> <span class="string">116.25.152.11:8860;</span></span><br><span class="line">	<span class="attr">server</span> <span class="string">116.25.152.11:8870;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">	<span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">	<span class="attr">server_name</span>  <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">location</span> <span class="string">/nacos &#123;</span></span><br><span class="line">		<span class="attr">proxy_pass</span> <span class="string">http://nacos-cluster;</span></span><br><span class="line">	<span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动<code>Nginx</code>服务<code>start nginx.exe</code>，访问：<code>http://116.25.152.11:80</code>，看到如下页面说明所有配置均成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/351706d0cc00488181a7656fbdb4a0de.png" alt="img"></p>
</li>
<li><p>客户端若需要使用，只需修改配置端口和<code>IP</code>即可</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">116.25</span><span class="number">.152</span><span class="number">.11</span><span class="string">:80</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong><font color="red">实际部署时，需要给做反向代理的<code>Nginx</code>服务器设置一个域名，这样后续如果有服务器迁移<code>Nacos</code>的客户端也无需更改配置。<code>Nacos</code>的各个节点应该部署到多个不同服务器，做好容灾和隔离工作。</font></strong></p>
<h2 id="11-远程调用"><a href="#11-远程调用" class="headerlink" title="11. 远程调用"></a>11. 远程调用</h2><p>一直到这一部分，我们想远程调用都使用的是<code>RestTemplate</code>，我们再来看看使用<code>RestTemplate</code>进行远程调用的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://user-service/user/&quot;</span> + order.getUserId();</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(url, User.class);</span><br></pre></td></tr></table></figure>

<p>可以看到这样子的代码：</p>
<ul>
<li>可读性差</li>
<li>参数<code>URL</code>复杂难以维护</li>
</ul>
<p>为了更好用更方便更直观的调用想调用，所以我们决定采用<code>Feign</code>：其作用就是帮助我们**<font color="red">优雅的实现<code>http</code>请求的发送</font>**，解决上面提到的问题。<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/3cfd43ee11ea41f2ba33656ae801c5a0.png" alt="img"></p>
<h3 id="11-1-Feign"><a href="#11-1-Feign" class="headerlink" title="11.1 Feign"></a>11.1 <code>Feign</code></h3><h3 id="11-2-Feign实现远程调用"><a href="#11-2-Feign实现远程调用" class="headerlink" title="11.2 Feign实现远程调用"></a>11.2 <code>Feign</code>实现远程调用</h3><ol>
<li><p><code>order-service</code>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-feign --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置，这里直接使用注解<code>@EnableFeignClients</code>即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建要远程调用的接口：<code>order.client.UserClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.user.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;user-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable(value = &quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>UserClient</code>即可直接进行远程调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.order.client.UserClient;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.mapper.OrderMapper;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceFeign</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserClient userClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">queryOrderById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderMapper.findById(id);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.findById(order.getUserId());</span><br><span class="line">        order.setUser(user);</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建<code>Controller</code>进行验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.order.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.service.OrderServiceFeign;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController1</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderServiceFeign orderServiceFeign;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">queryOrderByUserId</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orderServiceFeign.queryOrderById(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>这样看来，<code>Feign</code>可比使用<code>RestTemplate</code>干净优雅多了。</p>
<h3 id="11-3-Feign自定义配置"><a href="#11-3-Feign自定义配置" class="headerlink" title="11.3 Feign自定义配置"></a>11.3 <code>Feign</code>自定义配置</h3><p><code>Feign</code>可以支持很多的自定义配置，如下表所示：</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">作用</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong><code>feign.Logger.Level</code></strong></td>
<td align="left">修改日志级别</td>
<td align="left">包含四种不同的级别：<code>NONE</code>、<code>BASIC</code>、<code>HEADERS</code>、<code>FULL</code></td>
</tr>
<tr>
<td align="left"><code>feign.codec.Decoder</code></td>
<td align="left">响应结果的解析器</td>
<td align="left"><code>http</code>远程调用的结果做解析，例如解析<code>json</code>字符串为<code>java</code>对象</td>
</tr>
<tr>
<td align="left"><code>feign.codec.Encoder</code></td>
<td align="left">请求参数编码</td>
<td align="left">将请求参数编码，便于通过<code>http</code>请求发送</td>
</tr>
<tr>
<td align="left"><code>feign.Contract</code></td>
<td align="left">支持的注解格式</td>
<td align="left">默认是<code>SpringMVC</code>的注解</td>
</tr>
<tr>
<td align="left"><code>feign.Retryer</code></td>
<td align="left">失败重试机制</td>
<td align="left">请求失败的重试机制，默认是没有，不过会使用<code>Ribbon</code>的重试</td>
</tr>
</tbody></table>
<p>一般需要配置的就是：<code>fegin.Logger.Level</code>日志，**默认的为<code>NONE</code>**。</p>
<ul>
<li><strong><code>NONE</code>：不记录任何日志信息，这是默认值。</strong></li>
<li><strong><code>BASIC</code>：仅记录请求的方法，<code>URL</code>以及响应状态码和执行时间</strong></li>
<li><strong><code>HEADERS</code>：在<code>BASIC</code>的基础上，额外记录了请求和响应的头信息</strong></li>
<li><strong><code>FULL</code>：记录所有请求和响应的明细，包括头信息、请求体、元数据</strong></li>
</ul>
<p>通过配置文件<code>application.yml</code>进行配置：【注意得先有配置信息：<code>logging.level.com.kk: debug</code>否则无效】</p>
<ol>
<li><p>可以针对某一个远程调用的服务进行配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">user-service:</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">FULL</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以对所有要远程调用的服务进行配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">FULL</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>通过代码进行自定义配置，同样分为全局和局部：</p>
<ol>
<li><p>声明一个<code>MyFeignConfiguration</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFeignConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLoggerLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.BASIC;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>全局配置 —&gt; <code>OrderApplication.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.order.configuration.MyFeignConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = &#123;MyFeignConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>局部配置 —&gt; <code>UserClient.interface</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.order.configuration.MyFeignConfiguration;</span><br><span class="line"><span class="keyword">import</span> com.kk.order.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;user-service&quot;, configuration = &#123;MyFeignConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable(value = &quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="11-4-Feign性能优化"><a href="#11-4-Feign性能优化" class="headerlink" title="11.4 Feign性能优化"></a>11.4 <code>Feign</code>性能优化</h3><p>首先了解下为什么要对<code>Feign</code>做性能优化？这就涉及到<code>Feign</code>的底层客户端是实现：默认采用<code>URLConnection</code>，但是它不支持连接池</p>
<p>其余还有两种：</p>
<ul>
<li><code>Apache HttpClient</code>：支持连接池</li>
<li><code>OKHttp</code>：支持连接池</li>
</ul>
<p>此外还有就是在上节学习到的日志，使用<code>NONE BASIC</code>即可，再往上<code>FULL HEADER</code>内容太多会影响性能。</p>
<p>这里使用<code>Apache HttpClient</code>作为更改客户端演示。</p>
<ol>
<li><p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--httpClient的依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">BASIC</span> <span class="comment">#日志级别为 BASIC</span></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#使用httpclient作为客户端</span></span><br><span class="line">    <span class="attr">max-connections:</span> <span class="number">200</span> <span class="comment">#连接池最大连接数量</span></span><br><span class="line">    <span class="attr">max-connections-per-route:</span> <span class="number">50</span> <span class="comment">#每个路径的最大连接数</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>找到<code>feign-core</code>核心包找到<code>FeignClientFactoryBean</code>中的<code>loadBalance</code>方法，打断点然后<code>Deubg</code>模式启动<code>order-service</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/3c8e61894ca54c649ba978ba2195ae7a.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/2e3e6afc87db467d906b205a89454058.png" alt="img"></p>
<p>可以看到此时<code>Feign</code>底层使用的就是<code>HttpClient</code>。</p>
</li>
</ol>
<h3 id="11-5-Feign最佳实践"><a href="#11-5-Feign最佳实践" class="headerlink" title="11.5 Feign最佳实践"></a>11.5 <code>Feign</code>最佳实践</h3><p>最佳实践：指的是企业经常会用到的一些方式</p>
<ul>
<li><p>继承方式：一样的代码可以通过继承来共享</p>
<ol>
<li>定义一个 API 接口，利用定义方法，并基于 SpringMVC 注解做声明</li>
<li>Feign 客户端、Controller 都集成该接口</li>
</ol>
<p>优点</p>
<ul>
<li>简单</li>
<li>实现了代码共享</li>
</ul>
<p>缺点</p>
<ul>
<li>服务提供方、服务消费方紧耦合</li>
<li>参数列表中的注解映射并不会继承，因此 Controller 中必须再次声明方法、参数列表、注解</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092803.png" alt="img"></p>
</li>
<li><p>抽取方式：将 FeignClient 抽取为独立模块，并且把接口有关的 pojo、默认的 Feign 配置都放到这个模块中，提供给所有消费者使用。</p>
<p>例如：将 UserClient、User、Feign 的默认配置都抽取到一个 feign-api 包中，所有微服务引用该依赖包，即可直接使用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092811.png" alt="img"></p>
</li>
</ul>
<p>这里使用第二种方式做一个演示：</p>
<ol>
<li><p>创建<code>feign-api</code>模块，引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>01-cloud-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>com.kk.pojo.User com.kk.clients.UserClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.clients;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;user-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时<code>feign-api</code>模块就创建好了，我们将在<code>order-service</code>的<code>User</code>以及<code>UserClient</code>删除，然后导入<code>feign-api</code>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>标红的地方导入包</p>
</li>
<li><p>当所需要的包不在<code>SpringApplication</code>扫描范围之内，这些<code>FeignClient</code>就不能使用。所以需要添加包在哪个位置：【否则服务无法正常启动】：<code>@EnableFeignClients(basePackages = &quot;com.kk.clients&quot;)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.kk.clients&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除此之外还可以指定字节码文件：<code>@EnableFeignClients(clients = UserClient.class)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.clients.UserClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients(clients = UserClient.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="12-Gateway网关"><a href="#12-Gateway网关" class="headerlink" title="12. Gateway网关"></a>12. <code>Gateway</code>网关</h2><p>有了服务集群，还晓得了注册中心、配置中心、远程调用。可是还有个大问题，就是你内部的许多服务有时候只对一些内部人员访问，并不是所有人都可以访问的，所以就需要有样东西可以给所有来访问服务的请求把把关。这就需要使用到<code>Getway</code>网关兄弟了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092857.png" alt="img"></p>
<h3 id="12-1-网关可以干什么"><a href="#12-1-网关可以干什么" class="headerlink" title="12.1 网关可以干什么"></a>12.1 网关可以干什么</h3><p>网关的核心功能特性【可以干什么】？</p>
<ul>
<li><strong>身份验证，权限校验</strong></li>
<li><strong>服务路由，负载均衡</strong></li>
<li><strong>请求限流</strong></li>
</ul>
<p>在<code>SpringCloud</code>中网关的实现包括两种：<code>Gateway</code>和<code>Zuul</code>。<code>Zuul</code>是基于<code>Servlet</code>实现的，属于阻塞式编程。而<code>Spring Cloud Gateway</code>则是基于<code>Spring5</code>中提供的<code>WebFlux</code>，属于响应式编程的实现，具备更好的性能。</p>
<h3 id="12-2-网关初步使用"><a href="#12-2-网关初步使用" class="headerlink" title="12.2 网关初步使用"></a>12.2 网关初步使用</h3><ol>
<li><p>创建<code>Gateway</code>模块，引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="comment">#网关端口</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment">#网关名称</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="comment">#Nacos 地址</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.105</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment">#网关路由配置</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">          <span class="comment">#路由 id，自定义【唯一即可，随便你写什么都可以】</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span></span><br><span class="line">          <span class="comment">#uri http://localhost:8081 路由的目标地址就是 http 固定地址，lb 就是负载均衡，后面跟着服务名称</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://user-service</span></span><br><span class="line">          <span class="comment">#路由断言，也就是判断请求是否符合路由规则的条件，按照路径匹配，以/user/开头就符合</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span></span><br></pre></td></tr></table></figure>

<p>将符合<code>Path</code>规则的一切请求都代理到<code>uri</code>参数指定的地址，上面的<code>application.yml</code>中我们将<code>/user/**</code>开头的请求全部代理到<code>lb://user-service</code>，其中的<code>lb</code>就是负载均衡即<code>LoadBalance</code>，根据服务名拉取服务列表，实现负载均衡。</p>
<p>简单点就是：本来我们访问<code>http://localhost:8081/user/1</code>是直接访问服务的，但是现在我们访问就需要经过网关了，所有的<code>/user/**</code>都会被网关所拦截 ，转发给<code>lb://user-service</code>。</p>
<p>如果你有多个<code>predicates</code>时候，请求需要同时满足全部才可以通过网关访问服务。</p>
<p>整个流程如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108220127419.png" alt="img"></p>
</li>
<li><p>访问网址：<code>http://localhost:10010/user/1</code></p>
<p>出错：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-08-15T13:17:15.228+00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/user/1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Service Unavailable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requestId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;02d4469c-2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>错误原因：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">由于springcloud2020弃用了Ribbon，因此Alibaba在2021版本nacos中删除了Ribbon的jar包，因此无法通过lb路由到指定微服务，出现了503情况。</span><br><span class="line">所以只需要引入springcloud loadbalancer包即可。</span><br></pre></td></tr></table></figure>

<p>解决办法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--客户端负载均衡loadbalancer--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>再次访问：可以正常访问</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;柳岩&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;湖南省衡阳市&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>总结下：路由配置需要配置如下几个方面</p>
<ol>
<li>路由<code>id</code>：<code>[user-service]</code>唯一标识，完全可以自定义，一般写跟注册中心的服务名称一样即可</li>
<li>路由目标<code>uri</code>：<code>[lb://user-service]</code>路由的目标地址，<code>http</code>代表固定地址，<code>lb</code>代表根据服务名负载均衡</li>
<li>路由断言<code>predicates</code>：其实就是判断路由的规则，符合规则就转发到路由目标<code>uri</code></li>
<li>路由过滤器<code>filters</code>：对请求或响应做处理</li>
</ol>
<h3 id="12-3-断言工厂"><a href="#12-3-断言工厂" class="headerlink" title="12.3 断言工厂"></a>12.3 断言工厂</h3><p>我们在配置文件中写的断言规则只是字符串，这些字符串会被<code>Predicate Factory</code>读取并处理，转变为路由判断的条件。比如在我们的案例中：<code>predicates: - Path=/user/**</code>就是一个规则，这些路由规则是被：<code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code>所处理的，像这样的断言工厂在<code>SpringCloud</code>中还有十几个。</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">名称</td>
<td align="left">说明</td>
<td align="left">示例</td>
</tr>
<tr>
<td align="left">After</td>
<td align="left">是某个时间点后的请求</td>
<td align="left"><code>- After=2037-01-20T17:42:47.789-07:00[America/Denver]</code></td>
</tr>
<tr>
<td align="left">Before</td>
<td align="left">是某个时间点之前的请求</td>
<td align="left"><code>- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</code></td>
</tr>
<tr>
<td align="left">Between</td>
<td align="left">是某两个时间点之前的请求</td>
<td align="left"><code>- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]</code></td>
</tr>
<tr>
<td align="left">Cookie</td>
<td align="left">请求必须包含某些cookie</td>
<td align="left"><code>- Cookie=chocolate, ch.p</code></td>
</tr>
<tr>
<td align="left">Header</td>
<td align="left">请求必须包含某些header</td>
<td align="left">- Header&#x3D;X-Request-Id, \d+</td>
</tr>
<tr>
<td align="left">Host</td>
<td align="left">请求必须是访问某个host（域名）</td>
<td align="left">- Host&#x3D;<code>**.somehost.org</code>, <code>**.anotherhost.org</code></td>
</tr>
<tr>
<td align="left">Method</td>
<td align="left">请求方式必须是指定方式</td>
<td align="left">- Method&#x3D;GET,POST</td>
</tr>
<tr>
<td align="left">Path</td>
<td align="left">请求路径必须符合指定规则</td>
<td align="left">- Path&#x3D;&#x2F;red&#x2F;{segment},&#x2F;blue&#x2F;**</td>
</tr>
<tr>
<td align="left">Query</td>
<td align="left">请求参数必须包含指定参数</td>
<td align="left">- Query&#x3D;name, Jack或者- Query&#x3D;name</td>
</tr>
<tr>
<td align="left"><code>RemoteAddr</code></td>
<td align="left">请求者的<code>ip</code>必须是指定范围</td>
<td align="left"><code>- RemoteAddr=192.168.1.1/24</code></td>
</tr>
<tr>
<td align="left">Weight</td>
<td align="left">权重处理</td>
<td align="left"></td>
</tr>
</tbody></table>
<blockquote>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories</a></p>
</blockquote>
<p>一般的，只需要掌握<code>Path</code>和各个规则的意思基本就可以应对各种工作场景了。</p>
<p>比如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">After=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>

<p>当前为<code>2022</code>年，根本不到<code>2031</code>年所以这个路由根本就不会被转发到<code>uri</code>路由目标中。可以看到访问结果为：<code>404</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-08-15T13:36:10.943+00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/user/1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">404</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Not Found&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requestId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;e617f3ca-1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="12-4-过滤器工厂"><a href="#12-4-过滤器工厂" class="headerlink" title="12.4 过滤器工厂"></a>12.4 过滤器工厂</h3><p><code>GatewayFilter</code>是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108220133487.png" alt="img"></p>
<p><code>Spring</code>提供了<code>31</code>种不同的路由过滤器工厂。</p>
<blockquote>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories</a></p>
</blockquote>
<p>经常使用的过滤器有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>名称</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>AddRequestHeader</code></td>
<td align="left">给当前请求添加一个请求头</td>
</tr>
<tr>
<td align="left"><code>RemoveRequestHeader</code></td>
<td align="left">移除请求中的一个请求头</td>
</tr>
<tr>
<td align="left"><code>AddResponseHeader</code></td>
<td align="left">给响应结果中添加一个响应头</td>
</tr>
<tr>
<td align="left"><code>RemoveResponseHeader</code></td>
<td align="left">从响应结果中移除有一个响应头</td>
</tr>
<tr>
<td align="left"><code>RequestRateLimiter</code></td>
<td align="left">限制请求的流量</td>
</tr>
</tbody></table>
<p>下面以<code>AddRequestHeader</code>作为演示范例演示一遍：</p>
<p><strong>需求</strong>：给所有进入<code>user-service</code>的请求添加一个请求头：<code>sign=kk.com is eternal</code>，只需要修改<code>gateway</code>服务的<code>application.yml</code>文件，添加路由过滤即可</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="comment">#网关端口</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment">#网关名称</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="comment">#Nacos 地址</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.104</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment">#网关路由配置</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">          <span class="comment">#路由 id，自定义【唯一即可】</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span></span><br><span class="line">          <span class="comment">#uri http://localhost:8081 路由的目标地址就是 http 固定地址，lb 就是负载均衡，后面跟着服务名称</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://user-service</span></span><br><span class="line">          <span class="comment">#路由断言，也就是判断请求是否符合路由规则的条件，按照路径匹配，以/user/开头就符合</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span></span><br><span class="line">            <span class="comment">#- After=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestHeader=sign,</span> <span class="string">kk.com</span> <span class="string">is</span> <span class="string">eternal</span></span><br></pre></td></tr></table></figure>

<p>验证时，可以使用<code>@RequestHeader</code>获取请求参数，可以在<code>user-service</code>的<code>controller</code>中看是否可以提取：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.user.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kk.user.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.kk.user.service.UserService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController2</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">queryById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id, <span class="meta">@RequestHeader(value = &quot;sign&quot;, required = false)</span> String sign)</span> &#123;</span><br><span class="line">        log.warn(sign);</span><br><span class="line">        <span class="keyword">return</span> userService.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<code>http://localhost:10010/user/1</code>观察结果，可以看到控制台中有<code>warn</code>信息显示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/770b684a2da644a89b37d8be50735c04.png" alt="img"></p>
<p>若想全局过滤路由，<code>SpringGateway</code>也是可以实现的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=sign,</span> <span class="string">kk.com</span> <span class="string">is</span> <span class="string">eternal</span></span><br></pre></td></tr></table></figure>

<ul>
<li>过滤器的作用就是对路由的请求跟响应做处理，比如添加一个请求头</li>
<li>配置在路由下的过滤器只能对当前的路由做过滤，想要全局配置也是可以的使用<code>spring.cloud.gateway.default-filters</code></li>
</ul>
<h3 id="12-5-全局过滤器"><a href="#12-5-全局过滤器" class="headerlink" title="12.5 全局过滤器"></a>12.5 全局过滤器</h3><p>上面的<code>SpringGateway</code>虽然很好用而且也有全局过滤<code>default-filters</code>，并且提供了<code>31</code>之多，但是这些东西都是别人固定好的，有时候我们想实现自己的一些路由过滤规则就很难受。于是就冒出了个全局过滤器<code>GlobalFilter</code>，<strong>它也可以做到拦截请求，但不同的时它可以做自己的业务逻辑即自定义。</strong></p>
<p><strong>需求</strong>：定义全局过滤器，拦截请求，判断请求的参数是否满足下面条件</p>
<ul>
<li>参数中是否有<code>authorization</code></li>
<li><code>authorization</code>参数值是否为<code>admin</code></li>
</ul>
<p>记得添加<code>@Component</code>将该全局过滤器交由<code>Spring</code>容器管理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.gateway.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//获取第一个匹配的 authorization 参数即可</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authorization</span> <span class="operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="comment">//对参数进行判断，如果是 admin 就放行，否则不放行</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(authorization)) <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        <span class="comment">//设置状态码，拦截返回</span></span><br><span class="line">        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置过滤器优先级，值越低优先级越高 ---&gt; 也可以使用 <span class="doctag">@Order</span> 注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问网址：<code>http://localhost:10010/user/1?authorization=admin111</code>和<code>http://localhost:10010/user/1?authorization=admin</code>验证即可。</p>
<h3 id="12-6-过滤器顺序"><a href="#12-6-过滤器顺序" class="headerlink" title="12.6 过滤器顺序"></a>12.6 过滤器顺序</h3><p>请求进入网关会碰到三类过滤器：<code>DefaultFilter</code>、当前路由的过滤器、<code>GlobalFilter</code>。</p>
<p>请求路由后，会将三者合并到一个<strong>过滤器链（集合）</strong>中，排序后依次执行每个过滤器。</p>
<p>排序规则如下：</p>
<ul>
<li>每一个过滤器都必须指定一个 int 类型的 order 值，<strong>order 值越小，优先级越高，执行顺序越靠前</strong>。</li>
<li><code>GlobalFilter</code>通过实现<code>Ordered</code>接口，或者使用<code>@Order</code>注解来指定<code>order</code>值，由我们自己指定。</li>
<li>路由过滤器和<code>defaultFilter</code>的<code>order</code>由<code>Spring</code>指定，<strong>默认是按照声明顺序从1递增</strong>。</li>
<li>当过滤器的<code>orde</code>值一样时，<strong>会按照<code> defaultFilter</code>&gt; 路由过滤器 &gt; <code>GlobalFilter</code>的顺序执行</strong>。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108230002747.png" alt="img"></p>
<h3 id="12-7-跨域问题"><a href="#12-7-跨域问题" class="headerlink" title="12.7 跨域问题"></a>12.7 跨域问题</h3><p>什么是跨域？跨域就是域名不一致，主要包括：</p>
<ul>
<li>域名不同：比如<code>www.baidu.com</code>跟<code>www.baidu.org</code>的域名就是不一样的，再或者<code>www.jd.com</code>跟<code>www.miaosha.jd.com</code>也是不一样的</li>
<li>域名相同，端口不同：比如<code>www.baidu.com:1111</code>跟<code>www.baidu.com:2222</code></li>
</ul>
<p>**<font color="red">跨域问题是浏览器这边限制下产生的问题：浏览器禁止请求的发起者与服务端发生跨域<code>Ajax</code>请求，请求被浏览器拦截。</font>**即：浏览器 + <code>Ajax</code></p>
<p><strong>解决方案：<code>CROS</code></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span> <span class="comment"># 全局的跨域处理</span></span><br><span class="line">        <span class="attr">add-to-simple-url-handler-mapping:</span> <span class="literal">true</span> <span class="comment"># 网关特有，解决options请求被拦截问题，询问让不让访问</span></span><br><span class="line">        <span class="attr">corsConfigurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="comment"># 允许哪些网站的跨域请求 allowedOrigins: “*” 允许所有网站</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;http://localhost:8090&quot;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span> <span class="comment"># 允许的跨域ajax的请求方式</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;GET&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;POST&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;DELETE&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;PUT&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;OPTIONS&quot;</span></span><br><span class="line">            <span class="attr">allowedHeaders:</span> <span class="string">&quot;*&quot;</span> <span class="comment"># 允许在请求中携带的头信息</span></span><br><span class="line">            <span class="attr">allowCredentials:</span> <span class="literal">true</span> <span class="comment"># 是否允许携带cookie</span></span><br><span class="line">            <span class="attr">maxAge:</span> <span class="number">360000</span> <span class="comment"># 这次跨域检测的有效期，浏览器将在该有效期内不再发送请求，直接使用</span></span><br></pre></td></tr></table></figure>

<p>验证：</p>
<ol>
<li><p>创建<code>index.html</code> —&gt; 很简单的功能，就是用<code>axios</code>发生<code>Ajax</code>请求【此时服务端先别配置上述<code>CROS</code>】</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/axis/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    axios.<span class="title function_">get</span>(<span class="string">&quot;http://localhost:10010/user/1?authorization=admin&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">then</span>(<span class="function"><span class="params">resp</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(resp.<span class="property">data</span>))</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err))</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启用服务，查看控制台，<code>vscode</code>可以使用<code>--liver-server</code>，可以看到出现了跨越问题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/62eaf29ef693434aa0af3e12696db535.png" alt="img"></p>
</li>
<li><p>添加如下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span> <span class="comment"># 全局的跨域处理</span></span><br><span class="line">        <span class="attr">add-to-simple-url-handler-mapping:</span> <span class="literal">true</span> <span class="comment"># 网关特有，解决options请求被拦截问题，询问让不让访问</span></span><br><span class="line">        <span class="attr">corsConfigurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="comment"># 允许哪些网站的跨域请求 allowedOrigins: “*” 允许所有网站</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;http://localhost:8090&quot;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span> <span class="comment"># 允许的跨域ajax的请求方式</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;GET&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;POST&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;DELETE&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;PUT&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;OPTIONS&quot;</span></span><br><span class="line">            <span class="attr">allowedHeaders:</span> <span class="string">&quot;*&quot;</span> <span class="comment"># 允许在请求中携带的头信息</span></span><br><span class="line">            <span class="attr">allowCredentials:</span> <span class="literal">true</span> <span class="comment"># 是否允许携带cookie</span></span><br><span class="line">            <span class="attr">maxAge:</span> <span class="number">360000</span> <span class="comment"># 这次跨域检测的有效期，浏览器将在该有效期内不再发送请求，直接使用</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>再访问时就可以解决跨域问题了，这个会<code>CV</code>大法即可</p>
</li>
</ol>
<h2 id="13-Docker"><a href="#13-Docker" class="headerlink" title="13. Docker"></a>13. <code>Docker</code></h2><h2 id="14-MessageQueue"><a href="#14-MessageQueue" class="headerlink" title="14. MessageQueue"></a>14. <code>MessageQueue</code></h2><h3 id="14-1-同步通讯和异步通讯"><a href="#14-1-同步通讯和异步通讯" class="headerlink" title="14.1 同步通讯和异步通讯"></a>14.1 同步通讯和异步通讯</h3><ul>
<li><p>同步通讯：就像打电话，需要实时响应。</p>
</li>
<li><p>异步通讯：就像发邮件，不需要马上回复。</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904133345.png" alt="img"></p>
<p>两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。</p>
<p>之前学习的<code>Feign</code>调用就属于同步方式，虽然调用可以实时得到结果，但是存在以下问题：<strong>耦合度高、性能下降、资源浪费、级联失败</strong>。<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904133517.png" alt="img"></p>
<p><strong>同步调用的优点</strong>：时效性较强，可以实时得到结果。</p>
<p><strong>同步调用的缺点</strong>：业务代码<strong>耦合度高</strong>、一旦某个业务出现错误则整个系统都出现错误【<strong>级联失败</strong>】，需要等待调用业务完成才可以完成业务等待时间长【<strong>性能下降</strong>】，等待的时间业务仍然占用着<code>CPU</code>资源这就肯定会造成【<strong>资源浪费</strong>】。同步调用的缺点即有：<strong>耦合度高、性能下降、资源浪费、级联失败</strong>。</p>
<p><strong><font color="deepskyblue">所以为了解决同步调用：耦合度高、级联失败、性能下降、资源浪费的问题，异步调用方案就出现了。</font></strong></p>
<p>以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。在事件模式中，支付服务是事件发布者<code>publisher</code>，在支付完成之后只需要发布一个支付成功的事件<code>event</code>，事件中带上订单<code>id</code>。订单服务和物流服务是事件订阅者<code>Consumer</code>，订阅支付成功的事件，监听到事件后完成自己的业务即可。最开始是当发布者发布消息的时候，直接从线程池中拿线程来用，但是如果流量爆满，线程池中的线程总有不够用的一天，这会导致内存爆满。</p>
<p>这就是异步调用，于是为了解决异步调用线程池数量问题，就引出了**<font color="red">消息队列</font>**。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904145001.png" alt="img"></p>
<p>就是说为了解决发布者和订阅者之间的耦合度以及异步处理。中间搞了一个<code>Broker</code>，这就大大降低了系统耦合度。除了拥有<strong>系统解耦</strong>、<strong>异步处理</strong>，除此之外，<code>Broker</code>即<code>MQ</code>它还可以对过往流量进行监控，并且适当的削峰，即<strong>流量削峰</strong>、<strong>流量监控</strong>，并且对来去的消息进行<strong>消息收集</strong>和<strong>消息广播</strong>，而且还满足<strong>最终一致性</strong>即不管发布者发来什么，要消费的订阅者都会从消息队列中取数据，生产者无需管也无需担心自己发的消息没有被消费的问题。</p>
<p>总结下就是：<strong>异步处理、系统解耦、流量削峰、流量监控、消息广播、消息收集、最终一致性</strong>。</p>
<p><strong>但很明显，这样的架构变复杂了，而且你的消息队列必须做得非常安全可靠，并且支持高并发高可用。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904144714.png" alt="img"></p>
<p><strong>大多数时候，我们并不需要多线程异步处理的需求，而是追求时效性，所以大多数还是使用的是同步通讯。</strong></p>
<h3 id="14-2-消息队列"><a href="#14-2-消息队列" class="headerlink" title="14.2 消息队列"></a>14.2 消息队列</h3><p>比较常见的<code>MQ</code>实现：<code>ActiveMQ</code>、<code>RabbitMQ</code>、<code>RocketMQ</code>、<code>Kafka</code>。若是有海量数据不太关心数据安全性的果断选择<code>Kafka</code>。若需要自己做定制可以使用<code>RokcetMQ</code>大多数时候选择<code>RabbitMQ</code>即可。</p>
<table>
<thead>
<tr>
<th align="left"><strong><code>RabbitMQ</code></strong></th>
<th align="left"><strong><code>ActiveMQ</code></strong></th>
<th align="left"><strong><code>RocketMQ</code></strong></th>
<th align="left"><strong><code>Kafka</code></strong></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="left">公司&#x2F;社区</td>
<td align="left"><code>Rabbit</code></td>
<td align="left"><code>Apache</code></td>
<td align="left">阿里</td>
<td><code>Apache</code></td>
</tr>
<tr>
<td align="left">开发语言</td>
<td align="left"><code>Erlang</code></td>
<td align="left"><code>Java</code></td>
<td align="left"><code>Java</code></td>
<td><code>Scala&amp;Java</code></td>
</tr>
<tr>
<td align="left">协议支持</td>
<td align="left"><code>AMQP、XMPP、SMTP、STOMP</code></td>
<td align="left"><code>OpenWire、STOMP、REST、XMPP、AMQP</code></td>
<td align="left">自定义协议</td>
<td>自定义协议</td>
</tr>
<tr>
<td align="left">可用性</td>
<td align="left">高</td>
<td align="left">一般</td>
<td align="left">高</td>
<td>高</td>
</tr>
<tr>
<td align="left">单机吞吐量</td>
<td align="left">一般</td>
<td align="left">差</td>
<td align="left">高</td>
<td>非常高</td>
</tr>
<tr>
<td align="left">消息延迟</td>
<td align="left">微秒级</td>
<td align="left">毫秒级</td>
<td align="left">毫秒级</td>
<td>毫秒以内</td>
</tr>
<tr>
<td align="left">消息可靠性</td>
<td align="left">高</td>
<td align="left">一般</td>
<td align="left">高</td>
<td>一般</td>
</tr>
</tbody></table>
<p>有没想过为什么<code>RabbitMQ</code>的消息延迟可以做到微秒级？这正是因为<code>RabbitMQ</code>是基于<code>Erlang</code>语言开发的。</p>
<ul>
<li>它是 一款专门为交换机软件开发的语言，而且是分布式的面向并发的。</li>
<li><code>Erlang</code>可以做到进程间上下文切换效率远高于<code>C</code>语言。</li>
<li><code>Erlang</code>还有者跟原生<code>Socket</code>一样的延迟。</li>
<li><code>Erlang</code>是虚拟机解释运行的语言所以可以跨平台部署<code>RabbitMQ</code>。</li>
</ul>
<h3 id="14-3-使用Docker安装RabbitMQ"><a href="#14-3-使用Docker安装RabbitMQ" class="headerlink" title="14.3 使用Docker安装RabbitMQ"></a>14.3 使用<code>Docker</code>安装<code>RabbitMQ</code></h3><ol>
<li><p>拉取<code>RabbitMQ</code>镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rabbitmq:3-management</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行<code>RabbitMQ</code>容器，用户名：<code>admin</code>，密码：<code>123456</code>，容器名：<code>RabbitmqContainer</code>，服务端口<code>5672</code>，<code>web</code>管理端口<code>15672</code>，主机名：<code>mq1</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=123456 --name RabbitMQContainer --hostname rabbitmq -p 15672:15672 -p 5672:5672 -d rabbitmq:3-management</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>VirtualBox</code>配置端口映射<code>15672</code>然后访问地址：<code>http://192.168.56.1:15672</code>即可</p>
</li>
</ol>
<h3 id="14-4-RabbitMQ中的角色及其基本结构"><a href="#14-4-RabbitMQ中的角色及其基本结构" class="headerlink" title="14.4 RabbitMQ中的角色及其基本结构"></a>14.4 <code>RabbitMQ</code>中的角色及其基本结构</h3><ul>
<li><code>publisher</code>：生产者【寄件人】</li>
<li><code>consumer</code>：消费者【收件人】</li>
<li><code>exchange</code>：交换机，负责消息路由【快件分拨中心】</li>
<li><code>queue</code>：队列，存储消息【丰巢快递柜】</li>
<li><code>virtualHost</code>：虚拟主机，<strong>隔离不同租户</strong>的<code>exchange</code>、<code>queue</code>、消息隔离</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904172912.png" alt="img"></p>
<h3 id="14-5-RabbitMQ的底层实现原理：AMQP协议"><a href="#14-5-RabbitMQ的底层实现原理：AMQP协议" class="headerlink" title="14.5 RabbitMQ的底层实现原理：AMQP协议"></a>14.5 <code>RabbitMQ</code>的底层实现原理：<code>AMQP</code>协议</h3><ul>
<li>协议就是规范，而<code>AMQP</code>协议就是<code>RabbitMQ</code>的规范，规定了<code>RabbitMQ</code>的对外接口。</li>
<li>学习<code>RabbitMQ</code>本质就是学习<code>AMQP</code>协议。</li>
</ul>
<blockquote>
<ol>
<li>生产者生产消息然后贴上<code>Routing Key</code>路由键，这个路由键就相当于快递的收件地址<code>Queue</code>。</li>
<li>这个快递到快递分拨中心的路程我们称其为<code>Connection</code>连接。因为去往快递分拨中心肯定不止一个快递，也许有好多好多个快递正在赶往快递分拨中心，这一条条到快递分拨中心的我们称其为<code>Channel</code>叫做一条条信道。</li>
<li>然后快递就到快递分拨中心这里，快递分拨中心在消息中间件里头叫做<code>exchange</code>就是交换机的意思。</li>
<li>到了快递分拨中心以后，快递分拨中心要将快递分拨中心跟收件地址进行绑定不然快递员不知道从哪里拿快递，然后快递员就可以快递到收件地址<code>Queue</code>可以是蜂巢，也可以是菜鸟驿站。</li>
<li>随后消费者就可以从菜鸟驿站中取出快递拿来消费使用了。</li>
<li>消费者拿快递的通道跟生产者的一样，去往队列的路有好多条，而且此时肯定同时也有好多消费者正在前往拿快递的路上，所以就会有多个信道，这些信道放到一块就组成了连接。【连接其实使用的就是<code>TCP</code>连接】</li>
<li>整个快递系统起主导作用的就是消息中间件，这里称呼为<code>Message Broker</code>用于接收和分发快递。</li>
<li>因为一个<code>Broker</code>快递系统忙不过来，所以这个大大的<code>Message Broker</code>就创建了好多<code>Virtual Host</code>，就是虚拟<code>Broker</code>，将多个单元隔开。</li>
</ol>
</blockquote>
<p>整个快递系统最核心的组件就是：快递分拨中心 —&gt; <code>Exchange</code>交换机 —&gt; 它承担了非常重要的功能即<code>RabbitMQ</code>的核心功能 —&gt; <strong>路由转发</strong>：<code>Exchange</code>根据路由键<code>Routing Key</code>和绑定关系<code>Binding Key</code>为消息提供路由，将消息转发至相应队列。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/9f0e5d464ed5452a89cf95226dd8ad50.png"></p>
<h3 id="14-6-RabbitMQ官方模型介绍"><a href="#14-6-RabbitMQ官方模型介绍" class="headerlink" title="14.6 RabbitMQ官方模型介绍"></a>14.6 <code>RabbitMQ</code>官方模型介绍</h3><p><code>RabbitMQ</code>官方提供了<code>5</code>个不同的<code>Demo</code>示例，对应了不同的消息模型。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904173739.png" alt="img"></p>
<h3 id="14-7-RabbitMQ官方API实现HelloWorld模型"><a href="#14-7-RabbitMQ官方API实现HelloWorld模型" class="headerlink" title="14.7 RabbitMQ官方API实现HelloWorld模型"></a>14.7 <code>RabbitMQ</code>官方<code>API</code>实现<code>HelloWorld</code>模型</h3><p>非常非常简单的发布订阅模型，就是发布者将消息发布到队列中然后消费者从队列中取出消息进行消费。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904200637.png" alt="img"></p>
<p>官方的<code>HelloWorld</code>是基于最基础的消息队列模型来实现的，只包括三个角色：</p>
<ul>
<li><code>publisher</code>：消息发布者，将消息发送到队列<code>queue</code></li>
<li><code>queue</code>：消息队列，负责接受并缓存消息</li>
<li><code>consumer</code>：订阅队列，处理队列中的消息</li>
</ul>
<p>使用<code>RabbitMQ</code>官方提供的<code>API</code>即可实现这一模型：</p>
<ol>
<li><p>引入依赖主要就是<code>spring-boot-starter-amqp</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>message-queue-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>02-message-queue-demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>02-message-queue-demo<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建发布者测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.publisher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PCTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">HelloWorldTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;192.168.56.1&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.创建连接通道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">//4.创建队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;hello.world.queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//5.发布消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Hello World Type RabbitMQ&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">        <span class="comment">//6.关闭通道，关闭连接</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试类，然后观察<code>http://192.168.56.1:15672/#/queues</code>中的队列情况。</p>
</li>
<li><p>创建消费者测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.publisher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PCTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">HelloWorldTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;192.168.56.1&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.创建连接通道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">//4.创建队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;hello.world.queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//5.发布消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Hello World Type RabbitMQ&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">        <span class="comment">//6.关闭通道，关闭连接</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试类，然后观察<code>http://192.168.56.1:15672/#/queues</code>中的队列情况以及控制台消息，可以看到控制台中打印了消息并且消息队列中的消息被消费了。</p>
</li>
</ol>
<h3 id="14-8-SpringAMQP实现发布订阅模型"><a href="#14-8-SpringAMQP实现发布订阅模型" class="headerlink" title="14.8 SpringAMQP实现发布订阅模型"></a>14.8 <code>SpringAMQP</code>实现发布订阅模型</h3><p><code>SpringAMQP</code>是基于<code>RabbitMQ</code>封装的一套模板，并且还利用 <code>SpringBoot</code>对其实现了自动装配，使用起来非常方便。<code>SpringAMQP</code>的官方地址：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-amqp%E3%80%82">https://spring.io/projects/spring-amqp。</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904202046.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904202056.png" alt="img"></p>
<p><code>SpringAMQP</code>提供了三个功能：</p>
<ul>
<li>自动声明队列、交换机及其绑定关系</li>
<li>基于注解的监听器模式，异步接收消息</li>
<li>封装了<code>RabbitTemplate</code>工具，用于发送消息</li>
</ul>
<h4 id="14-8-1-Hello-World"><a href="#14-8-1-Hello-World" class="headerlink" title="14.8.1 Hello-World"></a>14.8.1 <code>Hello-World</code></h4><p>使用<code>Spring AMQP</code>实现<code>Hello-World</code>发布订阅模型：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904211238.png" alt="img"></p>
<ol>
<li><p>消费者和生产者都需要引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>消费者和生产者都需要修改配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生产者使用<code>RabbitTemplate</code>发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.publisher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringAMQPTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimple</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;hello.world.queue&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;人类毁于傲慢。&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(queueName, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者监听消费：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;hello.world.queue&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimple</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="14-8-2-Work-Queue"><a href="#14-8-2-Work-Queue" class="headerlink" title="14.8.2 Work-Queue"></a>14.8.2 <code>Work-Queue</code></h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904211238.png" alt="img"></p>
<p>使用<code>Spring AMQP</code>实现<code>Work-Queue</code>发布订阅模型：</p>
<p><code>Work queues</code>，也被称为<code>（Task queues）</code>，任务模型。简单来说就是<strong>让多个消费者绑定到一个队列，共同消费队列中的消息【轮询消费】</strong>。</p>
<p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。此时就可以使用<code>work</code>模型，多个消费者共同处理消息处理，速度就能大大提高了。</p>
<ol>
<li><p>声明一个队列：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">workQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;work.queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建生产者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWork</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;work.queue&quot;</span>;</span><br><span class="line">       <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;世界人民 --- &quot;</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">           rabbitTemplate.convertAndSend(queueName, (message + i));</span><br><span class="line">           Thread.sleep(<span class="number">20</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 创建消费者：</span><br><span class="line"></span><br><span class="line">   ```java</span><br><span class="line">   <span class="keyword">package</span> com.kk.consumer;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line">   <span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Component</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConsumer</span> &#123;</span><br><span class="line">       <span class="meta">@RabbitListener(queues = &#123;&quot;hello.world.queue&quot;&#125;)</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimple</span><span class="params">(String message)</span> &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;消费者消费消息：&quot;</span> + message);</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="meta">@RabbitListener(queues = &#123;&quot;work.queue&quot;&#125;)</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWork1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;消费者...1...消费消息：&quot;</span> + message);</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="meta">@RabbitListener(queues = &#123;&quot;work.queue&quot;&#125;)</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWork2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;消费者...2...消费消息：&quot;</span> + message);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>启动测试、消费者项目，可以看到不同的消费者轮询消费队列中的消息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">消费者...2...消费消息：世界人民 --- 0</span><br><span class="line">消费者...1...消费消息：世界人民 --- 1</span><br><span class="line">消费者...2...消费消息：世界人民 --- 2</span><br><span class="line">消费者...1...消费消息：世界人民 --- 3</span><br><span class="line">消费者...2...消费消息：世界人民 --- 4</span><br><span class="line">消费者...1...消费消息：世界人民 --- 5</span><br><span class="line">消费者...2...消费消息：世界人民 --- 6</span><br><span class="line">消费者...1...消费消息：世界人民 --- 7</span><br><span class="line">消费者...2...消费消息：世界人民 --- 8</span><br><span class="line">消费者...1...消费消息：世界人民 --- 9</span><br><span class="line">消费者...2...消费消息：世界人民 --- 10</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>这样的消费者轮询消费并没有考虑到不同消费者可能存在不同的处理能力。<code>RabbitMQ</code>默认有一个消息预取机制，还没消费就会预取下一个消息到下一个消费者手中，通过<code>prefetch</code>可以实现限制每次只能取1条消息，消费完毕后才能取下一个消息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><code>Work</code>模型的使用：</p>
<ul>
<li>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理</li>
<li>通过设置<code>prefetch</code>来控制消费者预取的消息数量</li>
</ul>
<h4 id="14-8-3-Fanout"><a href="#14-8-3-Fanout" class="headerlink" title="14.8.3 Fanout"></a>14.8.3 <code>Fanout</code></h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904213455.png" alt="img"></p>
<p>图中可以看到，在订阅模型中，多了一个<code>exchange</code>角色，而且过程略有变化</p>
<ul>
<li><code>Publisher</code>：生产者，也就是要发送消息的程序，但是不再发送到队列中，<strong>而是发给<code>exchange</code>（交换机）</strong></li>
<li><code>Consumer</code>：消费者，与以前一样，订阅队列，没有变化</li>
<li><code>Queue</code>：消息队列也与以前一样，接收消息、缓存消息</li>
<li><code>Exchange</code>：交换机，一方面，接收生产者发送的消息；另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于<code>Exchange</code>的类型。<code>Exchange</code>有以下<code>3</code>种类型：<ul>
<li><code>Fanout</code>：广播，将消息交给所有绑定到交换机的队列</li>
<li><code>Direct</code>：定向，把消息交给符合指定<code>routing key</code>的队列</li>
<li><code>Topic</code>：通配符，把消息交给符合<code>routing pattern</code>（路由模式） 的队列</li>
</ul>
</li>
</ul>
<p><strong><code>Exchange</code>（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与<code>Exchange</code>绑定，或者没有符合路由规则的队列，那么消息会丢失！</p>
<p><code>Fanout</code>，英文翻译是扇出，在<code>MQ</code>中我们也可以称为广播。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912160350.png" alt="img"></p>
<p>在广播模式下，消息发送流程是这样的：</p>
<ul>
<li>可以有多个队列</li>
<li>每个队列都要绑定到<code>Exchange</code>（交换机）</li>
<li>生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定</li>
<li>交换机把消息发送给绑定过的所有队列</li>
<li>订阅队列的消费者都能拿到消息</li>
</ul>
<ol>
<li><p>声明一个广播类型的交换机以及三个队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">&quot;fanout.exchange&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout2.queue2&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue3&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>绑定交换机跟队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">bindingFanoutQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue1()).to(fanoutExchange());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">bindingFanoutQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue2()).to(fanoutExchange());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">bindingFanoutQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue3()).to(fanoutExchange());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行项目，可以查看到交换机绑定了三个队列：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/938201a6be6b450dad10196d7c2b779b.png" alt="img"></p>
</li>
<li><p>消费者监听三个队列，实时消费：[创建三个消费者]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFanoutConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;fanout.queue1&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;广播模式...消费者...1...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;fanout.queue2&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;广播模式...消费者...2...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;fanout.queue3&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout3</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;广播模式...消费者...3...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>生产者发布消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Fanout Message&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;fanout.exchange&quot;</span>, <span class="string">&quot;&quot;</span>, message.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行项目，查看结果：可以看到虽然只生产了<code>1</code>条消息，但是在广播模式下，发送给了3个队列，丝毫不用理会<code>Routing Key</code>，这就是广播模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">广播模式...消费者..<span class="number">.1</span>...消费消息：Fanout Message</span><br><span class="line">广播模式...消费者..<span class="number">.3</span>...消费消息：Fanout Message</span><br><span class="line">广播模式...消费者..<span class="number">.2</span>...消费消息：Fanout Message</span><br></pre></td></tr></table></figure>
</li>
<li><p>除了使用配置类的方式配置绑定关系，还可以使用注解的方式配置绑定关系，声明新的队列</p>
<p>这里的<code>type = &quot;fanout&quot;</code>是一定要写的，因为默认是<code>direct</code>直连模式类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;fanout.queue4&quot;), exchange = @Exchange(value = &quot;fanout.exchange&quot;, type = &quot;fanout&quot;))&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout4</span><span class="params">(String message)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;广播模式...消费者...4...消费消息：&quot;</span> + message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="14-8-4-Direct"><a href="#14-8-4-Direct" class="headerlink" title="14.8.4 Direct"></a>14.8.4 <code>Direct</code></h4><p>在<code>Fanout</code>模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到<code>DirectExchange</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912182822.png" alt="img"></p>
<p>在<code>Direct</code>模型下：</p>
<ul>
<li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个<code>RoutingKey</code>（路由<code>key</code>）</li>
<li>消息的发送方向<code>Exchange</code>发送消息时，也必须指定消息的 <code>RoutingKey</code>。</li>
<li><code>Exchange</code>不再把消息交给每一个绑定的队列，而是根据消息的<code>Routing Key</code>进行判断，只有队列的<code>Routingkey</code>与消息的 <code>Routing key</code>完全一致，才会接收到消息</li>
</ul>
<ol>
<li><p>声明直连交换机、3个队列、绑定交换机跟队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfiguration2</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">directExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;direct.exchange&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;direct.queue3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDirectQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue1()).to(directExchange()).with(<span class="string">&quot;cold.coffee&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDirectQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue2()).to(directExchange()).with(<span class="string">&quot;hot.coffee&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDirectQueue3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directQueue3()).to(directExchange()).with(<span class="string">&quot;spicy.coffee&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建生产者发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Direct Cold Coffee Message&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;direct.exchange&quot;</span>, <span class="string">&quot;cold.coffee&quot;</span>, message.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建消费者消费消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDirectConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;direct.queue1&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者 ① 消费消息 冷咖啡：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;direct.queue2&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者 ② 消费消息 热咖啡：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;direct.queue3&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect3</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者 ③ 消费消息 辣咖啡：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行项目，可以发现只有消费者<code>1</code>消费了消息，因为生产者发送的<code>Routing Key ---&gt; cold.coffee</code>，而绑定关系也是<code>cold.coffee</code>，所以就只有消费者<code>1</code>消费了消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">直连模式 Direct 消费消息 冷咖啡：Direct Cold Coffee Message</span><br></pre></td></tr></table></figure>

<p>可以尝试改成<code>hot.coffee</code>，那就只有消费者<code>2</code>消费了消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">直连模式 Direct 消费消息 冷咖啡：Direct Cold Coffee Message</span><br><span class="line">直连模式 Direct 消费消息 热咖啡：Direct Hot Coffee Message</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用注解创建第四个队列并与<code>direct.exchange</code>交换机绑定，绑定关系有两个<code>sweet.coffee</code>和<code>hot.coffee</code>，所以当发送的路由键为<code>hot.coffee</code>，理应第二个队列跟第四个队列都收得到其余队列收不到，而为<code>sweet.coffee</code>时只有第四个队列消费得了消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;direct.queue4&quot;), exchange = @Exchange(value = &quot;direct.exchange&quot;, type = &quot;direct&quot;), key = &#123;&quot;sweet.coffee&quot;, &quot;hot.coffee&quot;&#125;)&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect4</span><span class="params">(String message)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者 ④ 消费消息 热咖啡和甜咖啡：&quot;</span> + message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行项目，结果与预期一致：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">消费者 ④ 消费消息 热咖啡和甜咖啡：Direct Hot Coffee Message</span><br><span class="line">消费者 ② 消费消息 热咖啡：Direct Hot Coffee Message</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="14-8-5-Topic"><a href="#14-8-5-Topic" class="headerlink" title="14.8.5 Topic"></a>14.8.5 <code>Topic</code></h4><p><code>Topic </code> 与 <code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic </code>类型可以让队列在绑定<code>Routing key</code> 的时候使用通配符！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912194016.png" alt="img"></p>
<p>通配符规则：</p>
<p><code>#</code>：匹配一个或多个词</p>
<p><code>*</code>：只能匹配一个词</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">item.#`：能够匹配 item.spu.insert 或者 item.spu</span><br><span class="line">item.*`：只能匹配 item.spu</span><br></pre></td></tr></table></figure>

<p>将上述图例转化为代码，全部使用注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTopicConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;topic.queue1&quot;), exchange = @Exchange(value = &quot;topic.exchange&quot;, type = &quot;topic&quot;), key = &#123;&quot;china.#&quot;&#125;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic1</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...1...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;topic.queue2&quot;), exchange = @Exchange(value = &quot;topic.exchange&quot;, type = &quot;topic&quot;), key = &#123;&quot;japan.#&quot;&#125;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic2</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...2...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;topic.queue3&quot;), exchange = @Exchange(value = &quot;topic.exchange&quot;, type = &quot;topic&quot;), key = &#123;&quot;#.weather&quot;&#125;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic3</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...3...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = &#123;@QueueBinding(value = @Queue(value = &quot;topic.queue4&quot;), exchange = @Exchange(value = &quot;topic.exchange&quot;, type = &quot;topic&quot;), key = &#123;&quot;#.news&quot;&#125;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic4</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者...4...消费消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Direct china.weather.news Message&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;topic.exchange&quot;</span>, <span class="string">&quot;china.weather.news&quot;</span>, message.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">消费者..<span class="number">.1</span>...消费消息：Direct china.weather.news Message</span><br><span class="line">消费者..<span class="number">.4</span>...消费消息：Direct china.weather.news Message</span><br></pre></td></tr></table></figure>

<h3 id="14-9-消息转换器"><a href="#14-9-消息转换器" class="headerlink" title="14.9 消息转换器"></a>14.9 消息转换器</h3><p><code>Spring</code>会把你发送的消息序列化为字节发送给<code>MQ</code>，接收消息的时候，还会把字节反序列化为<code>Java</code>对象。</p>
<p><strong>默认情况下<code>Spring</code>采用的序列化方式是<code>JDK</code>序列化。</strong></p>
<p>我们可以去试一下效果：直接发送一个<code>Map</code>类型的数据给<code>object.queue</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObjectConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queuesToDeclare = &#123;@Queue(value = &quot;object.queue&quot;)&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopic1</span><span class="params">(Map&lt;String, String&gt; map)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;接收 Map 消息：&quot;</span> + map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先停止消费者【先启动消费者是为了创建队列】，然后生产者发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testObject</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;张麻子&quot;</span>);</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;object.queue&quot;</span>, map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/535f76d79afb4f5d8b80785fcaf09f64.png" alt="img"></p>
<p>可以看到发送的消息体积非常大，可读性很差，所以推荐使用<code>JSON</code>格式进行序列化和反序列化。</p>
<ol>
<li><p>生产者和消费者均引入：<code>jackson</code>依赖</p>
</li>
<li><p>生产者和消费者均添加配置类，修改消息转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.MessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">jsonMessageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时再发送和接收消息就靠的是<code>jackson</code>来进行消息转换了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/86f249d02d9a44d19731c695645c1354.png" alt="img"></p>
</li>
</ol>
<h2 id="15-ElasticSearch"><a href="#15-ElasticSearch" class="headerlink" title="15. ElasticSearch"></a>15. <code>ElasticSearch</code></h2><p><code>ELasticsearch</code>是一款非常强大的开源搜索引擎，具备非常多强大功能，可以帮助我们从海量数据中快速找到需要的内容，可以用来实现搜索、日志统计、分析、系统监控等功能。</p>
<p><code>Kibana Logstash Beats</code>都是可替代的，只有<code>ElasticSearch</code>是不可替代的，它是<code>elastic stack</code>的核心，负责存储、搜索、分析数据。<code>ElasticSearch</code>的核心技术就是倒排索引。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918202359.png" alt="img"></p>
<h3 id="15-1-ElasticSearch核心技术-——-倒排索引"><a href="#15-1-ElasticSearch核心技术-——-倒排索引" class="headerlink" title="15.1 ElasticSearch核心技术 —— 倒排索引"></a>15.1 <code>ElasticSearch</code>核心技术 —— 倒排索引</h3><p>了解倒排索引之前，首先得了解下正向索引，因为倒排索引就是相较于正向索引而言的，而<code>MySQL</code>的查询就是基于正向索引。</p>
<p>下表<code>tb_goods</code>中，<code>id</code>为索引，若是根据<code>id</code>查询，在<code>MySQL</code>中直接走索引则查询速度是非常快的，但是许多情况下，我们需要做的是模糊查询，对于正向索引来所只能是逐行对数据进行扫描，扫描流程如下：</p>
<ol>
<li>用户搜索数据，搜索出所有<code>title</code>含有<code>手机</code>的记录</li>
<li>逐行获取数据，比如<code>id</code>为<code>1</code>的数据</li>
<li>判断该记录中的<code>title</code>是否符合用户搜索条件</li>
<li>如果符合则将记录放入结果集，不符合则丢弃。</li>
</ol>
<p>逐行扫描，也就是全表扫描，随着数据量增加，其查询效率也会越来越低。当数据量达到数百万时，其效率可想而知。所以就引出了倒排索引这种技术。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918202527.png" alt="img"></p>
<p>倒排所以有两个非常重要的概念：</p>
<ol>
<li>**<font color="red">文档<code>document</code></font>**：用来搜索的数据，其中的每一条数据就是一个文档。例如一个网页、一个商品信息</li>
<li>**<font color="red">词条<code>term</code></font>**：对文档数据，利用某种分词算法对数据进行分词，得到的具备含义的词语就是词条，比如说：”我是中国人“这样一条数据，就可以划分为：<code>我</code>，<code>是</code>，<code>中国人</code>，<code>中国</code>，<code>国人</code>这样的几个词条。</li>
</ol>
<p><strong>创建倒排索引</strong>其实就是对正向索引的一种特殊处理，流程如下：</p>
<ul>
<li>将每一个文档的数据利用算法进行分词，得到一个个词条</li>
<li>创建表，每行数据包括词条、词条所在的文档<code>id</code>、位置等信息</li>
<li>因为词条唯一性，可以给词条创建所以，例如<code>hash</code>表结构索引</li>
</ul>
<p><strong>说得简单点就是：词条 —&gt; 包含词条的文档<code>id</code></strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918203514.png" alt="img"></p>
<p><strong>倒排索引的搜索流程</strong>如下（以搜索”华为手机”为例）</p>
<ol>
<li>用户输入条件<code>&quot;华为手机&quot;</code>进行搜索</li>
<li>对用户输入内容<strong>分词</strong>，得到词条：<code>华为</code>、<code>手机</code></li>
<li>拿着词条在倒排索引中查找，可以得到包含词条的文档<code>id</code>有<code>1、2、3</code></li>
<li>拿着文档<code>id</code>到正向索引中查找具体文档</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918203815.png" alt="img"></p>
<p><strong>虽然要先查询倒排索引，再查询正向索引，但是词条和文档<code>id</code>都建立了索引，查询速度非常快！无需全表扫描。</strong></p>
<blockquote>
<ul>
<li><p>为什么一个叫做正向索引，一个叫做倒排索引呢？</p>
<ul>
<li><p><strong>正向索引</strong>是最传统的，根据<code>id</code>索引的方式，但根据词条查询时需要先逐个获取每一个文档，然后判断文档中是否包含所需要的词条，<strong>是根据文档找词条的过程</strong>。</p>
</li>
<li><p><strong>倒排索引</strong>则相反，是先找到用户要搜索的词条，根据得到的文档<code>id</code>获取该文档，<strong>是根据词条找文档的过程</strong>。</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="15-2-ElasticSearch文档和字段"><a href="#15-2-ElasticSearch文档和字段" class="headerlink" title="15.2 ElasticSearch文档和字段"></a>15.2 <code>ElasticSearch</code>文档和字段</h3><p><code>ElasticSearch</code>是面向文档<code>Document</code>存储的，可以是数据库中的一条商品数据，一个订单信息。文档数据会被序列化<code>JSON</code>格式然后存储在<code>ElasticSearch</code>中。而<code>JSON</code>文档中往往包含着很多的字段，其实就是类似数据库中的列。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918212707.png" alt="img"></p>
<h3 id="15-3-ElasticSearch索引和映射"><a href="#15-3-ElasticSearch索引和映射" class="headerlink" title="15.3 ElasticSearch索引和映射"></a>15.3 <code>ElasticSearch</code>索引和映射</h3><p>**索引<code>Index</code>**其实就是相同类型的文档的集合，所以可以把索引看作是数据库里面的表。例如：</p>
<ul>
<li>所有用户文档，就可以组织在一起，称为用户的索引</li>
<li>所有商品的文档，可以组织在一起，称为商品的索引</li>
<li>所有订单的文档，可以组织在一起，称为订单的索引</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918213357.png" alt="img"></p>
<p><strong>在<code>18.2</code>学习了文档跟字段，现在又学习了索引，就可以整合以下，索引里面包含着文档，文档里面有字段。跟以前学习的<code>MySQL</code>对比以下就是：索引相当于数据库表而文档相当于记录也就是行而字段就相当于列也就是属性。</strong></p>
<p>除此之外，我们知道数据库中会有一些约束信息，用来定义表的结构、字段名称、类型等信息。<code>ElasticSearch</code>也有这样的概念，在索引库中用映射<code>mapping</code>的概念来表示，映射是用于索引中文档的字段约束信息的。</p>
<h3 id="15-4-ElasticSearch和MySQL"><a href="#15-4-ElasticSearch和MySQL" class="headerlink" title="15.4 ElasticSearch和MySQL"></a>15.4 <code>ElasticSearch</code>和<code>MySQL</code></h3><table>
<thead>
<tr>
<th align="left"><strong><code>MySQL</code></strong></th>
<th align="left"><strong><code>Elasticsearch</code></strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Table</code></td>
<td align="left"><code>Index</code></td>
<td align="left">索引<code>(index)</code>，就是文档的集合，类似数据库的表<code>(table)</code></td>
</tr>
<tr>
<td align="left"><code>Row</code></td>
<td align="left"><code>Document</code></td>
<td align="left">文档<code>（Document）</code>，就是一条条的数据，类似数据库中的行<code>（Row）</code>，文档都是<code>JSON</code>格式</td>
</tr>
<tr>
<td align="left"><code>Column</code></td>
<td align="left"><code>Field</code></td>
<td align="left">字段<code>（Field）</code>，就是<code>JSON</code>文档中的字段，类似数据库中的列<code>（Column）</code></td>
</tr>
<tr>
<td align="left"><code>Schema</code></td>
<td align="left"><code>Mapping</code></td>
<td align="left">映射<code>（Mapping）</code>是索引中文档的约束，例如字段类型约束。类似数据库的表结构<code>（Schema）</code></td>
</tr>
<tr>
<td align="left"><code>SQL</code></td>
<td align="left"><code>DSL</code></td>
<td align="left"><code>DSL</code>是<code>ElasticSearch</code>提供的<code>JSON</code>风格的请求语句，用来操作<code>ElasticSearch</code>，实现<code>CRUD</code></td>
</tr>
</tbody></table>
<ul>
<li><code>Mysql</code>：擅长事务类型操作，可以确保数据的安全和一致性</li>
<li><code>ElasticSearch</code>：擅长海量数据的搜索、分析、计算</li>
</ul>
<p>因此在企业中，往往是两者结合使用：</p>
<ul>
<li>如果是对安全性要求较高的写操作，应交由<code>MySQL</code></li>
<li>如果是对查询性能要求较高的搜索需求，应交由<code>ElasticSearch</code></li>
<li>两者再基于某种方式，实现数据的同步，保证一致性</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918213631.png" alt="img"></p>
<h3 id="15-5-安装ElasticSearch"><a href="#15-5-安装ElasticSearch" class="headerlink" title="15.5 安装ElasticSearch"></a>15.5 安装<code>ElasticSearch</code></h3><p><strong>添加网络：</strong></p>
<p>因为想使用<code>kibana</code>容器实现数据可视化，所以需要让<code>ElasticSearch</code>和<code>kibana</code>容器互联 —&gt; 形成一个互联网。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create es-net</span><br></pre></td></tr></table></figure>

<p><strong>加载镜像：</strong></p>
<p>这里我们采用<code>elasticsearch的7.12.1</code>版本的镜像，这个镜像体积非常大，接近<code>1G</code>。资料提供了镜像的<code>tar</code>包：上传到虚拟机中，然后运行命令加载即可：同理还有<code>kibana</code>的tar包也需要这样做。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker load -i es.tar</span><br><span class="line">docker load -i kibana.tar</span><br></pre></td></tr></table></figure>

<p><strong>运行：</strong></p>
<p>运行<code>docker</code>命令，部署单点<code>elasticsearch</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">	--name es \</span><br><span class="line">    -e <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span> \</span><br><span class="line">    -e <span class="string">&quot;discovery.type=single-node&quot;</span> \</span><br><span class="line">    -v es-data:/usr/share/elasticsearch/data \</span><br><span class="line">    -v es-plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">    --privileged \</span><br><span class="line">    --network es-net \</span><br><span class="line">    -p 9200:9200 \</span><br><span class="line">    -p 9300:9300 \</span><br><span class="line">elasticsearch:7.12.1</span><br></pre></td></tr></table></figure>

<p>命令解释：</p>
<ul>
<li><code>-e &quot;cluster.name=es-docker-cluster&quot;</code>：设置集群名称</li>
<li><code>-e &quot;http.host=0.0.0.0&quot;</code>：监听的地址，可以外网访问</li>
<li><code>-e &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</code>：内存大小</li>
<li><code>-e &quot;discovery.type=single-node&quot;</code>：非集群模式</li>
<li><code>-v es-data:/usr/share/elasticsearch/data</code>：挂载逻辑卷，绑定<code>es</code>的数据目录</li>
<li><code>-v es-logs:/usr/share/elasticsearch/logs</code>：挂载逻辑卷，绑定<code>es</code>的日志目录</li>
<li><code>-v es-plugins:/usr/share/elasticsearch/plugins</code>：挂载逻辑卷，绑定<code>es</code>的插件目录</li>
<li><code>--privileged</code>：授予逻辑卷访问权</li>
<li><code>--network es-net</code> ：加入一个名为<code>es-net</code>的网络中</li>
<li><code>-p 9200:9200</code>：端口映射配置</li>
</ul>
<p>这里我用的是<code>Virtual Box NAT</code>所以需要做一个端口映射然后，在浏览器中输入：<a target="_blank" rel="noopener" href="http://192.168.56.1:9200/">http://192.168.56.1:9200</a> 即可看到<code>elasticsearch</code>的响应结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918214620.png" alt="img"></p>
<h3 id="15-6-安装Kibana"><a href="#15-6-安装Kibana" class="headerlink" title="15.6 安装Kibana"></a>15.6 安装<code>Kibana</code></h3><p><code>kibana</code>可以给我们提供一个<code>elasticsearch</code>的可视化界面，便于我们学习。运行<code>docker</code>命令，部署<code>kibana</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name kibana \</span><br><span class="line">-e ELASTICSEARCH_HOSTS=http://es:9200 \</span><br><span class="line">--network=es-net \</span><br><span class="line">-p 5601:5601  \</span><br><span class="line">kibana:7.12.1</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--network es-net</code> ：加入一个名为<code>es-net</code>的网络中，与<code>elasticsearch</code>在同一个网络中</li>
<li><code>-e ELASTICSEARCH_HOSTS=http://es:9200&quot;</code>：设置<code>elasticsearch</code>的地址，因为<code>kibana</code>已经与<code>elasticsearch</code>在一个网络，因此可以用容器名直接访问<code>elasticsearch</code></li>
<li><code>-p 5601:5601</code>：端口映射配置</li>
</ul>
<p><code>kibana</code>启动一般比较慢，需要多等待一会，可以通过命令追踪启动日志：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f kibana</span><br></pre></td></tr></table></figure>

<p>接着在浏览器输入地址访问：<a href="http://192.168.56.1:5601即可看到结果：">http://192.168.56.1:5601即可看到结果：</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918214722.png" alt="img"></p>
<p><code>kibana</code>中提供了一个<code>DevTools</code>界面，这个界面中可以编写<code>DSL</code>来操作<code>ElasticSearch</code>。并且对<code>DSL</code>语句有自动补全功能。</p>
<p>访问<a target="_blank" rel="noopener" href="http://192.168.56.1:5601/app/dev_tools#/console%E5%8D%B3%E5%8F%AF%E8%BF%9B%E5%85%A5%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%95%8C%E9%9D%A2%E3%80%82">http://192.168.56.1:5601/app/dev_tools#/console即可进入控制台界面。</a></p>
<h3 id="15-7-安装ik分词插件"><a href="#15-7-安装ik分词插件" class="headerlink" title="15.7 安装ik分词插件"></a>15.7 安装<code>ik</code>分词插件</h3><p><strong>在线安装<code>ik</code>分词插件：</strong></p>
<p>直接从<code>github</code>上下载的速度非常非常慢，推荐使用离线安装<code>ik</code>分词插件的方式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入容器内部</span></span><br><span class="line">docker exec -it 36a9abb17b70 /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在线下载并安装</span></span><br><span class="line">./bin/elasticsearch-plugin  install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">退出</span></span><br><span class="line">exit</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启容器</span></span><br><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure>

<p><strong>离线安装<code>ik</code>分词插件：</strong></p>
<p>此前我们在运行<code>ElasticSearch</code>容器的时候就已经将数据卷挂在好了，可以看到我们将挂载点挂在到了<code>/usr/share/elasticsearch/data</code>和<code>/usr/share/elasticsearch/plugins</code>两个目录中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">	--name es \</span><br><span class="line">    -e &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot; \</span><br><span class="line">    -e &quot;discovery.type=single-node&quot; \</span><br><span class="line">    -v es-data:/usr/share/elasticsearch/data \</span><br><span class="line">    -v es-plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">    --privileged \</span><br><span class="line">    --network es-net \</span><br><span class="line">    -p 9200:9200 \</span><br><span class="line">    -p 9300:9300 \</span><br><span class="line">elasticsearch:7.12.1</span><br></pre></td></tr></table></figure>

<p>当然我们还可以使用<code>inspect</code>查看下插件挂载的数据卷位置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume inspect es-plugins</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;CreatedAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-05-06T10:06:34+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Mountpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/es-plugins/_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;es-plugins&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Options&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p><strong>解压缩分词器安装包：</strong></p>
<p>进入到<code>/var/lib/docker/volumes/es-plugins/_data</code>中，将资料中的<code>ik</code>分词器解压缩，重命名为<code>ik</code>，然后使用<code>xftp</code>将资料上传到该目录：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918215615.png" alt="img"></p>
<p>进入到<code>ElasticSearch</code>容器，可以看到挂载没问题，上传也没问题：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">docker exec -it 36a9abb17b70 bash</span><br><span class="line">cd plugins/</span><br><span class="line">ls</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/c7ef4aa2e78048839031824fb01b9986.png" alt="img"></p>
<p><strong>重启容器：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker restart es</span><br><span class="line">docker logs -f es</span><br></pre></td></tr></table></figure>

<p><strong>测试分词器分词：</strong></p>
<p><code>ik</code>分词器包含两种模式：</p>
<ul>
<li><code>ik_smart</code>：最少切分</li>
<li><code>ik_max_word</code>：最细切分</li>
</ul>
<p>使用<code>ik_max_word</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;恰同学少年，风华正茂&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;恰&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;同学&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;少年&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;风华正茂&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;风华&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;正&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;茂&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用<code>ik_smart</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;:&quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;:&quot;恰同学少年，风华正茂&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;恰&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 1,</span><br><span class="line">      &quot;type&quot; : &quot;CN_CHAR&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;同学&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 1,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;少年&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 5,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;风华正茂&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 6,</span><br><span class="line">      &quot;end_offset&quot; : 10,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>扩展词词典：</strong></p>
<p>随着互联网的发展，“造词运动”也越发的频繁。出现了很多新的词语，在原有的词汇列表中并不存在。比如：“奥力给”，“传智播客” 等。</p>
<p>所以我们的词汇也需要不断的更新，<code>ik</code>分词器提供了扩展词汇的功能。</p>
<ol>
<li>打开<code>ik</code>分词器<code>config</code>目录，在<code>IKAnalyzer.cfg.xml</code>配置文件内容添加：</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918221159.png" alt="img"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 *** 添加扩展词典--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span>ext.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>新建一个<code>ext.dic</code>，可以参考<code>config</code>目录下复制一个配置文件进行修改</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">奥力给</span></span><br><span class="line"><span class="attr">麦乐鸡侠</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>重启<code>ElasticSearch</code></li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker restart es</span><br><span class="line">docker logs -f elasticsearch</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试效果：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;麦乐鸡侠奥力给！&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;麦乐鸡侠&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;奥力给&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 4,</span><br><span class="line">      &quot;end_offset&quot; : 7,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意当前文件的编码必须是<code>UTF-8</code>格式，严禁使用<code>Windows</code>记事本编辑</p>
</blockquote>
<p><strong>禁用词词典：</strong></p>
<p>在互联网项目中，在网络间传输的速度很快，所以很多语言是不允许在网络上传递的，如：关于宗教、政治等敏感词语，那么我们在搜索时也应该忽略当前词汇。</p>
<p><code>ik</code>分词器也提供了强大的停用词功能，让我们在索引时就直接忽略当前的停用词汇表中的内容。</p>
<ol>
<li><p><code>IKAnalyzer.cfg.xml</code>配置文件内容添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--用户可以在这里配置自己的扩展字典--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span>ext.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典  *** 添加停用词词典--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span>stopword.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>stopword.dic</code>添加停用词</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">习大大</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启<code>ElasticSearch </code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启服务</span></span><br><span class="line">docker restart elasticsearch</span><br><span class="line">docker restart kibana</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 日志</span></span><br><span class="line">docker logs -f elasticsearch</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试效果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span><br><span class="line">  &quot;text&quot;:&quot;习大大奥力给！&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;奥力给&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 6,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="15-8-操作索引库之Mapping"><a href="#15-8-操作索引库之Mapping" class="headerlink" title="15.8 操作索引库之Mapping"></a>15.8 操作索引库之<code>Mapping</code></h3><p>索引库我们之前学习过就相当于<code>MySQL</code>数据库中的表，而<code>Mapping</code>映射就相当于是表结构<code>schema</code>，所以操作映射就是在操作<code>ES</code>的索引结构：</p>
<p><code>mapping</code>是对索引库中文档的约束，常见的<code>mapping</code>属性包括：</p>
<ul>
<li><p><code>type</code>：字段数据类型，常见的简单类型有</p>
<ul>
<li>字符串：<code>text</code>（可分词的文本）、<code>keyword</code>（精确值，例如：品牌、国家、<code>ip</code>地址）</li>
<li>数值：<code>long、integer、short、byte、double、float</code></li>
<li>布尔：<code>boolean</code></li>
<li>日期：<code>date</code></li>
<li>对象：<code>object</code></li>
</ul>
</li>
<li><p><code>index</code>：是否创建索引，默认为<code>true</code></p>
</li>
<li><p><code>analyzer</code>：使用哪种分词器，可以是<code>ik_max_word</code>也可以是<code>ik_smart</code></p>
</li>
<li><p><code>properties</code>：该字段的子字段</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">52.1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;isMarried&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小桥流水人家&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;abcdefg@163.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">99.1</span><span class="punctuation">,</span> <span class="number">99.5</span><span class="punctuation">,</span> <span class="number">98.9</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;德&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>对应德每个字段映射<code>mapping</code>如下：</p>
<ul>
<li><code>age</code>：类型为<code>integer</code>，<code>index</code>为<code>true</code>所以参与搜索，无需分词器</li>
<li><code>weight</code>：类型为<code>float</code>，<code>index</code>为<code>true</code>所以参与搜索，无需分词器</li>
<li><code>isMarried</code>：类型为<code>boolean</code>，<code>index</code>为<code>true</code>所以参与搜索，无需分词器</li>
<li><code>info</code>：类型为字符串，需要分词，因此是<code>text</code>，参与搜索，<code>index</code>为<code>true</code>，分词器可以用<code>ik_smart</code></li>
<li><code>email</code>：类型为字符串，但是不需要分词，因此是<code>keyword</code>，不参与搜索，因此设置<code>index</code>为<code>false</code>，无需分词器</li>
<li><code>score</code>：虽然是数组，<strong>但是我们只看元素的类型</strong>，类型为<code>float</code>，参与搜索，<code>index</code>为<code>true</code>，无需分词器</li>
<li><code>name</code>：类型为<code>object</code>，需要定义多个子属性<ul>
<li><code>name.firstName</code>：类型为字符串，不需要分词，<code>keyword</code>；参与搜索，<code>index</code>为<code>true</code>；无需分词器</li>
<li><code>name.lastName</code>：类型为字符串，不需要分词，<code>keyword</code>；参与搜索，<code>index</code>为<code>true</code>；无需分词器</li>
</ul>
</li>
</ul>
<p>下面的<code>value</code>是我自己添加的不用理会：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;21&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    	<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;float&quot;</span><span class="punctuation">,</span></span><br><span class="line">    	<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    	<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;52.1&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;isMarried&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;boolean&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;false&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;小桥流水人家&quot;</span>  </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;false&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;abcdefg@163.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;float&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="number">99.1</span><span class="punctuation">,</span> <span class="number">99.5</span><span class="punctuation">,</span> <span class="number">98.9</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    		<span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        		<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">        		<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;李&quot;</span></span><br><span class="line">    		<span class="punctuation">&#125;</span></span><br><span class="line">	        <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;德&quot;</span>   </span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-9-增删改查索引库"><a href="#15-9-增删改查索引库" class="headerlink" title="15.9 增删改查索引库"></a>15.9 增删改查索引库</h3><p>了解了<code>mapping</code>是怎么一回事就可以创建索引库和映射了，创建索引库和映射的示例如下：<strong>索引库</strong>就相当于表，<strong>映射</strong>相当于表结构，这里面的<code>properties</code>就相当于一个个的属性即列在这里表示<strong>字段</strong>，合在一起形成了行也就是记录在这里表示的是<strong>文档</strong>。</p>
<p><strong><code>index mapping document term</code>就是<code>ElasticSearch</code>最重要的四要素。</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT /索引库名称</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;字段名2&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;字段名3&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;子字段&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="comment">// ...略</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>需求：创建一张名为<code>/kk</code>的索引，要求有：<code>info email name</code>三个字段，<code>info</code>参与搜索和分词且类型为<code>text</code>，<code>email</code>不参与搜索类型为关键字<code>keyword</code>，<code>name</code>有两个子字段一个为<code>firstName</code>另一个为<code>lastName</code>，类型均为<code>keyword</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT /kk</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;false&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>执行，可以看到索引创建成功：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/383f52d086a64ab3b0353f1f9878afc2.png" alt="img"></p>
<p>我们使用一个真实的数据库来创建一个索引库：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210919164626.png" alt="img"></p>
<p>可以看到表名为：<code>tb_hotel</code>对应着索引名<code>/hotel</code>，字段数据类型可以参考表结构<code>schema</code>的名称和类型，不参与搜索的比如经纬度还有酒店图片这些都不用参与搜索，分不分词看内容，内容是一个整体比如<code>id</code>就不用分词，分词器我们可以选择<code>ik_max_word</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">PUT /hotel</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span><span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span><span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;starName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;business&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;geo_point&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>特殊字段说明：</p>
<ul>
<li><code>location</code>：地理坐标，里面包含精度、纬度</li>
<li><code>all</code>：一个组合字段，其目的是将多字段的值利用 <code>copy_to</code> 合并，提供给用户搜索，这样一来就只需要搜索一个字段就可以得到结果，性能更好。</li>
</ul>
<blockquote>
<p>ES中支持两种地理坐标数据类型：</p>
<ul>
<li><code>geo_point</code>：由纬度<code>（latitude）</code>和经度<code>（longitude）</code>确定的一个点。例如：<code>&quot;32.8752345, 120.2981576&quot;</code></li>
<li><code>geo_shape</code>：有多个<code>geo_point</code>组成的复杂几何图形。例如一条直线，<code>&quot;LINESTRING (-77.03653 38.897676, -77.009051 38.889939)&quot;</code></li>
</ul>
</blockquote>
<p><strong>修改索引库：</strong></p>
<p>**<font color="red">索引库一旦创建就无法修改</font>**，但是允许添加新的字段到<code>mapping</code>中。添加字段的语句如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /索引库名/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;新字段名&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>比如往<code>/kk</code>索引添加字段<code>age</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /kk/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>删除索引库：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /索引库名</span><br></pre></td></tr></table></figure>

<p><strong>查询索引库：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /索引库名</span><br></pre></td></tr></table></figure>

<h3 id="15-10-ElasticSearch文档操作"><a href="#15-10-ElasticSearch文档操作" class="headerlink" title="15.10 ElasticSearch文档操作"></a>15.10 <code>ElasticSearch</code>文档操作</h3><p>这些操作就是<code>DSL</code>语句，类似于<code>SQL</code>语句：</p>
<p><strong>增添文档：</strong></p>
<p>文档<code>Document</code>相当于数据库中的一条条记录，创建文档的结构如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /索引库名/_doc/文档id</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;字段1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;字段2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;字段3&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;子属性1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值3&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;子属性2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值4&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>比如往<code>/kk</code>索引库中添加一个文档：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /kk/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span><span class="string">&quot;我不会Java&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="string">&quot;java@qq.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;firstname&quot;</span><span class="punctuation">:</span><span class="string">&quot;张&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lastname&quot;</span><span class="punctuation">:</span><span class="string">&quot;三&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>执行，结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;kk&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>修改文档：</strong></p>
<p>修改文档有两种方式，一种是全量修改，另外一种是增量修改。</p>
<ul>
<li><p>全量修改：删除原来的文档，然后新增一个相同<code>id</code>的修改后的文档</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_doc/id</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;字段1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;字段2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ... 略</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /kk/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span><span class="string">&quot;我不会program&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="string">&quot;c@qq.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;firstname&quot;</span><span class="punctuation">:</span><span class="string">&quot;李&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lastname&quot;</span><span class="punctuation">:</span><span class="string">&quot;四&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>增量修改：只修改匹配<code>id</code>文档中的部分字段</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_update/文档id</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span> <span class="string">&quot;新的值&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /kk/_update/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;firstname&quot;</span><span class="punctuation">:</span><span class="string">&quot;王&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lastname&quot;</span><span class="punctuation">:</span><span class="string">&quot;五&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>删除文档：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_doc/<span class="punctuation">&#123;</span>id<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>查询文档：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /<span class="punctuation">&#123;</span>索引库名称<span class="punctuation">&#125;</span>/_doc/<span class="punctuation">&#123;</span>id<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-11-使用RestClient操作ElasticSearch"><a href="#15-11-使用RestClient操作ElasticSearch" class="headerlink" title="15.11 使用RestClient操作ElasticSearch"></a>15.11 使用<code>RestClient</code>操作<code>ElasticSearch</code></h3><p><code>ES</code>官方提供了各种不同语言的客户端，用来操作<code>ES</code>。这些客户端的本质就是组装 <code>DSL</code>语句，通过<code>http</code>请求发送给<code>ES</code>。官方文档地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html%E3%80%82">https://www.elastic.co/guide/en/elasticsearch/client/index.html。</a></p>
<p><code>ElasticSearchRestHighLevel</code>需要引入版本号，在<code>8.x</code>的<code>ElasticSearch</code>中已经被弃用了，新版本使用的是<code>ElasticSearch Java API Client</code>。这里由于<code>ElasticSearch</code>的版本是<code>7.12.1</code>的所以还是可以使用<code>Java Rest Client</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210919234405.png" alt="img"></p>
<p>后面将使用 <code>Java HighLevel Rest Client</code>操作<code>ElasticSearch</code>。</p>
<h4 id="15-11-1-初始化hotel-demo项目"><a href="#15-11-1-初始化hotel-demo项目" class="headerlink" title="15.11.1 初始化hotel-demo项目"></a>15.11.1 初始化<code>hotel-demo</code>项目</h4><ol>
<li><p>首先得在<code>mysql</code>中创建数据库和表，将酒店表的数据拉进去【资料有】</p>
</li>
<li><p>创建<code>hotel-demo</code>，<code>pom.xml</code>如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>03-hotel-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">       <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">       <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--amqp--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--FastJson--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.71<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">       <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br><span class="line">3. 修改配置文件`application.yml`：</span><br><span class="line"></span><br><span class="line">   ```yaml</span><br><span class="line">   server:</span><br><span class="line">     port: 80</span><br><span class="line">   spring:</span><br><span class="line">     datasource:</span><br><span class="line">       driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">       url: jdbc:mysql://localhost:3306/es?useSSL=false&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">       username: root</span><br><span class="line">       password: 123456</span><br><span class="line">     rabbitmq:</span><br><span class="line">       host: 192.168.56.1</span><br><span class="line">       port: 5672</span><br><span class="line">       username: admin</span><br><span class="line">       password: 123456</span><br><span class="line">       virtual-host: /</span><br><span class="line">   logging:</span><br><span class="line">     level:</span><br><span class="line">       com.kk.hotel: debug</span><br><span class="line">     pattern:</span><br><span class="line">       dateformat: yyyy-MM-dd HH:mm:ss</span><br><span class="line">   mybatis-plus:</span><br><span class="line">     configuration:</span><br><span class="line">       map-underscore-to-camel-case: true</span><br><span class="line">     type-aliases-package: com.kk.hotel.pojo</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>pojo.Hotel</code>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//解决实体名和表名映射问题</span></span><br><span class="line"><span class="meta">@TableName(value = &quot;tb_hotel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hotel</span> &#123;</span><br><span class="line">    <span class="comment">//解决主键自动生成问题，IdType.INPUT 表示用户自定义输入类型</span></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.INPUT)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line">    <span class="keyword">private</span> Integer score;</span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String starName;</span><br><span class="line">    <span class="keyword">private</span> String business;</span><br><span class="line">    <span class="keyword">private</span> String longitude;</span><br><span class="line">    <span class="keyword">private</span> String latitude;</span><br><span class="line">    <span class="keyword">private</span> String pic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>HotelMapper</code>接口继承<code>BaseMapper</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.Hotel;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HotelMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Hotel&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>HotelService</code>接口以及实现类<code>HotelServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.Hotel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HotelService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Hotel&gt;  &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">package</span> com.kk.hotel.service.impl;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.mapper.HotelMapper;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.pojo.Hotel;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.service.HotelService;</span><br><span class="line">   <span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Service</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;HotelMapper, Hotel&gt; <span class="keyword">implements</span> <span class="title class_">HotelService</span> &#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> 创建`Web`层：`HotelController`</span><br><span class="line"></span><br><span class="line">   ```java</span><br><span class="line">   <span class="keyword">package</span> com.kk.hotel.controller;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.service.HotelService;</span><br><span class="line">   <span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">   <span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">   <span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@RestController</span></span><br><span class="line">   <span class="meta">@RequestMapping(value = &quot;/hotel&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelController</span> &#123;</span><br><span class="line">       <span class="meta">@Autowired</span></span><br><span class="line">       <span class="keyword">private</span> HotelService hotelService;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HotelApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>因为该项目是用来练习操作<code>ElasticSearch</code>的所以需要再创建一个文档实体类，该文档中所有的字段都根据<code>Hotel</code>实体类生成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelDoc</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line">    <span class="keyword">private</span> Integer score;</span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String starName;</span><br><span class="line">    <span class="keyword">private</span> String business;</span><br><span class="line">    <span class="keyword">private</span> String location;</span><br><span class="line">    <span class="keyword">private</span> String pic;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HotelDoc</span><span class="params">(Hotel hotel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = hotel.getId();</span><br><span class="line">        <span class="built_in">this</span>.name = hotel.getName();</span><br><span class="line">        <span class="built_in">this</span>.address = hotel.getAddress();</span><br><span class="line">        <span class="built_in">this</span>.price = hotel.getPrice();</span><br><span class="line">        <span class="built_in">this</span>.score = hotel.getScore();</span><br><span class="line">        <span class="built_in">this</span>.brand = hotel.getBrand();</span><br><span class="line">        <span class="built_in">this</span>.city = hotel.getCity();</span><br><span class="line">        <span class="built_in">this</span>.starName = hotel.getStarName();</span><br><span class="line">        <span class="built_in">this</span>.business = hotel.getBusiness();</span><br><span class="line">        <span class="built_in">this</span>.location = hotel.getLatitude() + <span class="string">&quot;, &quot;</span> + hotel.getLongitude();</span><br><span class="line">        <span class="built_in">this</span>.pic = hotel.getPic();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="15-11-2-初始化RestHighLevelClient"><a href="#15-11-2-初始化RestHighLevelClient" class="headerlink" title="15.11.2 初始化RestHighLevelClient"></a>15.11.2 初始化<code>RestHighLevelClient</code></h4><p>在<code>ElasticSearch</code>提供的<code>API</code>中，<code>ElasticSearch</code>一切交互都封装在一个名为<code>RestHighLevelClient</code>的类中，必须先完成这个对象的初始化，建立与<code>ElasticSearch</code>的连接。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也可以集中管理版本：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建配置类，引入<code>RestHighLevelClient</code>，交由<code>Spring</code>容器管理该对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ESConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestHighLevelClient <span class="title function_">restHighLevelClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(HttpHost.create(<span class="string">&quot;http://192.168.56.1:9200&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你是单纯的测试使用可以在测试类中使用<code>@BeforeEach</code>创建对象在<code>@AfterEach</code>中销毁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.CreateIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.AfterAll;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.AfterEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.BeforeEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">MAPPING_TEMPLATE</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;mappings\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;id\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;name\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;address\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;index\&quot;: false\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;price\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;score\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;brand\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;city\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;starName\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;business\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;location\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;geo_point\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;pic\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;index\&quot;: false\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;all\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createRestHighLevelClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.restHighLevelClient = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(HttpHost.create(<span class="string">&quot;http://192.168.56.1:9200&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">CloseRestHighLevelClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.restHighLevelClient != <span class="literal">null</span>) restHighLevelClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="15-11-3-使用RestHighLevelClient创建、删除、判断索引是否存在"><a href="#15-11-3-使用RestHighLevelClient创建、删除、判断索引是否存在" class="headerlink" title="15.11.3 使用RestHighLevelClient创建、删除、判断索引是否存在"></a>15.11.3 使用<code>RestHighLevelClient</code>创建、删除、判断索引是否存在</h4><p>测试使用<code>RestHighLevelClient</code>创建映射：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.CreateIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.AfterAll;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.AfterEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.BeforeEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">MAPPING_TEMPLATE</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;mappings\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;id\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;name\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;address\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;index\&quot;: false\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;price\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;score\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;brand\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;city\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;starName\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;business\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;location\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;geo_point\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;pic\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;index\&quot;: false\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      \&quot;all\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;      &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createRestHighLevelClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.restHighLevelClient = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(HttpHost.create(<span class="string">&quot;http://192.168.56.1:9200&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">CreateIndexRequest</span> <span class="variable">createIndexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateIndexRequest</span>(<span class="string">&quot;hotel&quot;</span>);<span class="comment">//相当于 PUT /hotel</span></span><br><span class="line">        createIndexRequest.source(HotelTest.MAPPING_TEMPLATE, XContentType.JSON);<span class="comment">//映射中内容 JSON 格式</span></span><br><span class="line">        restHighLevelClient.indices().create(createIndexRequest, RequestOptions.DEFAULT);<span class="comment">//使用 RestHighLevelClient 创建映射</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">CloseRestHighLevelClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.restHighLevelClient != <span class="literal">null</span>) restHighLevelClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到创建映射成功：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/5d9e6b94145b44a2aaf4ddc2564c4390.png" alt="img"></p>
<p>测试使用<code>RestHighLevelClient</code>删除索引：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">DeleteIndexRequest</span> <span class="variable">deleteIndexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteIndexRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    restHighLevelClient.indices().delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/47635712c84d40feb638080292fbd5dd.png" alt="img"></p>
<p>测试判断索引库是否存在：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExistIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">GetIndexRequest</span> <span class="variable">getIndexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetIndexRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> restHighLevelClient.indices().exists(getIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(exists);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="15-11-4-使用RestHighLevelClient增删改查文档"><a href="#15-11-4-使用RestHighLevelClient增删改查文档" class="headerlink" title="15.11.4 使用RestHighLevelClient增删改查文档"></a>15.11.4 使用<code>RestHighLevelClient</code>增删改查文档</h4><p><strong>创建文档：</strong></p>
<p>文档也好索引也，操作时需要根据<code>MySQL</code>数据库中的信息创建，不要随意创建以防数据错乱。所以这里创建文档我们随便以一条记录为例，例如：<code>id = 61083</code>的酒店信息。【在此之前需要测试下使用<code>MyBatis-Plus</code>操作数据库是否是通的，这里就不做这个演示了】</p>
<p>注意这里转化为字符串，需要使用：<code>JSON.toJSONString()</code>否则到时候取数据为<code>null</code>，因为格式不对。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Hotel</span> <span class="variable">hotel</span> <span class="operator">=</span> hotelService.getById(<span class="number">61083L</span>);</span><br><span class="line">    <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotelDoc</span>(hotel);</span><br><span class="line">    <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;hotel&quot;</span>).id(hotelDoc.getId().toString());</span><br><span class="line">    indexRequest.source(JSON.toJSONString(hotelDoc), XContentType.JSON);</span><br><span class="line">    restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/3da03e0799c043e4affe23ea7f6f4a3a.png" alt="img"></p>
<p><strong>删除文档：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">DeleteRequest</span> <span class="variable">deleteRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(<span class="string">&quot;hotel&quot;</span>).id(String.valueOf(<span class="number">61083L</span>));</span><br><span class="line">    restHighLevelClient.delete(deleteRequest, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/76dc4f196be44e9b949beacfa1070ccf.png" alt="img"></p>
<p><strong>查询文档：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(<span class="string">&quot;hotel&quot;</span>).id(String.valueOf(<span class="number">61083L</span>));</span><br><span class="line">    <span class="type">GetResponse</span> <span class="variable">getResponse</span> <span class="operator">=</span> restHighLevelClient.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="type">String</span> <span class="variable">responseSourceAsString</span> <span class="operator">=</span> getResponse.getSourceAsString();<span class="comment">//获取内容字符串 ---&gt; 转换为对象</span></span><br><span class="line">    <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(responseSourceAsString, HotelDoc.class);</span><br><span class="line">    System.out.println(hotelDoc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修改文档：</strong></p>
<p>说过在<code>ES</code>中修改有两种全量修改跟增量修改，全量修改其实相当于新增，而增量修改就是局部，全量修改在<code>RestHighLevleClient</code>中跟新增文档是一样的，一摸一样，所以这里学习增量修改即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">UpdateRequest</span> <span class="variable">updateRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>(<span class="string">&quot;hotel&quot;</span>, <span class="string">&quot;61083&quot;</span>);</span><br><span class="line">    updateRequest.doc(<span class="string">&quot;price&quot;</span>, <span class="string">&quot;99999&quot;</span>, <span class="string">&quot;starName&quot;</span>, <span class="string">&quot;四钻&quot;</span>);</span><br><span class="line">    restHighLevelClient.update(updateRequest, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>批量导入文档：</strong></p>
<p>平常使用时肯定不会一条条的存储，肯定都是批量的导入。批量导入需要使用<code>BulkRequest</code>。<code>BulkRequest</code>相当于一个专门存储<code>Request</code>的容器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBulkDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">    Long[] hotelIds = &#123;<span class="number">56977L</span>, <span class="number">60922L</span>, <span class="number">395799L</span>, <span class="number">636080L</span>, <span class="number">2011785622L</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; hotelIds.length; i++) &#123;</span><br><span class="line">        <span class="type">Hotel</span> <span class="variable">hotel</span> <span class="operator">=</span> hotelService.getById(hotelIds[i]);</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotelDoc</span>(hotel);</span><br><span class="line">        bulkRequest.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;hotel&quot;</span>).id(hotelDoc.getId().toString()).source(JSON.toJSONString(hotelDoc), XContentType.JSON));</span><br><span class="line">    &#125;</span><br><span class="line">    restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/5e1b73487169482b8b38bc10da5027e4.png" alt="img"></p>
<p><strong><font color="red">细心的你一定可以发现，索引相关的操作都是<code>CreateIndexRequest GetIndexRequest DeleteIndexRequest</code>三个单词组成，而文档相关的操作都是<code>IndexRequest GetRequest DeleteRequest</code>两个单词组成，因为文档是包在索引里面的，有索引才有文档，索引大，所以索引用三个单词，文档用两个单词。</font></strong></p>
<h3 id="15-12-DSL文档查询【重点】"><a href="#15-12-DSL文档查询【重点】" class="headerlink" title="15.12 DSL文档查询【重点】"></a>15.12 <code>DSL</code>文档查询【重点】</h3><p><code>ElasticSearch</code>提供了基于<code>JSON</code>的<code>DSL(Domain Specific Language)</code>来定义查询。常见的查询类型包括：</p>
<ol>
<li><strong>查询所有：</strong>查询所有数据，一般测试使用。例如：<code>match_all</code></li>
<li><strong>全文检索：</strong>即<code>full text</code>查询，利用分词器对用户输入内容进行分词，然后使用倒排索引在索引库中匹配，例如：<code>match_query</code>以及<code>multi_match_query</code></li>
<li><strong>精确查询：</strong>根据精确词条值查找数据，一般就是查找<code>keyword</code>、数值、日期、<code>boolean</code>等类型字段，例如：<code>ids range term</code></li>
<li><strong>地理查询：</strong>即<code>geo</code>查询，根据经纬度查询。例如：<code>geo_distance、geo_bounding_box</code></li>
<li><strong>复合查询：</strong>即<code>compound</code>查询，复合查询可以将上述的各种查询条件组合起来，合并查询条件。例如：<code>bool、function_score</code></li>
</ol>
<h4 id="15-12-1-查询所有"><a href="#15-12-1-查询所有" class="headerlink" title="15.12.1 查询所有"></a>15.12.1 查询所有</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询所有</span></span><br><span class="line">GET /indexName/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/593e8698108341b0b704c8889818cfe3.png" alt="img"></p>
<h4 id="15-12-2-全文检索"><a href="#15-12-2-全文检索" class="headerlink" title="15.12.2 全文检索"></a>15.12.2 全文检索</h4><p>全文检索查询的基本流程如下：</p>
<ul>
<li>对用户搜索的内容做分词，得到词条</li>
<li>根据词条去倒排索引库中匹配得到文档<code>id</code></li>
<li>根据文档<code>id</code>获取文档然后返回给用户</li>
</ul>
<p>比较常见的应用场景如：百度输入框搜索、电商商城的输入框搜索 —&gt; 输入词条 —&gt; 类型为<code>text</code> —&gt; 分词器分词 —&gt; 倒排索引库检索</p>
<p>常见的全文检索包括：【<font color="red">注：<strong>字段</strong>就相当于是**<code>MySQL</code>中的列**，而且查询的字段类型需为<code>text</code>，<code>hotel</code>索引库只有<code>all name</code>两个字段是<code>text</code>的类型，其余不是，所以你在其余字段中查询就算一模一样也是查询不出来的。<code>all</code>里面包含着：<code>name brand city</code>，所以要想全文检索品牌和城市可以在<code>all</code>字段中检索</font>】</p>
<ul>
<li><code>match</code>：单字段查询，也就是只查询一个字段中是否符合条件</li>
<li><code>multi_match</code>：多字段查询，也就是在多个字段中查询是否符合条件</li>
</ul>
<p>比如使用单字段查询<code>name</code>字段中包含<code>世界</code>的酒店：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;世界&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>再比如使用多字段查询，查询出<code>name</code>或者<code>brand</code>有世界二字的酒店：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="string">&quot;深圳&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以看到多字段查询<code>multi_match</code>其实是包含了单字段查询<code>match</code>的，所以你可以直接用多字段进行全文。</p>
</li>
<li><p>但是检索的字段越多，其性能影响也会越来越大，所以我们尽量在创建影视<code>mapping</code>的时候就是使用<code>copy_to</code>将多个字段合并为一个字段比如：<code>&quot;copy_to&quot;:&quot;all&quot;</code>，然后使用单字段查询。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span><span class="string">&quot;深圳&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="15-12-3-精确查询"><a href="#15-12-3-精确查询" class="headerlink" title="15.12.3 精确查询"></a>15.12.3 精确查询</h4><p>精确查询一般是查询特定的某个关键字，比如<code>keyword</code>类型、数值、日期<code>boolean</code>等类型的字段，所以不会对搜索条件进行分词，进行分词的只有<code>text</code>。</p>
<ul>
<li><p><code>term</code>：根据词条精确查询</p>
<p>因为精确查询的字段搜是不分词的字段，因此查询的条件也必须是<strong>不分词</strong>的词条。查询时，用户输入的内容跟自动值完全匹配时才认为符合条件。如果用户输入的内容过多，反而搜索不到数据。</p>
<p>而且只支持单个字段的查询，比如我即要<code>id = </code>又要<code>brand = </code>就查询不到</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;60487&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这样子是查询不到的：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;60487&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;君悦&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>range</code>：根据值得范围查询</p>
<p>范围查询，一般应用在对数值类型做范围过滤的时候。比如做价格范围过滤、日期范围的过滤等。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span><span class="string">&quot;2500&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span><span class="string">&quot;3000&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921182858.png" alt="img"></p>
</li>
</ul>
<h4 id="15-12-4-地理坐标查询"><a href="#15-12-4-地理坐标查询" class="headerlink" title="15.12.4 地理坐标查询"></a>15.12.4 地理坐标查询</h4><p>地理坐标查询，其实就是根据经纬度查询，官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html</a></p>
<p>常见的使用场景包括：</p>
<ul>
<li><p>携程：搜索我附近的酒店</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183030.png" alt="img"></p>
</li>
<li><p>滴滴：搜索我附近的出租车</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183033.png" alt="img"></p>
</li>
<li><p>微信：搜索我附近的人</p>
</li>
</ul>
<p><strong>矩形范围查询：</strong></p>
<p>矩形范围查询，也就是<code>geo_bounding_box</code>查询，查询坐标落在某个矩形范围的所有文档，查询时，需要指定矩形的<strong>左上</strong>、<strong>右下</strong>两个点的坐标，然后画出一个矩形，落在该矩形内的都是符合条件的点。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183124.gif" alt="img"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;geo_bounding_box&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;top_left&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span><span class="number">31.1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span><span class="number">121.5</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;bottom_right&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span><span class="number">30.9</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span><span class="number">121.7</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>附近查询：</strong></p>
<p>附近查询，也叫做距离查询<code>（geo_distance）</code>：查询到指定中心点小于某个距离值的所有文档。</p>
<p>在地图上找一个点作为圆心，以指定距离为半径，画一个圆，落在圆内的坐标都算符合条件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183215.gif" alt="img"></p>
<p>查询深圳会展中心方圆<code>100km</code>的酒店：会展中心的经纬度为<code>(22.31, 114.03)</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;geo_distance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;distance&quot;</span><span class="punctuation">:</span><span class="string">&quot;100km&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="string">&quot;22.31,114.03&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以发现查询到：<code>56</code>家酒店</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/e45be03a9d024222acf67946459d4440.png" alt="img"></p>
<p>将其范围缩小到<code>25km</code>方圆之内：可以看到之查询到<code>6</code>家酒店</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/b600142c853e4126ac71302123b38b32.png" alt="img"></p>
<p>除此之外还可以针对这些查询的酒店结果，做一个排序得到与当前位置与各个酒店之间的距离：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;geo_distance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;distance&quot;</span><span class="punctuation">:</span><span class="string">&quot;25km&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="string">&quot;22.70,113.73&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="attr">&quot;_geo_distance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        	<span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="string">&quot;22.70,113.73&quot;</span><span class="punctuation">,</span></span><br><span class="line">        	<span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        	<span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span><span class="string">&quot;km&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到当前位置和深圳会展中心的希尔顿酒店仅大约有<code>5km</code>的距离。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/9f2597c1941f4a6e9b5e5e077df1fb8c.png" alt="img"></p>
<h4 id="15-12-5-复合查询"><a href="#15-12-5-复合查询" class="headerlink" title="15.12.5 复合查询"></a>15.12.5 复合查询</h4><p>复合<code>（compound）</code>查询：复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑。</p>
<ul>
<li><code>fuction score</code>：算分函数查询，可以控制文档相关性算分，控制文档排名</li>
<li><code>bool query</code>：布尔查询，利用逻辑关系组合多个其它的查询，实现复杂搜索</li>
</ul>
<p><strong>相关性算分：</strong></p>
<p>当我们利用<code>match</code>查询时，文档结果会根据与搜索词条的关联度打分<code>(_score)</code>，返回结果时按照分值降序排列。例如，我们搜索 “虹桥如家”，结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">17.850193</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;虹桥如家酒店真不错&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">12.259849</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;外滩如家酒店真不错&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">11.91091</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;迪士尼如家酒店真不错&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p><code>ElasticSearch</code>早期使用的打分算法是 <strong><code>TF-IDF</code>算法</strong>，公式如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921205752.png" alt="img"></p>
<p>在后来的<code>5.1</code>版本升级中，<code>ElasticSearch</code>将算法改进为**<code>BM25</code>算法**，公式如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921205757.png" alt="img"></p>
<p><code>TF-IDF</code>算法有一各缺陷，就是词条频率越高，文档得分也会越高，单个词条对文档影响较大。而<code>BM25</code>则会让单个词条的算分有一个上限，曲线更加平滑。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921205831.png" alt="img"></p>
<h5 id="15-12-5-1-算分函数查询"><a href="#15-12-5-1-算分函数查询" class="headerlink" title="15.12.5.1 算分函数查询"></a>15.12.5.1 算分函数查询</h5><p>根据相关度打分是比较合理的需求，但有时候也不能够满足我们的需求。以百度为例，你搜索的结果中，并不是相关度越高排名越靠前，而是谁给的钱多排名就越靠前。</p>
<p><strong>要想制相关性算分，就需要利用<code>ElasticSearch</code>中的 <code>function score</code>查询。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921210256.png" alt="img"></p>
<p><code>function score</code>查询中包含四部分内容：</p>
<ul>
<li><strong>原始查询</strong>条件：<code>query</code>部分，基于这个条件搜索文档，并且基于<code>BM25</code>算法给文档打分，<strong>原始算分</strong><code>（query score)</code></li>
<li><strong>过滤条件</strong>：<code>filter</code>部分，符合该条件的文档才会<strong>重新算分</strong></li>
<li><strong>算分函数</strong>：符合<code>filter</code>条件的文档要根据这个函数做运算，得到的函数算分<code>（function score）</code>，有四种函数：<ul>
<li>**<code>weight</code>**：函数结果是常量</li>
<li>**<code>field_value_factor</code>**：以文档中的某个字段值作为函数结果</li>
<li>**<code>random_score</code>**：以随机数作为函数结果</li>
<li>**<code>script_score</code>**：自定义算分函数算法</li>
</ul>
</li>
<li><strong>运算模式</strong>：算分函数的结果、原始查询的相关性算分，两者之间的运算方式，包括：<ul>
<li>**<code>multiply</code>**：相乘</li>
<li>**<code>replace</code>**：用<code>function score</code>替换<code>query score</code></li>
<li><strong><code>sum、avg、max、min</code></strong></li>
</ul>
</li>
</ul>
<p><code>function score</code>的运行流程如下：</p>
<ol>
<li>根据<strong>原始条件</strong>查询搜索文档，并且计算相关性算分，称为<strong>原始算分</strong><code>（query score）</code></li>
<li>根据<strong>过滤条件</strong>，过滤文档</li>
<li>符合<strong>过滤条件</strong>的文档，基于<strong>算分函数</strong>运算，得到<strong>函数算分</strong><code>（function score）</code></li>
<li>将<strong>原始算分</strong><code>（query score）</code>和<strong>函数算分</strong><code>（function score）</code>基于<strong>运算模式</strong>做运算，得到最终结果，作为相关性算分。</li>
</ol>
<p>因此最关键的就是三个点：过滤条件、算分函数、运算模式</p>
<ul>
<li>过滤条件：决定哪些文档的算分被修改</li>
<li>算分函数：决定函数算分的算法</li>
<li>运算模式：决定最终算分结果</li>
</ul>
<p>例如：因为如家给我们打钱了，所以让品牌为<code>如家</code>的酒店排名靠前一些</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="comment">//原始算分</span></span><br><span class="line">        <span class="attr">&quot;function_score&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="comment">//原始查询，可以是任意条件比如全文检索、精确查询、地理位置查询等</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                </span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="comment">//算分函数</span></span><br><span class="line">            ”functions”：<span class="punctuation">[</span></span><br><span class="line">            	<span class="punctuation">&#123;</span></span><br><span class="line">    	        	<span class="comment">//过滤上述原始查询的文档，这里填写过滤条件</span></span><br><span class="line">	            	<span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            			<span class="attr">&quot;term&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">	        	    		<span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span><span class="string">&quot;如家&quot;</span>            </span><br><span class="line">				        <span class="punctuation">&#125;</span></span><br><span class="line">			        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	    			<span class="comment">//算分权重，为10</span></span><br><span class="line">    				<span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span><span class="string">&quot;10&quot;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">	        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			/原始算分和函数算分得到的结果的运算模式：这里为加权模式</span><br><span class="line">			<span class="attr">&quot;boost_mode&quot;</span><span class="punctuation">:</span><span class="string">&quot;sum&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong><font color="red">其实很好理解，就是查询文档得到原始算分，然后过滤文档通过算分函数得到函数算分，原始算分和函数算分通过运算模式得到最终算分。</font></strong></p>
<p>比如我这里单纯的查询深圳的酒店：可以看到排名第一的是一家叫君越的酒店</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span> <span class="string">&quot;深圳&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/db795be870fd4b399f295c0fd37bddaa.png" alt="img"></p>
<p>当我们做了算分函数查询之后：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;function_score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;all&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;深圳&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;functions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;如家&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;boost_mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/6a0177d081284eb38a2afaaf1dbfac1c.png" alt="img"></p>
<p>可以看到如家酒店的排名一下就上去了，而且<code>score</code>是原始算分的基础上<code>+10</code>得到的。</p>
<h5 id="15-12-5-2-布尔查询"><a href="#15-12-5-2-布尔查询" class="headerlink" title="15.12.5.2 布尔查询"></a>15.12.5.2 布尔查询</h5><p>布尔查询是一个或多个查询子句的组合，每一个子句就是一个<strong>子查询</strong>。子查询的组合方式有</p>
<ul>
<li>**<code>must</code>**：必须匹配每个子查询，类似“与”</li>
<li>**<code>should</code>**：选择性匹配子查询，类似“或”</li>
<li><strong><code>must_not</code><strong>：必须不匹配，</strong>不参与算分</strong>，类似“非”</li>
<li><strong><code>filter</code><strong>：必须匹配，</strong>不参与算分</strong></li>
</ul>
<p>比如在搜索酒店时，除了关键字搜索外，我们还可能根据品牌、价格、城市等字段做过滤，<strong>每一个不同的字段，其查询的条件、方式都不一样，必须是多个不同的查询，而要组合这些查询，就必须用<code>bool</code>查询了。</strong>需要注意的是，搜索时，**<font color="red">参与打分的字段越多，查询的性能也越差</font>**。因此这种多条件查询时，建议这样做：</p>
<ul>
<li>搜索框的关键字搜索，是全文检索查询，使用<code>must</code>查询，参与算分</li>
<li>其它过滤条件，采用<code>filter</code>查询，不参与算分</li>
</ul>
<p>例如：查询城市在上海，酒店品牌为皇冠假日或者华美达，并且价格一定在<code>500</code>以上且评分在<code>45</code>分以上：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                	<span class="attr">&quot;term&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                		<span class="attr">&quot;city&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                			<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;上海&quot;</span></span><br><span class="line">                		<span class="punctuation">&#125;</span></span><br><span class="line">                	<span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">					        <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                		<span class="attr">&quot;city&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                			<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;皇冠假日&quot;</span></span><br><span class="line">                		<span class="punctuation">&#125;</span></span><br><span class="line">					        <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">					        <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                		<span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                			<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;华美达&quot;</span></span><br><span class="line">                		<span class="punctuation">&#125;</span></span><br><span class="line">					        <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span><span class="number">500</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span><span class="string">&quot;45&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>需求：搜索名字包含“如家”，价格不高于<code>400</code>，在坐标<code>31.21,121.5</code>周围<code>10km</code>范围内的酒店。除此之外对以该坐标为中心到酒店的距离做一个排序，最近的排最前面。</p>
<ul>
<li>名称搜索，属于全文检索查询，应该参与算分，放到<code>must</code>中</li>
<li>价格不高于<code>400</code>，用<code>range</code>查询，属于过滤条件，不参与算分，放到<code>must_not</code>中</li>
<li>周围<code>10km</code>范围内，用<code>geo_distance</code>查询，属于过滤条件，不参与算分，放到<code>filter</code>中</li>
<li>排序使用<code>sort</code></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="string">&quot;如家&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span>  </span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span><span class="string">&quot;400&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;geo_distance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;distance&quot;</span><span class="punctuation">:</span><span class="string">&quot;10km&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="string">&quot;31.21,121.5&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_geo_distance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="string">&quot;31.21,121.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span><span class="string">&quot;km&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/6b20d9e07dca42bcb3b209fbff6d28ef.png" alt="img"></p>
<h3 id="15-13-搜索结果处理"><a href="#15-13-搜索结果处理" class="headerlink" title="15.13 搜索结果处理"></a>15.13 搜索结果处理</h3><h4 id="15-13-1-排序"><a href="#15-13-1-排序" class="headerlink" title="15.13.1 排序"></a>15.13.1 排序</h4><p><code>ElasticSearch</code>默认是根据相关度算分<code>（_score）</code>来排序，但是也支持自定义方式对搜索结果排序，官方文档在：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html%E3%80%82%E5%8F%AF%E4%BB%A5%E6%8E%92%E5%BA%8F%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E6%9C%89%EF%BC%9A%60keyword%60%E7%B1%BB%E5%9E%8B%E3%80%81%E6%95%B0%E5%80%BC%E7%B1%BB%E5%9E%8B%E3%80%81%E5%9C%B0%E7%90%86%E5%9D%90%E6%A0%87%E7%B1%BB%E5%9E%8B%E3%80%81%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B%E7%AD%89%E3%80%82%60keyword%60%E3%80%81%E6%95%B0%E5%80%BC%E3%80%81%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B%E6%8E%92%E5%BA%8F%E7%9A%84%E8%AF%AD%E6%B3%95%E5%9F%BA%E6%9C%AC%E4%B8%80%E8%87%B4%E3%80%82">https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html。可以排序字段类型有：`keyword`类型、数值类型、地理坐标类型、日期类型等。`keyword`、数值、日期类型排序的语法基本一致。</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /indexName/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;FIELD&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span>  <span class="comment">// 排序字段、排序方式ASC、DESC</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>排序条件是一个数组，也就是可以写多个排序条件。按照声明的顺序，当第一个条件相等时，再按照第二个条件排序。</p>
<p>需求描述：酒店数据按照用户评价<code>（score)</code>降序排序，评价相同的按照价格<code>(price)</code>升序排序。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到查询出来的结果，会先按照<code>score</code>进行降序排序，如果<code>score</code>相同再按照<code>price</code>进行升序排序。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/b8a97e2e7e4e4d29a2064cb794e62ecb.png" alt="img"></p>
<p>按地理位置到指定经纬坐标的距离进行排序：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_geo_distance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="string">&quot;31.034661,121.612282&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="string">&quot;desc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span><span class="string">&quot;km&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/0d05985d07ba460e97c8df215c58818a.png" alt="img"></p>
<blockquote>
<p>经纬度获取链接：<a target="_blank" rel="noopener" href="https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat">https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat</a></p>
</blockquote>
<h4 id="15-13-2-分页"><a href="#15-13-2-分页" class="headerlink" title="15.13.2 分页"></a>15.13.2 分页</h4><p><code>ElasticSearch</code> 默认情况下只返回<code>top10</code>的数据。而如果要查询更多数据就需要修改分页参数了。</p>
<p><code>ElasticSearch</code>通过修改<code>from</code>和<code>size</code>参数来控制要返回的分页结果：类似<code>MySQL</code>中的<code>limit</code>。</p>
<ul>
<li><code>form</code>：表示从第几个文档开始</li>
<li><code>size</code>：总共查询多少个文档</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">201</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询<code>990~1000</code>的数据：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">990</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong><font color="red">注意：<code>ElasticSearch</code>内部分页时，必须先查询<code>0~1000</code>条，然后截取其中的<code>990 ~ 1000</code>的这<code>10</code>条数据。</font></strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921234503.png" alt="img"></p>
<p>查询<code>TOP1000</code>，如果<code>es</code>是单点模式，这并无太大影响。但是<code>ElasticSearch</code>将来一定是集群，例如我集群有5个节点，我要查询<code>TOP1000</code>的数据，并不是每个节点查询<code>200</code>条就可以了。节点<code>A</code>的<code>TOP200</code>，在另一个节点可能排到<code>10000</code>名以外了。</p>
<p><strong>因此要想获取整个集群的<code>TOP1000</code>，必须先查询出每个节点的<code>TOP1000</code>，汇总结果后，重新排名，重新截取<code>TOP1000</code>。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921234555.png" alt="img"></p>
<p><strong><font color="red">当查询分页深度较大时，汇总数据过多，对内存和<code>CPU</code>会产生非常大的压力，因此 <code>ElasticSearch</code>会禁止<code>from+ size</code>超过<code>10000</code>的请求。</font></strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/de5fde12819d42a3bdb283df182fd17f.png" alt="img"></p>
<p>针对深度分页，<code>ES</code>提供了两种解决方案，<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html">官方文档</a>：</p>
<ul>
<li><code>search after</code>：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。</li>
<li><code>scroll</code>：原理将排序后的文档id形成快照，保存在内存。官方已经不推荐使用。</li>
</ul>
<p>分页查询的常见实现方案以及优缺点</p>
<ul>
<li><strong><code>from + size</code>【用的最多】</strong><ul>
<li>优点：支持随机翻页</li>
<li>缺点：深度分页问题，默认查询上限（<code>from + size</code>）是<code>10000</code></li>
<li>场景：百度、京东、谷歌、淘宝这样的随机翻页搜索</li>
</ul>
</li>
<li><strong><code>after search</code></strong><ul>
<li>优点：没有查询上限（单次查询的<code>size</code>不超过<code>10000</code>）</li>
<li>缺点：只能向后逐页查询，不支持随机翻页</li>
<li>场景：没有随机翻页需求的搜索，例如手机向下滚动翻页</li>
</ul>
</li>
<li><strong><code>scroll</code></strong><ul>
<li>优点：没有查询上限（单次查询的<code>size</code>不超过<code>10000</code>）</li>
<li>缺点：会有额外内存消耗，并且搜索结果是非实时的</li>
<li>场景：海量数据的获取和迁移。从<code>ES7.1</code>开始不推荐，建议用<code>after search</code>方案。</li>
</ul>
</li>
</ul>
<h4 id="15-13-3-高亮"><a href="#15-13-3-高亮" class="headerlink" title="15.13.3 高亮"></a>15.13.3 高亮</h4><p>我们在百度，京东搜索时，关键字会变成红色，比较醒目，这叫高亮显示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921234711.png" alt="img"></p>
<p>高亮显示的实现分为两步：</p>
<ol>
<li>给文档中的所有关键字都添加一个标签，例如<code>&lt;em&gt;</code>标签</li>
<li>页面给<code>&lt;em&gt;</code>标签编写<code>CSS</code>样式</li>
</ol>
<p>前提条件：能分词才会有高亮即查询的数据类型为<code>text</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span><span class="string">&quot;如家&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;em&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;/em&gt;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果要对非搜索字段高亮，则需要添加一个属性：<code>required_field_match=false</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span><span class="string">&quot;如家&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;em&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;/em&gt;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;require_field_match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-14-DSL总体结构如下"><a href="#15-14-DSL总体结构如下" class="headerlink" title="15.14 DSL总体结构如下"></a>15.14 <code>DSL</code>总体结构如下</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921235330.png" alt="img"></p>
<h3 id="15-15-使用RestHighLevelClient进行文档查询"><a href="#15-15-使用RestHighLevelClient进行文档查询" class="headerlink" title="15.15 使用RestHighLevelClient进行文档查询"></a>15.15 使用<code>RestHighLevelClient</code>进行文档查询</h3><ol>
<li>用<code>RestHighLevelClient</code>进行文档查询使用：<code>SearchRequest</code>即可。这对应着第一行：<code>GET /hotel/_search</code></li>
<li>对于里面的参数用<code>searchRequest.source().query(QueryBuilders.matchAllQuery());</code>表示，对应的语句为：<code>&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;</code>，</li>
<li>发送请求：<code>SearchResponse searchResponse =  restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</code></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016170057.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().query(QueryBuilders.matchAllQuery()).from(<span class="number">0</span>).size(<span class="number">200</span>);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>match</code>查询：单字段匹配查询</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDocMatch</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().query(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;如家&quot;</span>)).from(<span class="number">0</span>).size(<span class="number">100</span>);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>multimatch</code>查询：多字段查询</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDocMultiMatch</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().query(QueryBuilders.multiMatchQuery(<span class="string">&quot;君悦&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;all&quot;</span>)).from(<span class="number">0</span>).size(<span class="number">200</span>);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;所有符合条件的酒店数量：&quot;</span> + searchResponse.getHits().getTotalHits().value);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>term</code>词条匹配精确查询：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDocTerm</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().query(QueryBuilders.termQuery(<span class="string">&quot;brand&quot;</span>, <span class="string">&quot;君悦&quot;</span>));</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;酒店数量：&quot;</span> + searchResponse.getHits().getTotalHits().value + <span class="string">&quot; 家&quot;</span>);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>range</code>范围精确查询：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDocRange</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().query(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gte(<span class="number">2500</span>).lte(<span class="number">3000</span>));</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;酒店数量：&quot;</span> + searchResponse.getHits().getTotalHits().value + <span class="string">&quot; 家&quot;</span>);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>bool</code>布尔查询：</strong></p>
<p>例如：酒店必须在深圳并且品牌是如家或者汉庭或者是希尔顿，且价格不低于<code>300</code>，并且距离于<code>22.70,113.70</code>不超过<code>5km</code>且按顺序显示距离值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>:<span class="string">&quot;如家汉庭希尔顿&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;range&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;price&quot;</span>:&#123;</span><br><span class="line">              <span class="string">&quot;lte&quot;</span>:<span class="number">300</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ], </span><br><span class="line">      <span class="string">&quot;filter&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;geo_distance&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;distance&quot;</span>:<span class="string">&quot;5km&quot;</span>,</span><br><span class="line">            <span class="string">&quot;location&quot;</span>:<span class="string">&quot;22.53,114.06&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_geo_distance&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;location&quot;</span>:<span class="string">&quot;22.53,114.06&quot;</span>,</span><br><span class="line">        <span class="string">&quot;order&quot;</span>:<span class="string">&quot;asc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;unit&quot;</span>:<span class="string">&quot;km&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;from&quot;</span>:<span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>:<span class="string">&quot;200&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDocBool</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().query(QueryBuilders.boolQuery()</span><br><span class="line">                    .must(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;如家汉庭希尔顿&quot;</span>))</span><br><span class="line">                    .mustNot(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).lte(<span class="number">300</span>))</span><br><span class="line">                    <span class="comment">//GeoDistance.ARC精确查询 || GeoDistance.PLANE模糊查询</span></span><br><span class="line">                    .filter(QueryBuilders.geoDistanceQuery(<span class="string">&quot;location&quot;</span>).distance(<span class="number">3</span>, DistanceUnit.KILOMETERS).point(<span class="number">22.53D</span>, <span class="number">114.06D</span>).geoDistance(GeoDistance.ARC)))</span><br><span class="line">            .from(<span class="number">0</span>)</span><br><span class="line">            .size(<span class="number">200</span>);</span><br><span class="line">    searchRequest.source().sort(SortBuilders.geoDistanceSort(<span class="string">&quot;location&quot;</span>,<span class="keyword">new</span> <span class="title class_">GeoPoint</span>(<span class="number">22.53D</span>, <span class="number">114.06D</span>)).unit(DistanceUnit.KILOMETERS).order(SortOrder.ASC));</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;酒店数量：&quot;</span> + searchResponse.getHits().getTotalHits().value + <span class="string">&quot; 家&quot;</span>);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(String.valueOf(hit.getSortValues()[<span class="number">0</span>])).setScale(<span class="number">2</span>, BigDecimal.ROUND_HALF_UP).doubleValue();</span><br><span class="line">        System.out.println(<span class="string">&quot;距离目的地大约&quot;</span> + distance + <span class="string">&quot;公里 ---&gt; &quot;</span> + hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>排序、分页：</strong></p>
<p>搜索最便宜的十家酒店：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDocSortAndPage</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> <span class="number">1</span>, size = <span class="number">10</span>;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().sort(<span class="string">&quot;price&quot;</span>, SortOrder.ASC);</span><br><span class="line">    searchRequest.source().from((page - <span class="number">1</span>) * size).size(size);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>高亮：</strong></p>
<p>会自动给分词添加<code>&lt;em&gt;&lt;/em&gt;</code>标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testSearchDocHighLight() throws IOException &#123;</span><br><span class="line">    SearchRequest searchRequest = new SearchRequest(&quot;hotel&quot;);</span><br><span class="line">    searchRequest.source().query(QueryBuilders.matchQuery(&quot;name&quot;, &quot;汉庭&quot;))</span><br><span class="line">            .highlighter(new HighlightBuilder().field(&quot;name&quot;).requireFieldMatch(true));</span><br><span class="line">    SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    for (SearchHit hit : hits) &#123;</span><br><span class="line">        String sourceAsString = hit.getSourceAsString();</span><br><span class="line">        HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        Map&lt;String, HighlightField&gt; highLightFieldMap = hit.getHighlightFields();</span><br><span class="line">        if (!CollectionUtils.isEmpty(highLightFieldMap)) &#123;</span><br><span class="line">            HighlightField highlightField = highLightFieldMap.get(&quot;name&quot;);</span><br><span class="line">            if (highlightField != null) &#123;</span><br><span class="line">                String name = highlightField.getFragments()[0].string();</span><br><span class="line">                hotelDoc.setName(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>地理坐标查询：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;geo_distance&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;location&quot;</span>:<span class="string">&quot;22.53,114.06&quot;</span>,</span><br><span class="line">      <span class="string">&quot;distance&quot;</span>:<span class="string">&quot;5km&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_geo_distance&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;location&quot;</span>:<span class="string">&quot;22.53,114.06&quot;</span>,</span><br><span class="line">        <span class="string">&quot;unit&quot;</span>: <span class="string">&quot;km&quot;</span>, </span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDocGeo</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().query(QueryBuilders.geoDistanceQuery(<span class="string">&quot;location&quot;</span>).distance(<span class="number">5</span>, DistanceUnit.KILOMETERS).point(<span class="keyword">new</span> <span class="title class_">GeoPoint</span>(<span class="string">&quot;22.53,114.06&quot;</span>)));</span><br><span class="line">    searchRequest.source().sort(SortBuilders.geoDistanceSort(<span class="string">&quot;location&quot;</span>, <span class="keyword">new</span> <span class="title class_">GeoPoint</span>(<span class="string">&quot;22.53,114.06&quot;</span>)).order(SortOrder.ASC).unit(DistanceUnit.KILOMETERS));</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>算分函数查询：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;function_score&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;functions&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span><span class="string">&quot;汉庭&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;boost_mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">200</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDocFunctionScore</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().query(QueryBuilders.functionScoreQuery(QueryBuilders.matchAllQuery(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder[]&#123;</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder(QueryBuilders.termQuery(<span class="string">&quot;brand&quot;</span>, <span class="string">&quot;汉庭&quot;</span>), ScoreFunctionBuilders.weightFactorFunction(<span class="number">10</span>))</span><br><span class="line">            &#125;).boostMode(CombineFunction.SUM));</span><br><span class="line">    searchRequest.source().from(<span class="number">0</span>).size(<span class="number">200</span>);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-16-使用ElasticSearch查询酒店"><a href="#15-16-使用ElasticSearch查询酒店" class="headerlink" title="15.16 使用ElasticSearch查询酒店"></a>15.16 使用<code>ElasticSearch</code>查询酒店</h3><p>第一个<code>bug</code>：需要重新<code>clean</code>下然后在<code>target</code>中才会出现<code>static</code>相关资源，否则访问不到。<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/705fc8cbd78a4dc3bd255437f0541732.png" alt="img"></p>
<h4 id="15-16-1-基本搜索和分页"><a href="#15-16-1-基本搜索和分页" class="headerlink" title="15.16.1 基本搜索和分页"></a>15.16.1 基本搜索和分页</h4><ol>
<li><p>定义类，接收前端请求参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestParam</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String key;<span class="comment">//搜索关键字</span></span><br><span class="line">    <span class="keyword">private</span> Integer page;<span class="comment">//当前页码 (page - 1) * size</span></span><br><span class="line">    <span class="keyword">private</span> Integer size;<span class="comment">//显示条数</span></span><br><span class="line">    <span class="keyword">private</span> String sortBy;<span class="comment">//排序字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义分页的结果类：这里的列表名称必须为<code>hotels</code>否则前端拿不到，改的话前端都要改相当麻烦，所以还是乖乖写<code>hotels</code>吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="keyword">private</span> List&lt;HotelDoc&gt; hotels;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义<code>Controller</code>接口接收前端请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@PostMapping(value = &quot;/list&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> PageResult <span class="title function_">search</span><span class="params">(<span class="meta">@RequestBody</span> RequestParam requestParam)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> hotelService.search(requestParam);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 添加`service`接口方法</span><br><span class="line"></span><br><span class="line">   ```java</span><br><span class="line">   <span class="keyword">package</span> com.kk.hotel.service;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.pojo.Hotel;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.pojo.PageResult;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.pojo.RequestParam;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HotelService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Hotel&gt;  &#123;</span><br><span class="line">       PageResult <span class="title function_">search</span><span class="params">(RequestParam requestParam)</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> 实现类实现`search`方法：完成全文搜索功能</span><br><span class="line"></span><br><span class="line">   ```java</span><br><span class="line">   <span class="keyword">package</span> com.kk.hotel.service.impl;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line">   <span class="keyword">import</span> com.baomidou.mybatisplus.extension.api.R;</span><br><span class="line">   <span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.mapper.HotelMapper;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.pojo.Hotel;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.pojo.HotelDoc;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.pojo.PageResult;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.pojo.RequestParam;</span><br><span class="line">   <span class="keyword">import</span> com.kk.hotel.service.HotelService;</span><br><span class="line">   <span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line">   <span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line">   <span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line">   <span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">   <span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line">   <span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line">   <span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">   <span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line">   <span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">import</span> java.io.IOException;</span><br><span class="line">   <span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line">   <span class="keyword">import</span> java.util.List;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Service</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;HotelMapper, Hotel&gt; <span class="keyword">implements</span> <span class="title class_">HotelService</span> &#123;</span><br><span class="line">   </span><br><span class="line">       <span class="meta">@Autowired</span></span><br><span class="line">       <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line">   </span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> PageResult <span class="title function_">search</span><span class="params">(RequestParam requestParam)</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//实现全文检索</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> requestParam.getPage();</span><br><span class="line">               <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> requestParam.getSize();</span><br><span class="line">               <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> requestParam.getKey();</span><br><span class="line">               <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">               <span class="comment">//健壮性判断 ---&gt; 如果 key 为空或者为空字符串则查询全部，否则进行全文检索</span></span><br><span class="line">               <span class="keyword">if</span> (key == <span class="literal">null</span> || <span class="string">&quot;&quot;</span>.equals(key))</span><br><span class="line">                   searchRequest.source().query(QueryBuilders.matchAllQuery()).from((page - <span class="number">1</span>) * size).size(size);</span><br><span class="line">               <span class="keyword">else</span> searchRequest.source().query(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, key)).from((page - <span class="number">1</span>) * size).size(size);</span><br><span class="line">               <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">               <span class="keyword">return</span> handleSearchResult(searchResponse);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="comment">//封装处理请求的函数</span></span><br><span class="line">       <span class="keyword">public</span> PageResult <span class="title function_">handleSearchResult</span><span class="params">(SearchResponse searchResponse)</span> &#123;</span><br><span class="line">           <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>();</span><br><span class="line">           pageResult.setTotal(searchResponse.getHits().getTotalHits().value);</span><br><span class="line">           SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">           List&lt;HotelDoc&gt; hotelDocList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">           <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">               <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">               hotelDocList.add(hotelDoc);</span><br><span class="line">           &#125;</span><br><span class="line">           pageResult.setHotels(hotelDocList);</span><br><span class="line">           <span class="keyword">return</span> pageResult;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="15-16-2-过滤"><a href="#15-16-2-过滤" class="headerlink" title="15.16.2 过滤"></a>15.16.2 过滤</h4><p>实现过滤条件：完成按条件筛选功能 —&gt; 城市、星级、品牌、价格</p>
<p>修改<code>RequestParams</code>，添加：<code>brand city starName minPrice maxPrice</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestParam</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String key;<span class="comment">//搜索关键字</span></span><br><span class="line">    <span class="keyword">private</span> Integer page;<span class="comment">//当前页码 (page - 1) * size</span></span><br><span class="line">    <span class="keyword">private</span> Integer size;<span class="comment">//显示条数</span></span><br><span class="line">    <span class="keyword">private</span> String sortBy;<span class="comment">//排序字段</span></span><br><span class="line">    <span class="keyword">private</span> String brand;<span class="comment">//品牌</span></span><br><span class="line">    <span class="keyword">private</span> String city;<span class="comment">//城市</span></span><br><span class="line">    <span class="keyword">private</span> String startName;<span class="comment">//星级</span></span><br><span class="line">    <span class="keyword">private</span> Integer minPrice;<span class="comment">//最小价格</span></span><br><span class="line">    <span class="keyword">private</span> Integer maxPrice;<span class="comment">//最大价格</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>city</code>:精确匹配</li>
<li><code>brand</code>：精确匹配</li>
<li><code>starName</code>：精确匹配</li>
<li><code>price</code>：范围匹配</li>
</ul>
<p>多个条件组合在一起使用布尔查询且为<code>AND</code>关系，并且不为空才需要添加，为空不添加。</p>
<p>注意：<code>BoolQueryBuilder</code>应该使用同一个，如果你在每一个<code>query()</code>中使用的都是<code>QueryBuilders.boolQuery()</code>则会覆盖，不信可以结尾打印下<code>SearchRequest</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.api.R;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.mapper.HotelMapper;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.Hotel;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.HotelDoc;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.RequestParam;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.service.HotelService;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.BoolQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;HotelMapper, Hotel&gt; <span class="keyword">implements</span> <span class="title class_">HotelService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">search</span><span class="params">(RequestParam requestParam)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//实现全文检索</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> requestParam.getPage();</span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> requestParam.getSize();</span><br><span class="line">            <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">            <span class="comment">//按条件过滤信息</span></span><br><span class="line">            handlerFilter(requestParam, searchRequest);</span><br><span class="line">            searchRequest.source().from((page - <span class="number">1</span>) * size).size(size);</span><br><span class="line">            <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="keyword">return</span> handleSearchResult(searchResponse);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//过滤</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerFilter</span><span class="params">(RequestParam requestParam, SearchRequest searchRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (requestParam != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> requestParam.getKey();</span><br><span class="line">            <span class="comment">//健壮性判断 ---&gt; 如果 key 为空或者为空字符串则查询全部，否则进行全文检索</span></span><br><span class="line">            <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">            <span class="keyword">if</span> (key == <span class="literal">null</span> || <span class="string">&quot;&quot;</span>.equals(key))</span><br><span class="line">                searchRequest.source().query(boolQuery.must(QueryBuilders.matchAllQuery()));</span><br><span class="line">            <span class="keyword">else</span> searchRequest.source().query(boolQuery.must(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, key)));</span><br><span class="line">            <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> requestParam.getCity();</span><br><span class="line">            <span class="type">String</span> <span class="variable">brand</span> <span class="operator">=</span> requestParam.getBrand();</span><br><span class="line">            <span class="type">String</span> <span class="variable">starName</span> <span class="operator">=</span> requestParam.getStarName();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">minPrice</span> <span class="operator">=</span> requestParam.getMinPrice();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">maxPrice</span> <span class="operator">=</span> requestParam.getMaxPrice();</span><br><span class="line">            <span class="type">String</span> <span class="variable">location</span> <span class="operator">=</span> requestParam.getLocation();</span><br><span class="line">            <span class="comment">//健壮性判断 ---&gt; 如果 key 为空或者为空字符串则查询全部，否则进行全文检索</span></span><br><span class="line">            <span class="keyword">if</span> (city != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(city))&#123;</span><br><span class="line">                searchRequest.source().query(boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;city&quot;</span>, city)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (brand != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(brand)) &#123;</span><br><span class="line">                searchRequest.source().query(boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;brand&quot;</span>, brand)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (starName != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(starName)) &#123;</span><br><span class="line">                searchRequest.source().query(boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;starName&quot;</span>, starName)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (minPrice != <span class="literal">null</span> &amp;&amp; maxPrice != <span class="literal">null</span>) &#123;</span><br><span class="line">                searchRequest.source().query(boolQuery.filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).lte(maxPrice).gte(minPrice)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (location != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(location)) &#123;</span><br><span class="line">                searchRequest.source().query(boolQuery.filter(QueryBuilders.rangeQuery(<span class="string">&quot;&quot;</span>).lte(maxPrice).gte(minPrice)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//System.out.println(searchRequest.toString());</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装处理请求的函数</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">handleSearchResult</span><span class="params">(SearchResponse searchResponse)</span> &#123;</span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>();</span><br><span class="line">        pageResult.setTotal(searchResponse.getHits().getTotalHits().value);</span><br><span class="line">        SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">        List&lt;HotelDoc&gt; hotelDocList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">            <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">            hotelDocList.add(hotelDoc);</span><br><span class="line">        &#125;</span><br><span class="line">        pageResult.setHotels(hotelDocList);</span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="18-16-3-我附近的酒店"><a href="#18-16-3-我附近的酒店" class="headerlink" title="18.16.3 我附近的酒店"></a>18.16.3 我附近的酒店</h4><p>根据坐标排个序，最前面显示最近距离的酒店</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (location != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(location)) &#123;</span><br><span class="line">    searchRequest.source().sort(SortBuilders.geoDistanceSort(<span class="string">&quot;location&quot;</span>, <span class="keyword">new</span> <span class="title class_">GeoPoint</span>(location)).unit(DistanceUnit.KILOMETERS).order(SortOrder.ASC));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="15-16-4-显示距离"><a href="#15-16-4-显示距离" class="headerlink" title="15.16.4 显示距离"></a>15.16.4 显示距离</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//封装处理请求的函数</span></span><br><span class="line"><span class="keyword">public</span> PageResult <span class="title function_">handleSearchResult</span><span class="params">(SearchResponse searchResponse)</span> &#123;</span><br><span class="line">    <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>();</span><br><span class="line">    pageResult.setTotal(searchResponse.getHits().getTotalHits().value);</span><br><span class="line">    SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">    List&lt;HotelDoc&gt; hotelDocList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">        <span class="keyword">if</span>(hit.getSortValues().length &gt; <span class="number">0</span>) hotelDoc.setDistance(hit.getSortValues()[<span class="number">0</span>]);</span><br><span class="line">        hotelDocList.add(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">    pageResult.setHotels(hotelDocList);</span><br><span class="line">    <span class="keyword">return</span> pageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="15-16-5-广告置顶"><a href="#15-16-5-广告置顶" class="headerlink" title="15.16.5 广告置顶"></a>15.16.5 广告置顶</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 给索引库新增一个叫isAD的字段，类型是布尔类型</span><br><span class="line">PUT /hotel/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;isAD&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># 给索引库id为<span class="number">45845</span>的记录赋值，让其isAD字段为<span class="literal"><span class="keyword">true</span></span>（用于测试广告竞价排名，该记录会靠前）</span><br><span class="line">POST /hotel/_update/<span class="number">45845</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">    <span class="attr">&quot;isAD&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET hotel/_doc/<span class="number">45845</span></span><br></pre></td></tr></table></figure>

<p>给有广告的进行算分函数加权即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//过滤</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerFilter</span><span class="params">(RequestParam requestParam, SearchRequest searchRequest)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (requestParam != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> requestParam.getKey();</span><br><span class="line">        <span class="comment">//健壮性判断 ---&gt; 如果 key 为空或者为空字符串则查询全部，否则进行全文检索</span></span><br><span class="line">        <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="literal">null</span> || <span class="string">&quot;&quot;</span>.equals(key))</span><br><span class="line">            searchRequest.source().query(boolQuery.must(QueryBuilders.matchAllQuery()));</span><br><span class="line">        <span class="keyword">else</span> searchRequest.source().query(boolQuery.must(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, key)));</span><br><span class="line">        <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> requestParam.getCity();</span><br><span class="line">        <span class="type">String</span> <span class="variable">brand</span> <span class="operator">=</span> requestParam.getBrand();</span><br><span class="line">        <span class="type">String</span> <span class="variable">starName</span> <span class="operator">=</span> requestParam.getStarName();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">minPrice</span> <span class="operator">=</span> requestParam.getMinPrice();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">maxPrice</span> <span class="operator">=</span> requestParam.getMaxPrice();</span><br><span class="line">        <span class="type">String</span> <span class="variable">location</span> <span class="operator">=</span> requestParam.getLocation();</span><br><span class="line">        <span class="comment">//健壮性判断 ---&gt; 如果 key 为空或者为空字符串则查询全部，否则进行全文检索</span></span><br><span class="line">        <span class="keyword">if</span> (city != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(city))&#123;</span><br><span class="line">            searchRequest.source().query(boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;city&quot;</span>, city)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (brand != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(brand)) &#123;</span><br><span class="line">            searchRequest.source().query(boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;brand&quot;</span>, brand)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (starName != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(starName)) &#123;</span><br><span class="line">            searchRequest.source().query(boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;starName&quot;</span>, starName)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (minPrice != <span class="literal">null</span> &amp;&amp; maxPrice != <span class="literal">null</span>) &#123;</span><br><span class="line">            searchRequest.source().query(boolQuery.filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).lte(maxPrice).gte(minPrice)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (location != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(location)) &#123;</span><br><span class="line">            searchRequest.source().sort(SortBuilders.geoDistanceSort(<span class="string">&quot;location&quot;</span>, <span class="keyword">new</span> <span class="title class_">GeoPoint</span>(location)).unit(DistanceUnit.KILOMETERS).order(SortOrder.ASC));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">FunctionScoreQueryBuilder</span> <span class="variable">functionScoreQuery</span> <span class="operator">=</span> QueryBuilders.functionScoreQuery(boolQuery, <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder(QueryBuilders.termQuery(<span class="string">&quot;isAD&quot;</span>, <span class="literal">true</span>), ScoreFunctionBuilders.weightFactorFunction(<span class="number">10</span>))</span><br><span class="line">        &#125;);</span><br><span class="line">        searchRequest.source().query(functionScoreQuery);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/a9257d54a2354c45928d6b9e417749d1.png" alt="img"></p>
<p><strong>记得在<code>HotelDoc</code>实体类添加<code>isAD</code>属性。</strong></p>
<h3 id="15-17-DSL数据聚合"><a href="#15-17-DSL数据聚合" class="headerlink" title="15.17 DSL数据聚合"></a>15.17 <code>DSL</code>数据聚合</h3><p><strong>聚合</strong>可以让我们极其方便的实现对数据的统计、分析、运算。</p>
<ul>
<li>什么品牌的手机最受欢迎？</li>
<li>这些手机的平均价格、最高价格、最低价格？</li>
<li>这些手机每月的销售情况如何？</li>
</ul>
<p>在<code>ElasticSearch</code>实现这些统计功能比数据库的<code>SQL</code>要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p>
<p>常见的聚合有三类：</p>
<ul>
<li>桶聚合<code>Bucket Aggregations</code>：用来对文档进行分组<ul>
<li><code>TermAggregation</code>：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li>
<li><code>Date Histogram</code>：按照日期阶梯分组，例如一周为一组，或者一月为一组</li>
</ul>
</li>
<li>度量聚合<code>Metric Aggregations</code>：用来计算一些值，比如<strong>最大值最小值平均值</strong>等。<ul>
<li><code>Avg</code>：求平均值</li>
<li><code>Max</code>：求最大值</li>
<li><code>Min</code>：求最小值</li>
<li><code>Stats</code>：同时求<code>max、min、avg、sum</code>等</li>
</ul>
</li>
<li>管道聚合<code>Pipeline Aggregations</code>：用来聚合其它聚合的结果【聚合的聚合】</li>
</ul>
<p><font color="red"><strong>注意</strong>：参加聚合的字段必须是<code>keyword</code>、日期、数值、布尔类型</font></p>
<h4 id="15-17-1-桶聚合Bucket-Aggregation"><a href="#15-17-1-桶聚合Bucket-Aggregation" class="headerlink" title="15.17.1 桶聚合Bucket Aggregation"></a>15.17.1 桶聚合<code>Bucket Aggregation</code></h4><p>例如：我们要统计所有数据中的酒店品牌有几种，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是<code>Bucket</code>聚合。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span><span class="comment">//结果不显示文档，只包含聚合结果</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="comment">//定义聚合</span></span><br><span class="line">    <span class="attr">&quot;brandAggregation&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="comment">//聚合名称：给聚合结果起名字</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="comment">//聚合类型：文档类型 + 日期类型</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;brand&quot;</span><span class="punctuation">,</span><span class="comment">//参与聚合的字段</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">100</span><span class="comment">//聚合结果数量</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211022184007.png" alt="img"></p>
<p>默认情况下，<code>Bucket</code>聚合会统计<code>Bucket</code>内的文档数量，记为<code>_count</code>，并且按照<code>_count</code>降序排序。你可以在上图看到这一事实，当然我们也可以指定<code>order</code>属性，自定义聚合的排序方式。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;brandAggregation&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;brand&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;_count&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span></span><br><span class="line">         <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，Bucket 聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。我们可以限定要聚合的文档范围，只要添加<code>query</code>条件即可；</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">2000</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;brandAggregation&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;brand&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;_count&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span></span><br><span class="line">         <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到聚合的品牌明显变少了：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/5f45f337fc7f4371acfe9627bd14d108.png" alt="img"></p>
<h4 id="15-17-2-度量聚合Metric-Aggregation"><a href="#15-17-2-度量聚合Metric-Aggregation" class="headerlink" title="15.17.2 度量聚合Metric Aggregation"></a>15.17.2 度量聚合<code>Metric Aggregation</code></h4><p>上面，我们对酒店按照品牌分组，形成了一个个桶。现在我们需要对桶内的酒店做运算，获取每个品牌的用户评分的<code>min、max、avg</code>等值，使用<code>stats</code>就是包含了所有的类型包括<code>count max min avg sum</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;brand_aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;brand&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;score_aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;score&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211022184847.png" alt="img"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;brand_aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;brand&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;max_price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;price&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="15-17-3-使用RestClient执行数据聚合"><a href="#15-17-3-使用RestClient执行数据聚合" class="headerlink" title="15.17.3 使用RestClient执行数据聚合"></a>15.17.3 使用<code>RestClient</code>执行数据聚合</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchDocAggregation</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    searchRequest.source().aggregation(AggregationBuilders.terms(<span class="string">&quot;brand_aggregation&quot;</span>).field(<span class="string">&quot;brand&quot;</span>).size(<span class="number">20</span>));</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">    <span class="type">Terms</span> <span class="variable">brandAggregation</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;brand_aggregation&quot;</span>);</span><br><span class="line">    List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; buckets = brandAggregation.getBuckets();</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">keyAsString</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">        System.out.println(keyAsString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="15-17-4-多条件聚合"><a href="#15-17-4-多条件聚合" class="headerlink" title="15.17.4 多条件聚合"></a>15.17.4 多条件聚合</h4><p>需求：搜索页面中的品牌、城市等信息不应该是写死的而是索引库中有什么把它传递给前端页面，而完成这些需要使用到聚合索引。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/8838273a22cb45f4826d73dbda40d3ad.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;brand_aggs&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>:<span class="string">&quot;brand&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;city_aggs&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;city&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;starName_aggs&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>:<span class="string">&quot;starName&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着我们的<code>hotel_demo</code>继续做，在<code>HotelService</code>中定义一个<code>Map&lt;String, List&lt;String&gt;&gt; filters</code>方法，用于返还索引库中存在的：品牌、城市、星级。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">filters</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">        searchRequest.source().aggregation(AggregationBuilders.terms(<span class="string">&quot;brand_aggregation&quot;</span>).field(<span class="string">&quot;brand&quot;</span>));</span><br><span class="line">        searchRequest.source().aggregation(AggregationBuilders.terms(<span class="string">&quot;city_aggregation&quot;</span>).field(<span class="string">&quot;city&quot;</span>));</span><br><span class="line">        searchRequest.source().aggregation(AggregationBuilders.terms(<span class="string">&quot;starName_aggregation&quot;</span>).field(<span class="string">&quot;starName&quot;</span>));</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">        <span class="type">Terms</span> <span class="variable">brandAggregation</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;brand_aggregation&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; brandBuckets = brandAggregation.getBuckets();</span><br><span class="line">        List&lt;String&gt; brandList = getList(brandBuckets);</span><br><span class="line">        <span class="type">Terms</span> <span class="variable">cityAggregation</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;city_aggregation&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; cityBuckets = cityAggregation.getBuckets();</span><br><span class="line">        List&lt;String&gt; cityList = getList(cityBuckets);</span><br><span class="line">        <span class="type">Terms</span> <span class="variable">starNameAggregation</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;starName_aggregation&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; starNameBuckets = starNameAggregation.getBuckets();</span><br><span class="line">        List&lt;String&gt; starNameList = getList(starNameBuckets);</span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;city&quot;</span>, cityList);</span><br><span class="line">        map.put(<span class="string">&quot;brand&quot;</span>, brandList);</span><br><span class="line">        map.put(<span class="string">&quot;starName&quot;</span>, starNameList);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getList</span><span class="params">(List&lt;? extends Terms.Bucket&gt; buckets)</span> &#123;</span><br><span class="line">    List&lt;String&gt; keywordList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">keyAsString</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">        keywordList.add(keyAsString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keywordList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="15-17-5-带过滤条件的多条件聚合"><a href="#15-17-5-带过滤条件的多条件聚合" class="headerlink" title="15.17.5 带过滤条件的多条件聚合"></a>15.17.5 带过滤条件的多条件聚合</h4><p>对过滤出来的条件应该还要结合搜索框，字段等信息进行过滤。所以应该在<code>filter</code>中加上参数，使用<code>search()</code>中的代码。比如<code>1500</code>元价格以上的酒店只有<code>喜来登、希尔顿、皇冠假日、维也纳</code>四个品牌，那在品牌一来只该显示这四个品牌而不能显示其它品牌。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/599b43f3f02b4684b5daf0606b08a33e.png" alt="img"></p>
<p><strong>主要是：<code>filters getList handlerFilter</code>三个方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kk.hotel.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.api.R;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.mapper.HotelMapper;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.Hotel;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.HotelDoc;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.pojo.RequestParam;</span><br><span class="line"><span class="keyword">import</span> com.kk.hotel.service.HotelService;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.geo.GeoPoint;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.lucene.search.function.FunctionScoreQuery;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.lucene.search.function.ScoreFunction;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.unit.DistanceUnit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.BoolQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.functionscore.FunctionScoreQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.functionscore.ScoreFunctionBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.functionscore.ScoreFunctionBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregation;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.sort.SortBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.sort.SortOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;HotelMapper, Hotel&gt; <span class="keyword">implements</span> <span class="title class_">HotelService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">search</span><span class="params">(RequestParam requestParam)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//实现全文检索</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> requestParam.getPage();</span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> requestParam.getSize();</span><br><span class="line">            <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">            <span class="comment">//按条件过滤信息</span></span><br><span class="line">            handlerFilter(requestParam, searchRequest);</span><br><span class="line">            searchRequest.source().from((page - <span class="number">1</span>) * size).size(size);</span><br><span class="line">            <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="keyword">return</span> handleSearchResult(searchResponse);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">filters</span><span class="params">(RequestParam requestParam)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">            handlerFilter(requestParam, searchRequest);</span><br><span class="line">            searchRequest.source().aggregation(AggregationBuilders.terms(<span class="string">&quot;brand_aggregation&quot;</span>).field(<span class="string">&quot;brand&quot;</span>));</span><br><span class="line">            searchRequest.source().aggregation(AggregationBuilders.terms(<span class="string">&quot;city_aggregation&quot;</span>).field(<span class="string">&quot;city&quot;</span>));</span><br><span class="line">            searchRequest.source().aggregation(AggregationBuilders.terms(<span class="string">&quot;starName_aggregation&quot;</span>).field(<span class="string">&quot;starName&quot;</span>));</span><br><span class="line">            <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">            <span class="type">Terms</span> <span class="variable">brandAggregation</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;brand_aggregation&quot;</span>);</span><br><span class="line">            List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; brandBuckets = brandAggregation.getBuckets();</span><br><span class="line">            List&lt;String&gt; brandList = getList(brandBuckets);</span><br><span class="line">            <span class="type">Terms</span> <span class="variable">cityAggregation</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;city_aggregation&quot;</span>);</span><br><span class="line">            List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; cityBuckets = cityAggregation.getBuckets();</span><br><span class="line">            List&lt;String&gt; cityList = getList(cityBuckets);</span><br><span class="line">            <span class="type">Terms</span> <span class="variable">starNameAggregation</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;starName_aggregation&quot;</span>);</span><br><span class="line">            List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; starNameBuckets = starNameAggregation.getBuckets();</span><br><span class="line">            List&lt;String&gt; starNameList = getList(starNameBuckets);</span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;city&quot;</span>, cityList);</span><br><span class="line">            map.put(<span class="string">&quot;brand&quot;</span>, brandList);</span><br><span class="line">            map.put(<span class="string">&quot;starName&quot;</span>, starNameList);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getList</span><span class="params">(List&lt;? extends Terms.Bucket&gt; buckets)</span> &#123;</span><br><span class="line">        List&lt;String&gt; keywordList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">keyAsString</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">            keywordList.add(keyAsString);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> keywordList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//过滤</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerFilter</span><span class="params">(RequestParam requestParam, SearchRequest searchRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (requestParam != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> requestParam.getKey();</span><br><span class="line">            <span class="comment">//健壮性判断 ---&gt; 如果 key 为空或者为空字符串则查询全部，否则进行全文检索</span></span><br><span class="line">            <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">            <span class="keyword">if</span> (key == <span class="literal">null</span> || <span class="string">&quot;&quot;</span>.equals(key))</span><br><span class="line">                searchRequest.source().query(boolQuery.must(QueryBuilders.matchAllQuery()));</span><br><span class="line">            <span class="keyword">else</span> searchRequest.source().query(boolQuery.must(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, key)));</span><br><span class="line">            <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> requestParam.getCity();</span><br><span class="line">            <span class="type">String</span> <span class="variable">brand</span> <span class="operator">=</span> requestParam.getBrand();</span><br><span class="line">            <span class="type">String</span> <span class="variable">starName</span> <span class="operator">=</span> requestParam.getStarName();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">minPrice</span> <span class="operator">=</span> requestParam.getMinPrice();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">maxPrice</span> <span class="operator">=</span> requestParam.getMaxPrice();</span><br><span class="line">            <span class="type">String</span> <span class="variable">location</span> <span class="operator">=</span> requestParam.getLocation();</span><br><span class="line">            <span class="comment">//健壮性判断 ---&gt; 如果 key 为空或者为空字符串则查询全部，否则进行全文检索</span></span><br><span class="line">            <span class="keyword">if</span> (city != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(city)) &#123;</span><br><span class="line">                searchRequest.source().query(boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;city&quot;</span>, city)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (brand != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(brand)) &#123;</span><br><span class="line">                searchRequest.source().query(boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;brand&quot;</span>, brand)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (starName != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(starName)) &#123;</span><br><span class="line">                searchRequest.source().query(boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;starName&quot;</span>, starName)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (minPrice != <span class="literal">null</span> &amp;&amp; maxPrice != <span class="literal">null</span>) &#123;</span><br><span class="line">                searchRequest.source().query(boolQuery.filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).lte(maxPrice).gte(minPrice)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (location != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(location)) &#123;</span><br><span class="line">                searchRequest.source().sort(SortBuilders.geoDistanceSort(<span class="string">&quot;location&quot;</span>, <span class="keyword">new</span> <span class="title class_">GeoPoint</span>(location)).unit(DistanceUnit.KILOMETERS).order(SortOrder.ASC));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">FunctionScoreQueryBuilder</span> <span class="variable">functionScoreQuery</span> <span class="operator">=</span> QueryBuilders.functionScoreQuery(boolQuery, <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder[]&#123;</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder(QueryBuilders.termQuery(<span class="string">&quot;isAD&quot;</span>, <span class="literal">true</span>), ScoreFunctionBuilders.weightFactorFunction(<span class="number">10</span>))</span><br><span class="line">            &#125;);</span><br><span class="line">            searchRequest.source().query(functionScoreQuery);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装处理请求的函数</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">handleSearchResult</span><span class="params">(SearchResponse searchResponse)</span> &#123;</span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>();</span><br><span class="line">        pageResult.setTotal(searchResponse.getHits().getTotalHits().value);</span><br><span class="line">        SearchHit[] hits = searchResponse.getHits().getHits();</span><br><span class="line">        List&lt;HotelDoc&gt; hotelDocList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">            <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, HotelDoc.class);</span><br><span class="line">            <span class="keyword">if</span> (hit.getSortValues().length &gt; <span class="number">0</span>) hotelDoc.setDistance(hit.getSortValues()[<span class="number">0</span>]);</span><br><span class="line">            hotelDocList.add(hotelDoc);</span><br><span class="line">        &#125;</span><br><span class="line">        pageResult.setHotels(hotelDocList);</span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/478f58aa8c3f4cbfa14879a2539eb0b4.png" alt="img"></p>
<h3 id="15-18-自动补全"><a href="#15-18-自动补全" class="headerlink" title="15.18 自动补全"></a>15.18 自动补全</h3><p>用户在搜索框输入字符时，我们应该提示出与该字符有关的搜索项，提示完整词条的功能，就是自动补全了。</p>
<h4 id="15-18-1-拼音分词器"><a href="#15-18-1-拼音分词器" class="headerlink" title="15.18.1 拼音分词器"></a>15.18.1 拼音分词器</h4><p>如果我们需要根据拼音字母来推断，因此要用到拼音分词功能。要实现根据字母做补全，就必须对文档按照拼音分词。插件地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-pinyin">https://github.com/medcl/elasticsearch-analysis-pinyin</a></p>
<p>将该压缩包解压之后上传至数据卷，查看数据卷位置可使用如下代码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume inspect es-plugins</span><br></pre></td></tr></table></figure>

<p>上传后重启<code>ElasticSearch</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart 2b29dc422080[es 容器 <span class="built_in">id</span>]</span><br></pre></td></tr></table></figure>

<p>测试拼音分词器：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;爱干净住汉庭&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;analyzer:&quot;</span>pinyin<span class="string">&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ai&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;agjzht&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;gan&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;jing&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;zhu&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;han&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ting&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器。</p>
<p><code>ElasticSearch</code>中分词器<code>（analyzer）</code>的组成包含三部分：</p>
<ul>
<li><code>character filters</code>：在<code>tokenizer</code>之前对文本进行处理。例如删除字符、替换字符</li>
<li><code>tokenizer</code>：将文本按照一定的规则切割成词条<code>(term)</code>。例如<code>keyword</code>，就是不分词的，<code>ik_smart</code>也是</li>
<li><code>tokenizer filter</code>：将<code>tokenizer</code>输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211023021451.png" alt="img"></p>
<p>声明自定义分词器的语法如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT /test</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 自定义分词器</span></span><br><span class="line">        <span class="attr">&quot;my_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  <span class="comment">// 分词器名称</span></span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;py&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 自定义tokenizer filter</span></span><br><span class="line">        <span class="attr">&quot;py&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 过滤器名称</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin&quot;</span><span class="punctuation">,</span> <span class="comment">// 过滤器类型，这里是pinyin</span></span><br><span class="line">		  <span class="attr">&quot;keep_full_pinyin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;keep_joined_full_pinyin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;keep_original&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;limit_first_letter_length&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;remove_duplicated_term&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;none_chinese_pinyin_tokenize&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_analyzer&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /test/_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;爱干净住汉庭&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span><span class="string">&quot;my_analyzer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>测试结果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/1ac0d9c134274fcaab6de0599aa48005.png" alt="img"></p>
<p><font color="red"><strong>注意：为了避免搜索到同音字，搜索时不要使用拼音分词器</strong></font></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211023022355.png" alt="img"></p>
<p><code>ElasticSearch</code>提供了 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html">Completion Suggester</a> 查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回；为了提高补全查询的效率，对于文档中字段的类型有一些约束。</p>
<ul>
<li>参与补全查询的字段必须是<code>completion</code>类型。</li>
<li>字段的内容一般是用来补全的多个词条形成的数组。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT test</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;completion&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后插入下面的数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例数据</span></span><br><span class="line">POST test/_doc</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Sony&quot;</span><span class="punctuation">,</span> <span class="string">&quot;WH-1000XM3&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">POST test/_doc</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;SK-II&quot;</span><span class="punctuation">,</span> <span class="string">&quot;PITERA&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">POST test/_doc</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Nintendo&quot;</span><span class="punctuation">,</span> <span class="string">&quot;switch&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询的 DSL 语句如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自动补全查询</span></span><br><span class="line">GET /test/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title_suggest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s&quot;</span><span class="punctuation">,</span> <span class="comment">// 关键字</span></span><br><span class="line">      <span class="attr">&quot;completion&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;title&quot;</span><span class="punctuation">,</span> <span class="comment">// 补全查询的字段</span></span><br><span class="line">        <span class="attr">&quot;skip_duplicates&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> <span class="comment">// 跳过重复的</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span> <span class="comment">// 获取前10条结果</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>之前的酒店索引库是不存在拼音分词器的，所以需要重建索引库：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 酒店数据索引库</span></span><br><span class="line">PUT /hotel</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;text_anlyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;py&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;completion_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;py&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;py&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;keep_full_pinyin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;keep_joined_full_pinyin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;keep_original&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;limit_first_letter_length&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;remove_duplicated_term&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;none_chinese_pinyin_tokenize&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text_anlyzer&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;starName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;business&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text_anlyzer&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;suggestion&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;completion&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;completion_analyzer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong><code>JavaAPI</code></strong></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20211025113007.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025113007.png" alt="img"></a></p>
<p>解析响应的代码如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025113011.png" alt="img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025113011.png"></p>
<h3 id="15-19-数据同步"><a href="#15-19-数据同步" class="headerlink" title="15.19 数据同步"></a>15.19 数据同步</h3><p><code>ElasticSearch</code>中的数据来自于<code>MySQL</code>数据库，因此<code>MySQL</code>数据发生改变时，<code>ElasticSearch</code>也必须跟着改变，这个就是<code>ElasticSearch</code>与<code>MySQL</code>之间的<strong>数据同步</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163219.png" alt="img"></p>
<p>常见的数据同步方案有三种：</p>
<ol>
<li>同步调用</li>
<li>异步通知</li>
<li>监听<code>binlog</code></li>
</ol>
<h4 id="15-19-1-同步调用"><a href="#15-19-1-同步调用" class="headerlink" title="15.19.1 同步调用"></a>15.19.1 同步调用</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163313.png" alt="img"></p>
<ul>
<li><code>hotel-demo</code>对外提供接口，用来修改<code>elasticsearch</code>中的数据</li>
<li>酒店管理服务在完成数据库操作后，直接调用<code>hotel-demo</code>提供的接口</li>
</ul>
<p><strong>优点：实现简单、粗暴</strong></p>
<p><strong>缺点：业务耦合度高</strong></p>
<h4 id="15-19-2-异步通知"><a href="#15-19-2-异步通知" class="headerlink" title="15.19.2 异步通知"></a>15.19.2 异步通知</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163346.png" alt="img"></p>
<ul>
<li><code>hotel-admin</code>对<code>MySQL</code>数据库数据完成增、删、改后，发送<code>MQ</code>消息</li>
<li><code>hotel-demo</code>监听<code>MQ</code>，接收到消息后完成<code>ElasticSearch</code>数据修改</li>
</ul>
<p><strong>优点：低耦合，实现难度一般</strong></p>
<p><strong>缺点：依赖<code>MQ</code>的可靠性</strong></p>
<p>异步通知的实现方式：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163734.png" alt="img"></p>
<ol>
<li><p>引入<code>RabbitMQ</code>依赖，记得修改配置文件<code>application.yml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--amqp--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建交换机、队列名称信息【增改其实是一类消息】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQConstants</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">HOTEL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;hotel.topic&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听新增和修改的队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">HOTEL_INSERT_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;hotel.insert.queue&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听删除的队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">HOTEL_DELETE_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;hotel.delete.queue&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增或修改的RoutingKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">HOTEL_INSERT_KEY</span> <span class="operator">=</span> <span class="string">&quot;hotel.insert&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除的RoutingKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">HOTEL_DELETE_KEY</span> <span class="operator">=</span> <span class="string">&quot;hotel.delete&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置交换机、队列对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TopicExchange <span class="title function_">topicExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(MqConstants.HOTEL_EXCHANGE, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">insertQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(MqConstants.HOTEL_INSERT_QUEUE, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">deleteQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(MqConstants.HOTEL_DELETE_QUEUE, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">insertQueueBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(insertQueue()).to(topicExchange()).with(MqConstants.HOTEL_INSERT_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">deleteQueueBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(deleteQueue()).to(topicExchange()).with(MqConstants.HOTEL_DELETE_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送消息【在前端发送增删改<code>MySQL</code>数据的时候就更新<code>ElasticSearch</code>，可以在<code>Controller</code>层完成发送，三个地方】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">update:</span><br><span class="line">rabbitTemplate.convertAndSend(MQConstants.HOTEL_EXCHANGE, MQConstants.HOTEL_INSERT_KEY, hotel.getId());</span><br><span class="line"></span><br><span class="line">insert:</span><br><span class="line">rabbitTemplate.convertAndSend(MQConstants.HOTEL_EXCHANGE, MQConstants.HOTEL_INSERT_KEY, hotel.getId());</span><br><span class="line"></span><br><span class="line">delete:</span><br><span class="line">rabbitTemplate.convertAndSend(MQConstants.HOTEL_EXCHANGE, MQConstants.HOTEL_DELETE_KEY, id);</span><br></pre></td></tr></table></figure>
</li>
<li><p>接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HotelService hotelService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听酒店新增或修改的业务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 酒店id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = MqConstants.HOTEL_INSERT_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenHotelInsertOrUpdate</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        hotelService.insertById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听酒店删除的业务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 酒店id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = MqConstants.HOTEL_DELETE_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenHotelDelete</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        hotelService.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">//增加跟修改都可以在这里完成</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 根据id查询酒店数据</span></span><br><span class="line">        <span class="type">Hotel</span> <span class="variable">hotel</span> <span class="operator">=</span> getById(id);</span><br><span class="line">        <span class="comment">// 转换为文档类型</span></span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotelDoc</span>(hotel);</span><br><span class="line">        <span class="type">IndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;hotel&quot;</span>).id(hotel.getId().toString());</span><br><span class="line">        request.source(JSON.toJSONString(hotelDoc), XContentType.JSON);</span><br><span class="line">        client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">DeleteRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(<span class="string">&quot;hotel&quot;</span>, id.toString());</span><br><span class="line">        client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="15-19-3-监听binlog"><a href="#15-19-3-监听binlog" class="headerlink" title="15.19.3 监听binlog"></a>15.19.3 监听<code>binlog</code></h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163428.png" alt="img"></p>
<ul>
<li><code>MySQL</code>开启<code>binlog</code>功能</li>
<li><code>MySQL</code>完成增、删、改操作都会记录在<code>binlog</code>中</li>
<li><code>hotel-demo</code>基于<code>canal</code>监听<code>binlog</code>变化，实时更新<code>ElasticSearch</code>中的内容</li>
</ul>
<p><strong>优点：完全解除服务间耦合</strong></p>
<p><strong>缺点：开启<code>binlog</code>增加数据库负担、实现复杂度高</strong></p>
<h3 id="15-20-ElasticSearch集群"><a href="#15-20-ElasticSearch集群" class="headerlink" title="15.20 ElasticSearch集群"></a>15.20 <code>ElasticSearch</code>集群</h3><p>单机的<code>Elasticsearch</code>做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。</p>
<ul>
<li>解决海量数据存储问题：将索引库从逻辑上拆分为<code>N</code>个分片<code>shard</code>存储到多个节点</li>
<li>单点故障问题：将分片数据在<strong>不同节点</strong>备份<code>replica</code>，比如分片一放到第二个节点，分片三放到第三个节点</li>
</ul>
<h4 id="15-20-1-ElasticSearch集群相关概念"><a href="#15-20-1-ElasticSearch集群相关概念" class="headerlink" title="15.20.1 ElasticSearch集群相关概念"></a>15.20.1 <code>ElasticSearch</code>集群相关概念</h4><ul>
<li><p>集群<code>(cluster)</code>：一组拥有共同的<code>cluster name</code>的节点。</p>
</li>
<li><p>节点<code>(node)</code>：集群中的一个<code>ElasticSearch</code>实例</p>
</li>
<li><p>分片<code>(shard)</code>：索引可以被拆分为不同的部分进行存储，拆分的部分称之为分片<code>shard</code>。在集群环境下，一个索引的不同分片可以拆分到不同的节点中，解决数据量太大，单点存储量有限的问题。</p>
<p>如下图，我们把索引库数据分成<code>3</code>片：<code>shard0</code>、<code>shard1</code>、<code>shard2</code>，除此之外分片还有主分片跟副本分片的概念：</p>
<ul>
<li><p>主分片<code>（Primary shard）</code>：相对于副本分片的定义。</p>
</li>
<li><p>副本分片<code>（Replica shard）</code>每个主分片可以有一个或者多个副本，数据和主分片一样</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071006783.png" alt="img"></p>
</li>
</ul>
<p>数据备份可以保证高可用，但是每个分片备份在一个节点上（即一台服务器上），所需要的节点数量就会非常多，成本太高。为了在高可用跟成本间需求平衡，可以这样操作：</p>
<ul>
<li>首先对数据分片，存储到不同节点</li>
<li>然后对每个分片进行备份，放到对方节点，<strong>完成互相备份</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071006790.png" alt="img"></p>
<p>现在，每个分片都有<code>1</code>个备份，存储在3个节点：</p>
<ul>
<li><code>node0</code>：保存了分片<code>0</code>和<code>1</code></li>
<li><code>node1</code>：保存了分片<code>0</code>和<code>2</code></li>
<li><code>node2</code>：保存了分片<code>1</code>和<code>2</code></li>
</ul>
<h4 id="15-20-2-搭建ElasticSearch集群"><a href="#15-20-2-搭建ElasticSearch集群" class="headerlink" title="15.20.2 搭建ElasticSearch集群"></a>15.20.2 搭建<code>ElasticSearch</code>集群</h4><p>我们会在单机上利用<code>Docker</code>容器运行多个<code>Elasticsearch</code>实例来模拟集群。可以直接使用<code>docker-compose</code>来完成，这要求你的<code>Linux</code>虚拟机至少有**<code>4G</code>**以上的内存空间。</p>
<p><code>docker-compose.yml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2.2&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">es01:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch:7.12.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es01</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es01</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-docker-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01,es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data01:/usr/share/elasticsearch/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9200</span><span class="string">:9200</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elastic</span></span><br><span class="line">  <span class="attr">es02:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch:7.12.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es02</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es02</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-docker-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es01,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01,es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data02:/usr/share/elasticsearch/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9201</span><span class="string">:9200</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elastic</span></span><br><span class="line">  <span class="attr">es03:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch:7.12.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es03</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-docker-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es01,es02</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01,es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data03:/usr/share/elasticsearch/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elastic</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9202</span><span class="string">:9200</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">data01:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">data02:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">data03:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">elastic:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>

<p>修改 Linux 系统权限，修改 <code>/etc/sysctl.conf</code> 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<p>添加下面的内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<p>让配置生效：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<p>通过docker-compose启动集群</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h4 id="15-20-3-ElasticSearch集群状态监控"><a href="#15-20-3-ElasticSearch集群状态监控" class="headerlink" title="15.20.3 ElasticSearch集群状态监控"></a>15.20.3 <code>ElasticSearch</code>集群状态监控</h4><p><code>kibana</code>可以监控<code>Elasticsearch</code>集群，但是更推荐使用<code>[cerebro]</code>(<a target="_blank" rel="noopener" href="https://github.com/lmenezes/cerebro)%E4%B8%8B%E8%BD%BD%E8%A7%A3%E5%8E%8B%E6%89%93%E5%BC%80%60/bin/cerebro.bat%60%EF%BC%8C%E8%AE%BF%E9%97%AE">https://github.com/lmenezes/cerebro)下载解压打开`/bin/cerebro.bat`，访问</a> <a target="_blank" rel="noopener" href="http://localhost:9000/">http://localhost:9000</a> 即可进入管理界面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071018030.png" alt="img"></p>
<p>输入任意节点的地址和端口，点击<code>connect</code>：绿色的线条代表集群处于绿色（健康状态）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071018761.png" alt="img"></p>
<h4 id="15-20-4-使用cerebro创建索引库"><a href="#15-20-4-使用cerebro创建索引库" class="headerlink" title="15.20.4 使用cerebro创建索引库"></a>15.20.4 使用<code>cerebro</code>创建索引库</h4><p>创建索引库：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071020771.png"></p>
<p>填写索引库信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071023380.png" alt="img"></p>
<p>回到首页，即可查看索引库分片效果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071024397.png" alt="img"></p>
<h4 id="15-20-5-ElaticSearch集群职责划分"><a href="#15-20-5-ElaticSearch集群职责划分" class="headerlink" title="15.20.5 ElaticSearch集群职责划分"></a>15.20.5 <code>ElaticSearch</code>集群职责划分</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071029258.png" alt="img"></p>
<p><strong>默认情况下，集群中的任何一个节点都同时兼职上述四种角色。</strong></p>
<p>真实的集群一定要将集群职责分离：</p>
<ul>
<li><code>master</code>节点：对<code>CPU</code>要求高，但是内存要求低</li>
<li><code>data</code>节点：对<code>CPU</code>和内存要求都高</li>
<li><code>coordinating</code>节点：对网络带宽、<code>CPU</code>要求高</li>
</ul>
<p>职责分离可以让我们根据不同节点的需求分配不同的硬件去部署。而且避免业务之间的互相干扰。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071029263.png" alt="img"></p>
<h4 id="15-20-6-ElasticSearch集群脑裂问题"><a href="#15-20-6-ElasticSearch集群脑裂问题" class="headerlink" title="15.20.6 ElasticSearch集群脑裂问题"></a>15.20.6 <code>ElasticSearch</code>集群脑裂问题</h4><p>在<code>ElasticSearch 7.x</code>之后已经默认解决了脑裂问题，所以简单了解下知道原理即可，不用做任何的操作。</p>
<p>脑裂是因为集群中的节点失联导致的。例如一个集群中，因为网络阻塞等原因导致主节点<code>node1</code>与其它节点失联。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071029267.png" alt="img"></p>
<p>此时，<code>node2</code>和<code>node3</code>认为<code>node1</code>宕机，就会重新选主。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071344676.png" alt="img"></p>
<p>当<code>node3</code>当选后，集群继续对外提供服务，<code>node2</code>和<code>node3</code>自成集群，<code>node1</code>自成集群，两个集群数据不同步，出现数据差异。当网络恢复后，因为集群中有两个<code>master</code>节点，集群状态的不一致，出现脑裂的情况。一下子出现了两个主节点，这样的情况脑子都裂开了，所以称为脑裂问题。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071344829.png" alt="img"></p>
<p>解决脑裂的方案是，要求选票超过 <strong>(<code>eligible</code>节点数量+1)&#x2F;2</strong> 才能当选为<code>master</code>，<code>eligible</code>就是候选节点，有资格成为主节点的就是候选节点，候选节点的数量加上<code>1</code>除以<code>2</code>就是选票，当所有的票数超过选票就选择该节点为主节点。比如这里：<code>node1</code>是一个主节点，<code>node2</code>和<code>node3</code>是一组候选节点，当选票为：<code>4/2 = 2</code>所以当选票为<code>&gt;= 2</code>时可以升为主节点，因为<code>node1</code>只有<code>1</code>票，而<code>node2 node3</code>有<code>2</code>票，所以最终结果是<code>node3</code>当上了主节点<code>master</code>。</p>
<p>对应配置项是<code>discovery.zen.minimum_master_nodes</code>，在版本 7.0 以后，已经成为默认配置，因此一般不会发生脑裂问题。</p>
<h4 id="15-20-7-ElasticSearch集群分布式存储"><a href="#15-20-7-ElasticSearch集群分布式存储" class="headerlink" title="15.20.7 ElasticSearch集群分布式存储"></a>15.20.7 <code>ElasticSearch</code>集群分布式存储</h4><p>当新增文档时，应该保存到不同分片，保证数据均衡，那么<code>coordinating node</code>如何确定数据该存储到哪个分片呢？<code>coordinating node</code>就是用来做请求路由，负载均衡的。它该如何确定数据存储到哪个分片<code>shard</code>呢？</p>
<p><code>ElasticSearch</code>会通过<code>hash</code>算法来计算文档应该存储到哪个分片：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071412275.png" alt="img"></p>
<ul>
<li><code>_routing</code>默认是文档的<code>id</code></li>
<li>算法与分片数量有关，因此索引库一旦创建，分片数量不能修改</li>
</ul>
<p>新增的一个文档将存储到哪个分片的流程如下：</p>
<ol>
<li>新增一个<code>id=1</code>的文档</li>
<li>对<code>id</code>做<code>hash</code>运算，假如得到的是<code>2</code>，则应该存储到<code>shard-2</code></li>
<li><code>shard-2</code>的主分片在<code>node3</code>节点，将数据路由到<code>node3</code>，<code>node3</code>保存文档</li>
<li>同步给<code>shard-2</code>的副本分片<code>2(R-2)</code>，在<code>node2</code>节点</li>
<li>返回结果给<code>coordinating-node</code>节点<code>(node1)</code></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071412283.png" alt="img"></p>
<h4 id="15-20-8-ElasticSearch集群分布式查询"><a href="#15-20-8-ElasticSearch集群分布式查询" class="headerlink" title="15.20.8 ElasticSearch集群分布式查询"></a>15.20.8 <code>ElasticSearch</code>集群分布式查询</h4><p><code>ElasticSearch</code>查询分成两个阶段：</p>
<ul>
<li><code>scatter phase</code>：分散阶段，<code>coordinating node</code>会把请求分发到每一个分片。</li>
<li><code>gather phase</code>：聚集阶段，<code>coordinating node</code>汇总<code>data node</code>的搜索结果，并处理为最终结果集返回给用户。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071422105.png" alt="img"></p>
<h4 id="15-20-9-ElasticSearch集群故障转移"><a href="#15-20-9-ElasticSearch集群故障转移" class="headerlink" title="15.20.9 ElasticSearch集群故障转移"></a>15.20.9 <code>ElasticSearch</code>集群故障转移</h4><p>集群的<code>master</code>节点即主节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。</p>
<p>例如一个集群结构如图，三个都是健康的，标星星的代表主节点<code>master</code>其它两个节点是从节点。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071516134.png" alt="img"></p>
<p>突然，<code>node1</code>发生了故障。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071516139.png" alt="img"></p>
<p>宕机后的第一件事，需要重新选主，例如选中了<code>node2</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071516685.png" alt="img"></p>
<p><code>node2</code>成为主节点后，会检测集群监控状态，将<code>node1</code>上的数据迁移到<code>node2</code>、<code>node3</code>，确保数据依旧正常访问。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205071516805.png" alt="img"></p>
<p>模拟话可以使用：<code>docker-compose stop es01</code>来模仿，然后观察<code>cerebro</code>的监控信息，后面再次启动<code>es01</code>时可以看到虽然不能再次称为主节点<code>master</code>但是可以将分散的数据恢复到<code>es01</code>中。</p>
<h2 id="16-微服务保护"><a href="#16-微服务保护" class="headerlink" title="16. 微服务保护"></a>16. 微服务保护</h2><h3 id="16-1-初识Sentinel"><a href="#16-1-初识Sentinel" class="headerlink" title="16.1 初识Sentinel"></a>16.1 初识<code>Sentinel</code></h3><h4 id="16-1-1-什么是雪崩问题？"><a href="#16-1-1-什么是雪崩问题？" class="headerlink" title="16.1.1 什么是雪崩问题？"></a>16.1.1 什么是雪崩问题？</h4><p>在服务集群中，一个微服务会依赖于许多其它微服务。比如下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/6f184cd13cce4aab9aff8ca2cbe374e9.png" alt="img"></p>
<p>但是现在服务<code>D</code>出现了故障，所以导致服务<code>A</code>需要服务<code>D</code>的通道被阻塞了无法正常运行。服务<code>A</code>对于服务<code>D</code>的请求肯定不止一个，随着时间的推移，服务<code>A</code>对于服务<code>D</code>的请求将会越来越多越来越多。<code>Tomcat</code>资源总有会被耗尽的时候，那么就会导致依赖于<code>D</code>服务的<code>A</code>服务总有一天也会崩掉，出现故障。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/124feeeeb22c4beab0499e683ab56a0d.png" alt="img"></p>
<p>要知道，在微服务架构的服务集群中，这样的依赖与被依赖的关系可能有成千上百个，所以一旦某个微服务出现故障后其依赖于它的微服务出现故障，就会一个接着一个的出现故障，这样出现故障的微服务会越来越多越来越多，一发不可收拾，这就是微服务<strong>雪崩问题</strong>。</p>
<p>具体说明下雪崩问题：**<font color="red">微服务调用链路中的某个服务出现故障从而引起整个链路所有的微服务都不可用</font>**，这就是雪崩问题。</p>
<h4 id="16-1-2-解决雪崩问题"><a href="#16-1-2-解决雪崩问题" class="headerlink" title="16.1.2 解决雪崩问题"></a>16.1.2 解决雪崩问题</h4><p>解决雪崩问题的常见方式有四种：</p>
<ol>
<li><p>**<font color="red">超时处理</font>**：设定超时时间，请求的时间超过所设定的超时时间代表没有响应此时返回错误信息，并不无休止等待。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/19489e6351074a17ab0b8e207808a9d8.png" alt="img"></p>
<p>超时处理的这种方式只能缓解雪崩问题，因为你设定超时时间本身就需要时间，假设你请求超时时间为<code>0.1s</code>，但是就是在这等待响应的<code>0.1s</code>之内有上亿个请求进来需要访问，也就是进入请求的速度和数量远大于你的超时时间，那你的微服务同样会跨，从而同样会导致雪崩问题，所以只能说是缓解了雪崩问题而无法说解决了雪崩问题。<strong>【已经出现故障了】</strong></p>
</li>
<li><p>**<font color="red">舱壁模式</font>**：先解释下什么是舱壁，就是一艘大轮船它会用隔板将船舱一块一块的隔开，形成舱壁，如果此时大轮船撞击到了一块冰山，导致船舱进水，但是因为有舱壁的存在，船舱只是部分进水并不会影响大轮船整体，这就像是护城河。</p>
<p>类似地，在程序设计中可以限定每个微服务使用线程的数量，避免耗尽服务器【比如<code>Tomcat</code>】资源，因此也叫线程隔离。整个微服务就是整个服务器【比如<code>Tomcat</code>】就可以看作是整艘大轮船，整个服务集群就是船舱，限定每个微服务使用的线程数量就是加上挡板，形成舱壁。这样当某个微服务出现故障挂掉的时候也不至于出现微服务雪崩的现象。舱壁模式也可以叫做线程隔离、线程限制。<strong>【已经出现故障了】</strong></p>
<p>舱壁模式解决了超时处理的问题，就是杜绝了雪崩问题，而超时处理只是缓解，但是舱壁模式也存在不足的地方：假设现在某个微服务比如<code>C</code>服务挂掉了，因为发送请求的服务比如<code>A</code>服务有线程数量，所以它还是会去访问<code>C</code>服务，但是此时<code>C</code>服务已经挂掉了所以这样的访问显然非常浪费资源。</p>
<p>如果我结合舱壁模式+超时处理是不是可以更好的处理雪崩问题？</p>
<p>这样的想法挺不错的，但是考虑下极端情况，我虽然设定了超时处理，但是我在很短很短的时间内容，比如超时时间是<code>0.00001s</code>但是我在<code>0.00001s</code>之内的请求数量就占满了限定的线程数，所以这样做仍然无法解决资源浪费的问题。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/b390bcf2022b4193aa5eb2d4b615c67f.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/7b13cd211fb2426e95b9ffb895f16877.png" alt="img"></p>
</li>
<li><p><strong><font color="red">熔断降级</font><strong>：由</strong>断路器</strong>统计业务的异常比例，如果<strong>超出阈值</strong>就会<strong>熔断</strong>该业务，拦截访问该业务的一切请求。比如发了三次请求，<code>1</code>次成功<code>2</code>次失败，则比例达到<code>60%</code>假设设定的阈值为<code>50%</code>此时断路器就会执行熔断操作。熔断有三种状态，关闭开放半开放，半开放回去尝试连接服务看下请求的服务是否回复正常。<strong>【已经出现故障了】</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/12d218ae339b4b358db3f7e2b31f35bd.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/9e0e8494c35943fa96ad8c51e9d3a084.png" alt="img"></p>
</li>
<li><p>**<font color="red">流量控制</font>**：限制业务访问的<code>QPS</code>【每秒处理请求数量】，避免服务因流量的突增而故障。此时就可以使用到<code>Sentinal</code>了。这就相当于把雪崩问题扼杀在摇篮之中。<code>Sentinel</code>就是专门用来做做流量控制的一个框架。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/14c9744063fd4f6a9ba4cf07192409a9.png" alt="img"></p>
</li>
</ol>
<p>总结：</p>
<ul>
<li>如何避免因瞬间高并发而导致服务故障？ —&gt; 流量控制【预防】</li>
<li>如何避免因服务故障引起雪崩问题？ —&gt; 超时处理、舱壁模式、熔断降级【<strong>船舱超时导致保险丝熔断</strong>】【补救】</li>
</ul>
<h3 id="16-2-微服务保护技术对比"><a href="#16-2-微服务保护技术对比" class="headerlink" title="16.2 微服务保护技术对比"></a>16.2 微服务保护技术对比</h3><p>在SpringCloud当中支持多种服务保护技术：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix"><code>Netfix Hystrix</code></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel"><code>Sentinel</code></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/resilience4j/resilience4j"><code>Resilience4J</code></a></li>
</ul>
<p>早期比较流行的是<code>Hystrix</code>框架，但目前国内实用最广泛的还是阿里巴巴的<code>Sentinel</code>框架，这里我们做下对比。</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>Sentinel</strong></th>
<th><strong><code>Hystrix</code></strong></th>
</tr>
</thead>
<tbody><tr>
<td>隔离策略</td>
<td>信号量隔离</td>
<td>线程池隔离&#x2F;信号量隔离</td>
</tr>
<tr>
<td>熔断降级策略</td>
<td>基于慢调用比例或异常比例</td>
<td>基于失败比率</td>
</tr>
<tr>
<td>实时指标实现</td>
<td>滑动窗口</td>
<td>滑动窗口（基于<code>RxJava</code>）</td>
</tr>
<tr>
<td>规则配置</td>
<td>支持多种数据源</td>
<td>支持多种数据源</td>
</tr>
<tr>
<td>扩展性</td>
<td>多个扩展点</td>
<td>插件的形式</td>
</tr>
<tr>
<td>基于注解的支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>限流</td>
<td>基于<code>QPS</code>，支持基于调用关系的限流</td>
<td>有限的支持</td>
</tr>
<tr>
<td>流量整形</td>
<td>支持慢启动、匀速排队模式</td>
<td>不支持</td>
</tr>
<tr>
<td>系统自适应保护</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>控制台</td>
<td>开箱即用，可配置规则、查看秒级监控、机器发现等</td>
<td>不完善</td>
</tr>
<tr>
<td>常见框架的适配</td>
<td><code>Servlet、Spring Cloud、Dubbo、gRPC</code>等</td>
<td><code>Servlet、Spring Cloud Netflix</code></td>
</tr>
</tbody></table>
<h3 id="16-3-Sentinel介绍和安装"><a href="#16-3-Sentinel介绍和安装" class="headerlink" title="16.3 Sentinel介绍和安装"></a>16.3 <code>Sentinel</code>介绍和安装</h3><p>•<strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</p>
<p>•<strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p>
<p>•<strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架&#x2F;库的整合模块，例如与 Spring Cloud、<code>Dubbo</code>、<code>gRPC</code> 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</p>
<p>•<strong>完善的</strong> <strong><code>SPI</code></strong> <strong>扩展点</strong>：Sentinel 提供简单易用、完善的 <code>SPI</code> 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p>
<p>安装可以参考下列：</p>
<ol>
<li><p>下载</p>
<p>sentinel官方提供了<code>UI</code>控制台，方便我们对系统做限流设置。大家可以在<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases%E4%B8%8B%E8%BD%BD%E3%80%82%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E8%B5%84%E6%96%99%E4%B8%8B%E8%BD%BD%E5%A5%BD%E7%9A%84%60jar%60%E5%8C%85%E3%80%82">https://github.com/alibaba/Sentinel/releases下载。也可以直接使用资料下载好的`jar`包。</a></p>
</li>
<li><p>运行</p>
<p>将jar包放到任意非中文目录，执行命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar sentinel-dashboard-1.8.1.jar</span><br></pre></td></tr></table></figure>

<p>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：</p>
<table>
<thead>
<tr>
<th><strong>配置项</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>server.port</td>
<td>8080</td>
<td>服务端口</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.username</td>
<td>sentinel</td>
<td>默认用户名</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.password</td>
<td>sentinel</td>
<td>默认密码</td>
</tr>
</tbody></table>
<p>例如，修改端口：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8090 -jar sentinel-dashboard-1.8.1.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问</p>
<p>访问<a href="http://localhost:8080页面，就可以看到sentinel的控制台了：需要输入账号和密码，默认都是：sentinel，发现一片空白，什么都没有，这是因为我们还没有与微服务整合。">http://localhost:8080页面，就可以看到sentinel的控制台了：需要输入账号和密码，默认都是：sentinel，发现一片空白，什么都没有，这是因为我们还没有与微服务整合。</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/61b20a143deb4ef59fcec224295b4e48.png" alt="img"></p>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/2ad9787f4cff418f959a6d3da2e624e6.png" alt="img"></p>
<p>也可以到<code>hub.docker</code>使用<code>docker</code>进行安装：</p>
<ol>
<li><code>docker pull bladex/sentinel-dashboard:1.8.0</code></li>
<li><code>docker run --name sentinel  -d -p 8858:8858 -d  bladex/sentinel-dashboard:1.8.0</code></li>
<li>访问<code>http://192.168.56.1:8858</code></li>
</ol>
<h3 id="16-4-SpringBoot整合Sentinel"><a href="#16-4-SpringBoot整合Sentinel" class="headerlink" title="16.4 SpringBoot整合Sentinel"></a>16.4 <code>SpringBoot</code>整合<code>Sentinel</code></h3><p>我们在<code>order-service</code>中整合<code>sentinel</code>，并连接<code>sentinel</code>的控制台，步骤如下：</p>
<ol>
<li><p>引入sentinel依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--sentinel--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置控制台</p>
<p>修改application.yaml文件，添加下面内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.1</span><span class="string">:8858</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>访问<code>order-service</code>的任意端点</p>
<p>打开浏览器，访问<a target="_blank" rel="noopener" href="http://localhost:8080/order/101%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E8%83%BD%E8%A7%A6%E5%8F%91%60sentinel%60%E7%9A%84%E7%9B%91%E6%8E%A7%E3%80%90%E5%88%B7%E6%96%B0%EF%BC%8C%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%E5%A4%9A%E6%AC%A1%E3%80%91%E3%80%82%E7%84%B6%E5%90%8E%E8%AE%BF%E9%97%AE%60sentinel%60%E6%8E%A7%E5%88%B6%E5%8F%B0%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%95%88%E6%9E%9C%EF%BC%9A">http://localhost:8080/order/101，这样就能触发`sentinel`的监控【刷新，发送请求多次】。然后访问`sentinel`控制台，查看效果：</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/f0708b5835f54ba4b513b4f57de0519a.png" alt="img"></p>
</li>
</ol>
<h3 id="16-5-使用Sentinel进行流量控制"><a href="#16-5-使用Sentinel进行流量控制" class="headerlink" title="16.5 使用Sentinel进行流量控制"></a>16.5 使用<code>Sentinel</code>进行流量控制</h3><blockquote>
<p>预判风险是防范风险的前提</p>
</blockquote>
<p><strong>簇点链路：</strong>以<code>SpringMVC</code>为例，当请求进入微服务时，首先会访问<code>DispatcherServlet</code>然后进入<code>Controller</code>、<code>Service</code>、<code>Mapper</code>这样的一个调用链叫做簇点链路。</p>
<p>簇点链路中每一个接口就是一个资源，默认情况下<code>Sentinel</code>会监控<code>SpringMVC</code>中的每一个端点<code>Endpoint</code>即<code>Controller</code>中的一个个方法。因此一个端点就是簇点链路中的一个资源。比如刚刚访问的<code>/order/&#123;orderId&#125;</code>就是<code>OrderController</code>中的端点。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/8b838bd995a34f318100da386bcd0913.png" alt="img"></p>
<p>无论是流量控制还是熔断降级都是针对簇点链路中的资源来设置的，可以在<code>Sentinel</code>的簇点链路设置界面设置规则。可以设定的规则一共有四种：</p>
<ol>
<li>流控：流量控制</li>
<li>降级：熔断降级</li>
<li>热点：热点参数限流，是限流的一种</li>
<li>授权：请求的权限控制</li>
</ol>
<p>比如新增流控规则：表示限制<code>/order/&#123;orderId&#125;</code>这个资源的单机<code>QPS</code>即每秒允许请求次数为<code>1</code>次，超出这个次数的请求会被拦截并报错。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/235a42cc6d4044f78cd59a4a98e788f1.png" alt="img"></p>
<p>此时如果在<code>1s</code>发送多次请求会被拒绝，并且页面会显示被<code>Sentinel</code>锁定流量控制的相关信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/a904abd8b06f4deda6c5a633f6c149a5.png" alt="img"></p>
<p>如果需要模拟高并发可以使用<code>Jmeter</code>，可以将<code>QPS</code>设置成不能超过<code>5</code>，然后测试。使用<code>JMeter</code>进行压力测试，直接打开<code>sentinel测试.jmx</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/6512cb4936054f7aa58ec552970f2252.png" alt="img"></p>
<p><strong>注意，不要点击菜单中的执行按钮来运行。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/ddfd0f1e7573424cbb9ca7d85c6deb9a.png" alt="img"></p>
<p>查看结果树结果：可以看到<code>1s</code>发送<code>10</code>次有<code>5</code>次是失败的，因为<code>QPS = 5</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/d1121346fd5946e1b0ab2b898ef12c11.png" alt="img"></p>
<h3 id="16-6-（流控模式）流量控制的三种模式"><a href="#16-6-（流控模式）流量控制的三种模式" class="headerlink" title="16.6 （流控模式）流量控制的三种模式"></a>16.6 （流控模式）流量控制的三种模式</h3><p>在添加限流规则时，点击高级选项，可以选择三种流控模式：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/5262ece0d7db42ceaa02eea89908b749.png" alt="img"></p>
<h4 id="16-6-1-直连模式"><a href="#16-6-1-直连模式" class="headerlink" title="16.6.1 直连模式"></a>16.6.1 直连模式</h4><p>直连模式就是默认的模式，我们刚刚做的实验<code>/order/&#123;orderId&#125;</code>使用的流控模式就是直连模式，这种流控模式<code>Sentinel</code>会统计当前资源的请求，触发阈值的时候就会对当前资源直接进行限流。</p>
<h4 id="16-6-2-关联模式"><a href="#16-6-2-关联模式" class="headerlink" title="16.6.2 关联模式"></a>16.6.2 关联模式</h4><p>关联模式涉及到优先级的问题，这种流控模式会统计与当前资源相关的另外一个资源的请求，当对另外一个资源的请求数量达到请求设定的阈值的时候就会触发阈值，对当前资源进行限流。</p>
<p>这样说可能稍微有点抽象，简单说就是“<strong>权力越大享用资源越多</strong>”，可以举一个例子：</p>
<ul>
<li><p>对于订单状态，通常会有两种操作，一是查询订单，二是修改订单，要知道修改订单的优先级肯定比查询订单的优先级高，而查询和修改订单的操作都会争抢数据库锁，产生竞争。所以为了避免竞争。当修改订单的请求达到阈值时证明需要修改订单的请求数量很多，那么就应该触发查询订单阈值，将查询订单这个资源进行限流。比如这样配置规则，当<code>/write</code>资源的请求数量触发阈值时，对<code>/read</code>资源进行限流从而避免影响到<code>/write</code>资源：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081602252.png" alt="img"></p>
</li>
<li><p>也就是说：对于当前资源，我设定一个阈值，当被关联的资源请求数量达到这个阈值，我就将优先级低的当前资源进行流量限流。</p>
</li>
</ul>
<p>何时使用关联模式？<strong>在满足二者存在竞争关系并且存在优先级高低之分</strong>就可以也应该使用关联模式。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081602290.png" alt="img"></p>
<p>模拟关联模式流量控制：</p>
<ol>
<li><p>在<code>OrderController</code>中新增两个端点：<code>/order/query</code>和<code>/order/update</code>，只是套个壳能接收请求即可无需实现具体业务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/query&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">query</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;查询订单成功！&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/update&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;修改订单成功！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置流控规则：当<code>/order/update QPS</code>请求数量超过<code>5</code>时，对<code>/order/query</code>进行限流。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/31b6af76fdf34266af585cfb68f4fa6f.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/17593f0679ad424ba1a3a39323b77662.png" alt="img"></p>
</li>
<li><p>使用<code>JMeter</code>进行测试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/e141bf9be46443fbbafc4aa85e964a96.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/0c016279cd034cb6b20bbe4212c521aa.png" alt="img"></p>
</li>
<li><p>启动然后<code>5</code>次请求之后浏览器查看<code>localhost:8080/order/query</code>，可以看到被限流了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/3c5e7e10dd4f4ed6a833f034c992b878.png" alt="img"></p>
</li>
</ol>
<h4 id="16-6-3-链路模式"><a href="#16-6-3-链路模式" class="headerlink" title="16.6.3 链路模式"></a>16.6.3 链路模式</h4><p> 只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</p>
<p>例如有两条请求链路</p>
<ul>
<li><code>/test1 --&gt; /common</code></li>
<li><code>/test2 --&gt; /common</code></li>
</ul>
<p>如果只希望统计从<code>/test2</code>进入到<code>/common</code>的请求，则可以这样配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081632892.png" alt="img"></p>
<p><strong>实战案例</strong></p>
<p>有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。</p>
<p><strong>链路模式中，是对不同来源的两个链路做监控。但是<code>Sentinel</code>默认会给进入<code>SpringMVC</code>的所有请求设置同一个<code>root</code>资源，会导致链路模式失效。我们需要关闭这种对<code>SpringMVC</code>的资源聚合，修改<code>order-service</code>服务的<code>application.yml</code>文件</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">web-context-unify:</span> <span class="literal">false</span> <span class="comment"># 关闭context整合</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>在<code>OrderService</code>中添加一个<code>queryGoods</code>方法，不用实现业务，因为默认<code>Service</code>服务层的方法是不被<code>Sentinel</code>所监控的，所以需要我们自己通过<code>@SentinelResource</code>注解来标记要监控的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">queryGoods</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;查询商品成功！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>OrderController</code>中，改造<code>/order/query</code>端点，调用<code>OrderService</code>中的<code>queryGoods</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/query&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">query</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> orderService.queryGoods() + <span class="string">&quot; 查询订单成功！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>OrderController</code>中添加一个<code>/order/save</code>端点，调用<code>OrderService</code>的<code>queryGoods</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> orderService.queryGoods() + <span class="string">&quot; 存储订单成功！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/122f7098ffb64d9d9fbacb37f736a68b.png" alt="img"></p>
</li>
<li><p>给<code>queryGoods</code>设置限流规则，从<code>/order/query</code>进入<code>queryGoods</code>的方法限制<code>QPS</code>必须小于<code>2</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081633212.png" alt="img"></p>
</li>
<li><p>使用<code>JMeter</code>测试：可以看到这里<code>200</code>个用户，<code>50</code>秒内发完，<code>QPS</code>为4，超过了我们设定的阈值<code>2</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081633203.png" alt="img"></p>
</li>
<li><p>一个<code>http</code>请求是访问<code>/order/save</code>，运行的结果是 &#x2F;order&#x2F;save 完全不受影响。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081858739.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081858880.png" alt="img"></p>
</li>
<li><p>访问<code>/order/query</code>，运行结果是<code>/order/query</code>，每次只有<code>2</code>个通过。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081633221.png" alt="img"></p>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081633245.png" alt="img"></p>
<h3 id="16-7-流控效果"><a href="#16-7-流控效果" class="headerlink" title="16.7 流控效果"></a>16.7 流控效果</h3><h4 id="16-7-1-快速失败"><a href="#16-7-1-快速失败" class="headerlink" title="16.7.1 快速失败"></a>16.7.1 快速失败</h4><p>细心的小伙伴会发现在流控的高级选项中，还有一个流控效果选项，前面我们的测试都是基本快速失败的。快速失败的意思就是只要请求超过设定的<code>QPS</code>阈值，就立即拒绝并抛出<code>FlowException </code>异常，是默认的处理方式。之前的案例中，都是用的是快速失败的流控效果。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205081907653.png" alt="img"></p>
<h4 id="16-7-2-Warm-Up"><a href="#16-7-2-Warm-Up" class="headerlink" title="16.7.2 Warm Up"></a>16.7.2 <code>Warm Up</code></h4><p><code>Warm Up</code>表示预热的意思，虽然也会像对超出阈值的请求做出立即拒绝并抛出异常，但是这种流控效果的阈值会动态变化，从一个较小的值主键增加到最大的阈值。</p>
<p>为什么要这么做呢？</p>
<p>因为阈值一般是一个微服务所能承担的最大的<code>QPS</code>，但是一个服务在刚刚启动的时候，一切资源尚未初始化，如果直接将<code>QPS</code>跑到最大值，可能导致服务器瞬间宕机。</p>
<p><code>Warm Up</code>预热流动效果就是用来应对冷启动服务的一种方案，请求阈值的初始值为：<code>maxThreshold / coldFactor</code>，持续指定时长之后会主键增大到<code>maxThreashold</code>，而<code>coldFactor</code>的默认值为<code>3</code>。</p>
<p>比如我的<code>QPS</code>的<code>maxThresold = 10</code>，<code>coldFactor = 3</code>，则请求阈值的初始值为：<code>10 /3 = 3</code>，持续指定时长即预热时间后，假设为<code>5s</code>，阈值会慢慢扩大到<code>10</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/160cbeee9fde4b549011f63dd1e070f7.png" alt="img"></p>
<p><strong>案例</strong>：给<code>/order/&#123;orderId&#125;</code>这个资源设置限流，最大<code>QPS</code>为<code>10</code>，利用<code>Warm Up</code>预热流动效果，预热时长为<code>5</code>秒。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/b996e06ed320424793aa9f08251ad3e9.png" alt="img"></p>
<p><code>JMeter</code>进行压力测试：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/2a313ac720dd4a359125567b175455fe.png" alt="img"></p>
<p>刚刚启动时，大部分请求失败，成功的只有<code>3</code>个，说明<code>QPS</code>被限定在<code>3</code>，然后阈值会在<code>5s</code>之内慢慢扩大到<code>10</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/05b9470ce10b4c08ac7165aaddc8f023.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/714f09cf2ac24080a5467aae53791747.png" alt="img"></p>
<p>可以到到<code>Sentinel</code>控制台查看实时监控：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/fe1c9c9dc0ac47648d232d53fb7bbeb8.png" alt="img"></p>
<p>一段时间后：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/cccb26f3a0f2424da9721f3d99e7378e.png" alt="img"></p>
<p>这种<code>Warm Up</code>预热流动效果主要应用于系统长期处于低水位的情况，当情况开始激增的时候，直接把系统拉升到高水位可能瞬间把系统压垮，通过“冷启动”可以让通过的流量缓慢增加，在一定时间内主键增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮的情况。</p>
<h4 id="16-7-3-排队等待"><a href="#16-7-3-排队等待" class="headerlink" title="16.7.3 排队等待"></a>16.7.3 排队等待</h4><p>简单了解下：排队等待就是让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205090037622.png" alt="img"></p>
<p><strong>到底什么是排队等待？</strong></p>
<p>当请求超过<code>QPS </code>阈值时，「快速失败」和 「<code>Warm Up</code>」会拒绝新的请求并抛出异常。而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。（就是先排队等，如果你等的时间太长就直接拒绝你非常人性化），排队等待这种方式严格控制了请求通过的间隔时间，即让请求以均与速度通过，对应的是<strong>漏桶算法</strong>。</p>
<p>例如：</p>
<p><code>QPS = 5</code>，在排队等待此种流控效果中意味着每<code>200ms</code>处理一个队列中的请求，<code>timeout = 2000ms</code>即最长预期等待时长为<code>2000ms</code>这个是自己设置的，如果某请求预期等待时长超过了<code>2000ms</code>则该请求就会被拒绝并抛出异常。</p>
<p>如现在一下子来了<code>12</code>个请求，因为每<code>200ms</code>执行一个请求【因为<code>QPS = 5</code>】，第一个请求不用等，第二个请求等<code>200ms</code>即可，第三个请求等<code>(3 - 1) * 200 = 400ms</code>即可，以此类推 ——&gt;</p>
<ul>
<li>第<code>06</code>个请求的预期等待时长<code> = 200 * (6 - 1) = 1000ms</code></li>
<li>第<code>12</code>个请求的预期等待时长<code> = 200 * (12-1) = 2200ms</code></li>
</ul>
<p>如果预期等待时长超过了所设置的最长等待时长，则<code>Sentinel</code>会拒绝这个请求并抛出异常。</p>
<p>现在假设流控效果不是排队等待，而使用的是快速失败，则如果现在在<code>1s</code>之内有<code>10</code>个请求，但是第<code>2s</code>只有<code>1</code>个请求，此时<code>QPS</code>的曲线是这样的：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/845d3e7edffb49f2b9ddcc96d6f02b1a.png" alt="img"></p>
<p>如果使用排队等待的流控效果，所有进入的请求都要排队，以固定的<code>200ms</code>的间隔执行，<code>QPS</code>会变的很平滑</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205090016702.png" alt="img"></p>
<p>排队等待的流控下过主要用于处理间隔性突发的流量，例如消息队列。想想一下这样的场景：</p>
<p>在某一秒突然有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲时间逐步处理这些请求，而不是在第一秒的时候就直接拒绝多余的请求，这样很不友好，此时就可以使用排队等待的流控效果。</p>
<p><strong>案例</strong>：给<code>/order/&#123;orderId&#125;</code>这个资源设置限流，最大<code>QPS</code>为<code>10</code>，利用排队等待的流控效果，超时时长设置为<code>5s</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/24f06513fe8f45f5a4e68c63e0bb6d58.png" alt="img"></p>
<p>再去<code>Sentinel</code>查看实时监控的<code>QPS</code>曲线，可以看到非常的平滑，一致保持在 10，但是超出的请求没有被拒绝，而是放入队列。因此<strong>响应时间</strong>（等待时间）会越来越长。当队列满了或者预期等待时长超过了最长等待时长之后，才会有部分请求失败。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/6a51d6ca18934985baee2ecdef60dede.png" alt="img"></p>
<h3 id="16-8-热点参数限流"><a href="#16-8-热点参数限流" class="headerlink" title="16.8 热点参数限流"></a>16.8 热点参数限流</h3><p>之前的限流是统计访问某个资源的所有请求，判断是否超过<code>QPS</code>阈值。而「热点参数限流」是<strong>分别统计参数值相同的请求</strong>，判断是否超过<code>QPS</code>阈值。【一个是所有，一个是分类讨论】</p>
<p>比如：访问<code>/goods/&#123;id&#125;</code>的请求中，<code>id</code>参数值会有变化，「热点参数限流」会根据参数值分别统计<code>QPS</code>，统计结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/43e123f1736b4f198b9abe3b84a84dbd.png" alt="img"></p>
<p>当<code>id=1</code>的请求触发阈值被限流时，<code>id</code>值不为<code>1</code>的请求则不受影响。</p>
<p>配置示例：对<code>hot</code>这个资源的<code>0</code>号参数（也就是第一个参数）做统计，每<code>1s</code><strong>相同参数值</strong>的请求数不能超过<code>5</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/1e2528acb9f64c7c80d266c6d761fe5e.png" alt="img"></p>
<p>假设上面的例子是一个商品查询接口，那么刚才的配置中，对这个接口的所有商品一视同仁，<code>QPS</code>都限定为<code>5</code>。而在实际开发过程中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的<code>QPS</code>限制与其它商品不一样，阈值高一些，那么就需要配置热点参数限流的高级选项了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2022/202205090050071.png" alt="img"></p>
<p>整体的含义就是：对<code>0</code>号的<code>long</code>类型参数限流，每<code>1</code>个相同参数的<code>QPS</code>不能超过<code>5</code>，有如下两个例外</p>
<ul>
<li>如果参数值是<code>100</code>，则每<code>1s</code>允许的<code>QPS</code>为<code>10</code></li>
<li>如果参数值是<code>101</code>，则每<code>1s</code>允许的<code>QPS</code>为 <code>15</code></li>
</ul>
<p><strong>案例需求</strong>：给<code>/order/&#123;orderId&#125;</code>这个资源添加「热点参数限流」，规则如下</p>
<ul>
<li>默认的热点参数规则是每<code>1s</code>请求量不超过<code>2</code></li>
<li>给<code>102</code>这个参数设置例外：每<code>1s</code>请求量不超过<code>4</code></li>
<li>给<code>103</code>这个参数设置例外：每<code>1s</code>请求量不超过<code>10</code></li>
</ul>
<p><strong>注意事项</strong>：热点参数限流对默认的<code>SpringMVC</code>资源无效，需要利用 <code>@SentinelResource</code>注解标记资源。所以得先让该资源出现才可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = &quot;hot&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/&#123;orderId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">queryOrderByUserId</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> orderServiceFeign.queryOrderById(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务器访问该方法，可以看到<code>hot</code>资源出现了：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/5a9e1800faf54d9f92c09981e6e1a4b0.png" alt="img"></p>
<p>对该资源进行热点参数限制：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/371b3c679f2241dca552f1bf99ca992e.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/0120868a49da4aabb33149fe27b965a3.png" alt="img"></p>
<p>此时热点参数限流就添加好了，我们使用<code>JMeter</code>进行测试，访问<code>102 103</code>的订单限流阈值分别为<code>4 10</code>其余的均为<code>2</code>：我们有<code>500</code>个用户在<code>100s</code>之内发送完毕<code>500</code>个请求，每次即每秒发送<code>5</code>个请求。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/e01ce66e0eed42678c04af8177c6f6f7.png" alt="img"></p>
<p>我们分别访问：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8080/order/101">http://localhost:8080/order/101</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8080/order/102">http://localhost:8080/order/102</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8080/order/103">http://localhost:8080/order/103</a></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/878d2d50db174df2816d28364173f3bc.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/1cb3755a9cee4bf8968d8fceb8df2988.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/2e30f84b34ed4735890ea473951c7e0d.png" alt="img"></p>
<p>然后观察结果可以看到：</p>
<ul>
<li><p><code>/order/101</code>在<code>1s</code>之内发送了<code>5</code>次请求但是只有<code>2</code>次成功其余均被拒绝，此后每<code>1s</code>均是如此。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/f72cdbe355664a959a336d98c4256c27.png" alt="img"></p>
</li>
<li><p><code>/order/102</code>在<code>1s</code>之内发送了<code>5</code>次请求但是有<code>4</code>次成功只有<code>1</code>个均被拒绝，此后每<code>1s</code>均是如此。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/c8707051d9fb4a96992fc49751208531.png" alt="img"></p>
</li>
<li><p><code>/order/103</code>在<code>1s</code>之内发送了<code>5</code>次请求但是有<code>5</code>次都成功因为小于其设定的阈值<code>QPS = 10</code>，此后每<code>1s</code>均是如此。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/02a2afd3aa154718963acfa4e5d4fa93.png" alt="img"></p>
</li>
</ul>
<p>上述例子充分说明了<strong>热点参数限流</strong>。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Krolliaa</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/08/15/SpringCloud/">http://example.com/2022/08/15/SpringCloud/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Krolliaa</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%A1%86%E6%9E%B6/">框架</a><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a></div><div class="post_share"><div class="social-share" data-image="/img/index_img/5.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/16/Docker/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/15.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Docker Study</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/12/NetWorkInterview/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/20.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Computer Network Interview</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/08/12/SpringBootStudySimple/" title="SpringBoot Study [简单版]"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/16.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-12</div><div class="title">SpringBoot Study [简单版]</div></div></a></div><div><a href="/2022/08/12/SpringMVC/" title="SpringMVC Study"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/17.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-12</div><div class="title">SpringMVC Study</div></div></a></div><div><a href="/2022/08/11/MyBatisStudy/" title="MyBatis Study"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-11</div><div class="title">MyBatis Study</div></div></a></div><div><a href="/2022/08/12/SpringStudyStudy/" title="Spring Study"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-12</div><div class="title">Spring Study</div></div></a></div><div><a href="/2022/08/12/SpringBootStudyAll/" title="SpringBoot Study [完整版]"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/15.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-12</div><div class="title">SpringBoot Study [完整版]</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/header.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Krolliaa</div><div class="author-info__description">俱往矣，数风流人物，还看今朝！</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/krolliaa"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloud"><span class="toc-text">SpringCloud</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">1. 微服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0"><span class="toc-text">2. 如何学习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98"><span class="toc-text">3. 微服务架构的演变</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94%E5%92%8C%E4%BC%81%E4%B8%9A%E5%B8%B8%E7%94%A8"><span class="toc-text">4. 微服务技术对比和企业常用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%88%9D%E6%AD%A5%E8%AE%A4%E8%AF%86SpringCloud"><span class="toc-text">5. 初步认识SpringCloud</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%92%8C%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-text">6. 服务拆分和远程调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E5%92%8C%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-text">7. 服务提供者和服务消费者</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Eureka%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-text">8. Eureka注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E6%90%AD%E5%BB%BAeureka-server"><span class="toc-text">8.1 搭建eureka-server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E6%90%AD%E5%BB%BAeureka-client"><span class="toc-text">8.2 搭建eureka-client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-Eureka-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-text">8.3. Eureka 服务发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-LoadBalanced%E6%B3%A8%E8%A7%A3%E5%8E%9F%E7%90%86-%E2%80%94-gt-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">8.4. @LoadBalanced注解原理 —&gt; Ribbon负载均衡流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-Eureka%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%8B%89%E5%8F%96%E6%9C%8D%E5%8A%A1%E5%88%97%E8%A1%A8%E7%9A%84Robbin-%E2%80%94-gt-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-text">8.5.Eureka注册中心拉取服务列表的Robbin —&gt;  负载均衡策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-Ribbon%E9%A5%A5%E9%A5%BF%E5%8A%A0%E8%BD%BD"><span class="toc-text">8.6 Ribbon饥饿加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-text">9. Nacos注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%89%E8%A3%85"><span class="toc-text">9.1 Nacos注册中心安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-Nacos%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-text">9.2. Nacos实现注册与发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-Nacos%E5%88%86%E7%BA%A7%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B"><span class="toc-text">9.3 Nacos分级存储模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-Nacos%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4"><span class="toc-text">9.4 Nacos配置集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5-Nacos%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%A7%84%E5%88%99"><span class="toc-text">9.5 Nacos配置负载均衡规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-6-Nacos%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9D%83%E9%87%8D%E9%85%8D%E7%BD%AE%E3%80%90%E6%9C%8D%E5%8A%A1%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E3%80%91"><span class="toc-text">9.6 Nacos配置负载均衡权重配置【服务平滑升级】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-7-Nacos%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BBnamespace"><span class="toc-text">9.7 Nacos环境隔离namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-8-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-text">9.8 Nacos注册中心的细节</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-text">10. 配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-text">10.1 Nacos配置中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-Nacos%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE"><span class="toc-text">10.2 Nacos创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%AF%BB%E5%8F%96Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E9%85%8D%E7%BD%AE"><span class="toc-text">10.3 微服务读取Nacos配置中心配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-text">10.4 Nacos配置中心实现热更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E7%8E%AF%E5%A2%83%E5%85%B1%E4%BA%AB"><span class="toc-text">10.5 Nacos配置中心环境共享</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-%E6%90%AD%E5%BB%BANacos%E9%9B%86%E7%BE%A4"><span class="toc-text">10.6 搭建Nacos集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-text">11. 远程调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-Feign"><span class="toc-text">11.1 Feign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-Feign%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-text">11.2 Feign实现远程调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-Feign%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="toc-text">11.3 Feign自定义配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-4-Feign%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-text">11.4 Feign性能优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-5-Feign%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">11.5 Feign最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-Gateway%E7%BD%91%E5%85%B3"><span class="toc-text">12. Gateway网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-%E7%BD%91%E5%85%B3%E5%8F%AF%E4%BB%A5%E5%B9%B2%E4%BB%80%E4%B9%88"><span class="toc-text">12.1 网关可以干什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-%E7%BD%91%E5%85%B3%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8"><span class="toc-text">12.2 网关初步使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-3-%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="toc-text">12.3 断言工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-4-%E8%BF%87%E6%BB%A4%E5%99%A8%E5%B7%A5%E5%8E%82"><span class="toc-text">12.4 过滤器工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-5-%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">12.5 全局过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-6-%E8%BF%87%E6%BB%A4%E5%99%A8%E9%A1%BA%E5%BA%8F"><span class="toc-text">12.6 过滤器顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-7-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-text">12.7 跨域问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-Docker"><span class="toc-text">13. Docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-MessageQueue"><span class="toc-text">14. MessageQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-1-%E5%90%8C%E6%AD%A5%E9%80%9A%E8%AE%AF%E5%92%8C%E5%BC%82%E6%AD%A5%E9%80%9A%E8%AE%AF"><span class="toc-text">14.1 同步通讯和异步通讯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">14.2 消息队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-3-%E4%BD%BF%E7%94%A8Docker%E5%AE%89%E8%A3%85RabbitMQ"><span class="toc-text">14.3 使用Docker安装RabbitMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-4-RabbitMQ%E4%B8%AD%E7%9A%84%E8%A7%92%E8%89%B2%E5%8F%8A%E5%85%B6%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-text">14.4 RabbitMQ中的角色及其基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-5-RabbitMQ%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AAMQP%E5%8D%8F%E8%AE%AE"><span class="toc-text">14.5 RabbitMQ的底层实现原理：AMQP协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-6-RabbitMQ%E5%AE%98%E6%96%B9%E6%A8%A1%E5%9E%8B%E4%BB%8B%E7%BB%8D"><span class="toc-text">14.6 RabbitMQ官方模型介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-7-RabbitMQ%E5%AE%98%E6%96%B9API%E5%AE%9E%E7%8E%B0HelloWorld%E6%A8%A1%E5%9E%8B"><span class="toc-text">14.7 RabbitMQ官方API实现HelloWorld模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-8-SpringAMQP%E5%AE%9E%E7%8E%B0%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B"><span class="toc-text">14.8 SpringAMQP实现发布订阅模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-1-Hello-World"><span class="toc-text">14.8.1 Hello-World</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-2-Work-Queue"><span class="toc-text">14.8.2 Work-Queue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-3-Fanout"><span class="toc-text">14.8.3 Fanout</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-4-Direct"><span class="toc-text">14.8.4 Direct</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-8-5-Topic"><span class="toc-text">14.8.5 Topic</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-9-%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-text">14.9 消息转换器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-ElasticSearch"><span class="toc-text">15. ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-ElasticSearch%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF-%E2%80%94%E2%80%94-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">15.1 ElasticSearch核心技术 —— 倒排索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-ElasticSearch%E6%96%87%E6%A1%A3%E5%92%8C%E5%AD%97%E6%AE%B5"><span class="toc-text">15.2 ElasticSearch文档和字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-ElasticSearch%E7%B4%A2%E5%BC%95%E5%92%8C%E6%98%A0%E5%B0%84"><span class="toc-text">15.3 ElasticSearch索引和映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-ElasticSearch%E5%92%8CMySQL"><span class="toc-text">15.4 ElasticSearch和MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-5-%E5%AE%89%E8%A3%85ElasticSearch"><span class="toc-text">15.5 安装ElasticSearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-6-%E5%AE%89%E8%A3%85Kibana"><span class="toc-text">15.6 安装Kibana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-7-%E5%AE%89%E8%A3%85ik%E5%88%86%E8%AF%8D%E6%8F%92%E4%BB%B6"><span class="toc-text">15.7 安装ik分词插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-8-%E6%93%8D%E4%BD%9C%E7%B4%A2%E5%BC%95%E5%BA%93%E4%B9%8BMapping"><span class="toc-text">15.8 操作索引库之Mapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-9-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">15.9 增删改查索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-10-ElasticSearch%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-text">15.10 ElasticSearch文档操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-11-%E4%BD%BF%E7%94%A8RestClient%E6%93%8D%E4%BD%9CElasticSearch"><span class="toc-text">15.11 使用RestClient操作ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-11-1-%E5%88%9D%E5%A7%8B%E5%8C%96hotel-demo%E9%A1%B9%E7%9B%AE"><span class="toc-text">15.11.1 初始化hotel-demo项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-11-2-%E5%88%9D%E5%A7%8B%E5%8C%96RestHighLevelClient"><span class="toc-text">15.11.2 初始化RestHighLevelClient</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-11-3-%E4%BD%BF%E7%94%A8RestHighLevelClient%E5%88%9B%E5%BB%BA%E3%80%81%E5%88%A0%E9%99%A4%E3%80%81%E5%88%A4%E6%96%AD%E7%B4%A2%E5%BC%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-text">15.11.3 使用RestHighLevelClient创建、删除、判断索引是否存在</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-11-4-%E4%BD%BF%E7%94%A8RestHighLevelClient%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E6%96%87%E6%A1%A3"><span class="toc-text">15.11.4 使用RestHighLevelClient增删改查文档</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-12-DSL%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2%E3%80%90%E9%87%8D%E7%82%B9%E3%80%91"><span class="toc-text">15.12 DSL文档查询【重点】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-12-1-%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89"><span class="toc-text">15.12.1 查询所有</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-12-2-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-text">15.12.2 全文检索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-12-3-%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2"><span class="toc-text">15.12.3 精确查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-12-4-%E5%9C%B0%E7%90%86%E5%9D%90%E6%A0%87%E6%9F%A5%E8%AF%A2"><span class="toc-text">15.12.4 地理坐标查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-12-5-%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-text">15.12.5 复合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#15-12-5-1-%E7%AE%97%E5%88%86%E5%87%BD%E6%95%B0%E6%9F%A5%E8%AF%A2"><span class="toc-text">15.12.5.1 算分函数查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#15-12-5-2-%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"><span class="toc-text">15.12.5.2 布尔查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-13-%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-text">15.13 搜索结果处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-13-1-%E6%8E%92%E5%BA%8F"><span class="toc-text">15.13.1 排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-13-2-%E5%88%86%E9%A1%B5"><span class="toc-text">15.13.2 分页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-13-3-%E9%AB%98%E4%BA%AE"><span class="toc-text">15.13.3 高亮</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-14-DSL%E6%80%BB%E4%BD%93%E7%BB%93%E6%9E%84%E5%A6%82%E4%B8%8B"><span class="toc-text">15.14 DSL总体结构如下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-15-%E4%BD%BF%E7%94%A8RestHighLevelClient%E8%BF%9B%E8%A1%8C%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2"><span class="toc-text">15.15 使用RestHighLevelClient进行文档查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-16-%E4%BD%BF%E7%94%A8ElasticSearch%E6%9F%A5%E8%AF%A2%E9%85%92%E5%BA%97"><span class="toc-text">15.16 使用ElasticSearch查询酒店</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-16-1-%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2%E5%92%8C%E5%88%86%E9%A1%B5"><span class="toc-text">15.16.1 基本搜索和分页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-16-2-%E8%BF%87%E6%BB%A4"><span class="toc-text">15.16.2 过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#18-16-3-%E6%88%91%E9%99%84%E8%BF%91%E7%9A%84%E9%85%92%E5%BA%97"><span class="toc-text">18.16.3 我附近的酒店</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-16-4-%E6%98%BE%E7%A4%BA%E8%B7%9D%E7%A6%BB"><span class="toc-text">15.16.4 显示距离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-16-5-%E5%B9%BF%E5%91%8A%E7%BD%AE%E9%A1%B6"><span class="toc-text">15.16.5 广告置顶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-17-DSL%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-text">15.17 DSL数据聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-17-1-%E6%A1%B6%E8%81%9A%E5%90%88Bucket-Aggregation"><span class="toc-text">15.17.1 桶聚合Bucket Aggregation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-17-2-%E5%BA%A6%E9%87%8F%E8%81%9A%E5%90%88Metric-Aggregation"><span class="toc-text">15.17.2 度量聚合Metric Aggregation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-17-3-%E4%BD%BF%E7%94%A8RestClient%E6%89%A7%E8%A1%8C%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-text">15.17.3 使用RestClient执行数据聚合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-17-4-%E5%A4%9A%E6%9D%A1%E4%BB%B6%E8%81%9A%E5%90%88"><span class="toc-text">15.17.4 多条件聚合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-17-5-%E5%B8%A6%E8%BF%87%E6%BB%A4%E6%9D%A1%E4%BB%B6%E7%9A%84%E5%A4%9A%E6%9D%A1%E4%BB%B6%E8%81%9A%E5%90%88"><span class="toc-text">15.17.5 带过滤条件的多条件聚合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-18-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-text">15.18 自动补全</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-18-1-%E6%8B%BC%E9%9F%B3%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">15.18.1 拼音分词器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-19-%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-text">15.19 数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-19-1-%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-text">15.19.1 同步调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-19-2-%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-text">15.19.2 异步通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-19-3-%E7%9B%91%E5%90%ACbinlog"><span class="toc-text">15.19.3 监听binlog</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-20-ElasticSearch%E9%9B%86%E7%BE%A4"><span class="toc-text">15.20 ElasticSearch集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-20-1-ElasticSearch%E9%9B%86%E7%BE%A4%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">15.20.1 ElasticSearch集群相关概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-20-2-%E6%90%AD%E5%BB%BAElasticSearch%E9%9B%86%E7%BE%A4"><span class="toc-text">15.20.2 搭建ElasticSearch集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-20-3-ElasticSearch%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7"><span class="toc-text">15.20.3 ElasticSearch集群状态监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-20-4-%E4%BD%BF%E7%94%A8cerebro%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">15.20.4 使用cerebro创建索引库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-20-5-ElaticSearch%E9%9B%86%E7%BE%A4%E8%81%8C%E8%B4%A3%E5%88%92%E5%88%86"><span class="toc-text">15.20.5 ElaticSearch集群职责划分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-20-6-ElasticSearch%E9%9B%86%E7%BE%A4%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="toc-text">15.20.6 ElasticSearch集群脑裂问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-20-7-ElasticSearch%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="toc-text">15.20.7 ElasticSearch集群分布式存储</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-20-8-ElasticSearch%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-text">15.20.8 ElasticSearch集群分布式查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-20-9-ElasticSearch%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-text">15.20.9 ElasticSearch集群故障转移</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4"><span class="toc-text">16. 微服务保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#16-1-%E5%88%9D%E8%AF%86Sentinel"><span class="toc-text">16.1 初识Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#16-1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-text">16.1.1 什么是雪崩问题？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-1-2-%E8%A7%A3%E5%86%B3%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="toc-text">16.1.2 解决雪崩问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94"><span class="toc-text">16.2 微服务保护技术对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-3-Sentinel%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-text">16.3 Sentinel介绍和安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-4-SpringBoot%E6%95%B4%E5%90%88Sentinel"><span class="toc-text">16.4 SpringBoot整合Sentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-5-%E4%BD%BF%E7%94%A8Sentinel%E8%BF%9B%E8%A1%8C%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-text">16.5 使用Sentinel进行流量控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-6-%EF%BC%88%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F%EF%BC%89%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%BC%8F"><span class="toc-text">16.6 （流控模式）流量控制的三种模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#16-6-1-%E7%9B%B4%E8%BF%9E%E6%A8%A1%E5%BC%8F"><span class="toc-text">16.6.1 直连模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-6-2-%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F"><span class="toc-text">16.6.2 关联模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-6-3-%E9%93%BE%E8%B7%AF%E6%A8%A1%E5%BC%8F"><span class="toc-text">16.6.3 链路模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-7-%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="toc-text">16.7 流控效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#16-7-1-%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="toc-text">16.7.1 快速失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-7-2-Warm-Up"><span class="toc-text">16.7.2 Warm Up</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-7-3-%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-text">16.7.3 排队等待</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-8-%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-text">16.8 热点参数限流</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/08/22/JMeter/" title="JMeter"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/15.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JMeter"/></a><div class="content"><a class="title" href="/2022/08/22/JMeter/" title="JMeter">JMeter</a><time datetime="2022-08-22T08:33:02.167Z" title="发表于 2022-08-22 16:33:02">2022-08-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/16/Docker/" title="Docker Study"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/15.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker Study"/></a><div class="content"><a class="title" href="/2022/08/16/Docker/" title="Docker Study">Docker Study</a><time datetime="2022-08-16T11:15:40.288Z" title="发表于 2022-08-16 19:15:40">2022-08-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/15/SpringCloud/" title="SpringCloud Study"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/index_img/5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloud Study"/></a><div class="content"><a class="title" href="/2022/08/15/SpringCloud/" title="SpringCloud Study">SpringCloud Study</a><time datetime="2022-08-15T03:31:17.665Z" title="发表于 2022-08-15 11:31:17">2022-08-15</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/index_img/5.jpg')"><div id="footer-wrap"><div class="copyright">&copy;1984 - 2022 By Krolliaa</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div></div></body></html>